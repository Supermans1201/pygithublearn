From 516f719e82465104de35ff42b9f6b041d92bf392 Mon Sep 17 00:00:00 2001
From: Yongxin Wang <fefe.wyx@gmail.com>
Date: Sat, 11 Apr 2015 12:02:21 +0800
Subject: [PATCH] add commodity section

---
 .gitignore                                         |  4 +++-
 .../gnucash/android/export/xml/GncXmlExporter.java | 27 ++++++++++++++++++----
 .../gnucash/android/importer/GncXmlHandler.java    |  2 ++
 3 files changed, 28 insertions(+), 5 deletions(-)

diff --git a/.gitignore b/.gitignore
index 40af9d3c..f017eb2b 100644
--- a/.gitignore
+++ b/.gitignore
@@ -18,4 +18,6 @@ gen-external-apklibs
 *.iws
 out/
 *.project
-*.classpath
\ No newline at end of file
+*.classpath
+# for CPU profile captures generated by Android Studio
+/captures
diff --git a/app/src/main/java/org/gnucash/android/export/xml/GncXmlExporter.java b/app/src/main/java/org/gnucash/android/export/xml/GncXmlExporter.java
index 6aaf0627..cbb4a7db 100644
--- a/app/src/main/java/org/gnucash/android/export/xml/GncXmlExporter.java
+++ b/app/src/main/java/org/gnucash/android/export/xml/GncXmlExporter.java
@@ -463,6 +463,23 @@ private void serializeDate(XmlSerializer xmlSerializer, String tag, long timeMil
         xmlSerializer.endTag(null, tag);
     }
 
+    private void exportCommodity(XmlSerializer xmlSerializer) throws IOException {
+        List<Currency> currencies = mAccountsDbAdapter.getCurrencies();
+        for (Currency currency : currencies) {
+            if (!currency.getCurrencyCode().equals("XXX")) {
+                xmlSerializer.startTag(null, GncXmlHelper.TAG_COMMODITY);
+                xmlSerializer.attribute(null, GncXmlHelper.ATTR_KEY_VERSION, "2.0.0");
+                xmlSerializer.startTag(null, GncXmlHelper.TAG_COMMODITY_SPACE);
+                xmlSerializer.text("ISO4217");
+                xmlSerializer.endTag(null, GncXmlHelper.TAG_COMMODITY_SPACE);
+                xmlSerializer.startTag(null, GncXmlHelper.TAG_COMMODITY_ID);
+                xmlSerializer.text(currency.getCurrencyCode());
+                xmlSerializer.endTag(null, GncXmlHelper.TAG_COMMODITY_ID);
+                xmlSerializer.endTag(null, GncXmlHelper.TAG_COMMODITY);
+            }
+        }
+    }
+
     @Override
     public void generateExport(Writer writer) throws ExporterException{
         try {
@@ -489,10 +506,10 @@ public void generateExport(Writer writer) throws ExporterException{
             xmlSerializer.text(UUID.randomUUID().toString().replaceAll("-", ""));
             xmlSerializer.endTag(null, GncXmlHelper.TAG_BOOK_ID);
             //commodity count
-            xmlSerializer.startTag(null, GncXmlHelper.TAG_COUNT_DATA);
-            xmlSerializer.attribute(null, GncXmlHelper.ATTR_KEY_CD_TYPE, "commodity");
-            xmlSerializer.text(mAccountsDbAdapter.getCurrencies().size() + "");
-            xmlSerializer.endTag(null, GncXmlHelper.TAG_COUNT_DATA);
+//            xmlSerializer.startTag(null, GncXmlHelper.TAG_COUNT_DATA);
+//            xmlSerializer.attribute(null, GncXmlHelper.ATTR_KEY_CD_TYPE, "commodity");
+//            xmlSerializer.text(mAccountsDbAdapter.getCurrencies().size() + "");
+//            xmlSerializer.endTag(null, GncXmlHelper.TAG_COUNT_DATA);
             //account count
             xmlSerializer.startTag(null, GncXmlHelper.TAG_COUNT_DATA);
             xmlSerializer.attribute(null, GncXmlHelper.ATTR_KEY_CD_TYPE, "account");
@@ -503,6 +520,8 @@ public void generateExport(Writer writer) throws ExporterException{
             xmlSerializer.attribute(null, GncXmlHelper.ATTR_KEY_CD_TYPE, "transaction");
             xmlSerializer.text(mTransactionsDbAdapter.getTotalTransactionsCount() + "");
             xmlSerializer.endTag(null, GncXmlHelper.TAG_COUNT_DATA);
+            // export the commodities used in the DB
+            //dexportCommodity(xmlSerializer);
             // accounts. bulk import does not rely on account order
             // the cursor gather account in arbitrary order
             exportAccounts(xmlSerializer);
diff --git a/app/src/main/java/org/gnucash/android/importer/GncXmlHandler.java b/app/src/main/java/org/gnucash/android/importer/GncXmlHandler.java
index 76a9356d..2802d802 100644
--- a/app/src/main/java/org/gnucash/android/importer/GncXmlHandler.java
+++ b/app/src/main/java/org/gnucash/android/importer/GncXmlHandler.java
@@ -192,10 +192,12 @@ public void startElement(String uri, String localName,
         switch (qualifiedName.toLowerCase()){
             case GncXmlHelper.TAG_ACCOUNT:
                 mAccount = new Account(""); // dummy name, will be replaced when we find name tag
+                mISO4217Currency = false;   // reset commodity class tag
                 break;
             case GncXmlHelper.TAG_TRANSACTION:
                 mTransaction = new Transaction(""); // dummy name will be replaced
                 mTransaction.setExported(true);     // default to exported when import transactions
+                mISO4217Currency = false; // reset commodity class tag
                 break;
             case GncXmlHelper.TAG_TRN_SPLIT:
                 mSplit = new Split(Money.getZeroInstance(),"");
