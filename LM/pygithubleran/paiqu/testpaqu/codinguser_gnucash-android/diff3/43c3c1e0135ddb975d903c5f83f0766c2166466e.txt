From 43c3c1e0135ddb975d903c5f83f0766c2166466e Mon Sep 17 00:00:00 2001
From: Ngewi Fet <ngewif@gmail.com>
Date: Mon, 21 Sep 2015 17:24:02 +0200
Subject: [PATCH] Fix test builds - both unit and android tests

Added shadow classes for UserVoice to Robolectric
Always set the transaction commodity before saving
Refactored method for retrieving commodity GUID to be common to all db adapters
---
 .travis.yml                                        |  6 +++--
 .../android/test/ui/AccountsActivityTest.java      | 10 +++++++++
 .../android/test/ui/PieChartReportTest.java        | 11 ++++-----
 .../android/test/ui/TransactionsActivityTest.java  | 18 ++++++++-------
 .../org/gnucash/android/db/AccountsDbAdapter.java  |  6 +++--
 .../gnucash/android/db/CommoditiesDbAdapter.java   | 22 ------------------
 .../org/gnucash/android/db/DatabaseAdapter.java    | 26 +++++++++++++++++++++-
 .../gnucash/android/db/TransactionsDbAdapter.java  |  2 +-
 .../java/org/gnucash/android/model/Account.java    |  3 +--
 .../org/gnucash/android/model/Transaction.java     |  2 +-
 .../android/receivers/TransactionRecorder.java     |  2 ++
 .../android/ui/report/PieChartFragment.java        |  2 +-
 .../ui/transaction/TransactionFormFragment.java    |  2 +-
 app/src/main/res/values-de/strings.xml             |  1 +
 app/src/main/res/values-el/strings.xml             |  1 +
 app/src/main/res/values-es-rMX/strings.xml         |  1 +
 app/src/main/res/values-es/strings.xml             |  1 +
 app/src/main/res/values-fr/strings.xml             |  1 +
 app/src/main/res/values-hu/strings.xml             |  1 +
 app/src/main/res/values-it/strings.xml             |  1 +
 app/src/main/res/values-nb/strings.xml             |  1 +
 app/src/main/res/values-nl/strings.xml             |  1 +
 app/src/main/res/values-pl/strings.xml             |  1 +
 app/src/main/res/values-pt-rBR/strings.xml         |  1 +
 app/src/main/res/values-pt/strings.xml             |  1 +
 app/src/main/res/values-ru/strings.xml             |  1 +
 app/src/main/res/values-uk/strings.xml             |  1 +
 app/src/main/res/values-zh-rTW/strings.xml         |  1 +
 app/src/main/res/values-zh/strings.xml             |  1 +
 app/src/main/res/values/strings.xml                |  1 +
 .../test/unit/db/AccountsDbAdapterTest.java        |  5 ++---
 .../android/test/unit/db/SplitsDbAdapterTest.java  |  3 ++-
 .../test/unit/db/TransactionsDbAdapterTest.java    |  3 ++-
 .../android/test/unit/util/GnucashTestRunner.java  | 22 ++++++++----------
 .../android/test/unit/util/ShadowUserVoice.java    | 21 +++++++++++++++++
 35 files changed, 119 insertions(+), 64 deletions(-)
 create mode 100644 app/src/test/java/org/gnucash/android/test/unit/util/ShadowUserVoice.java

diff --git a/.travis.yml b/.travis.yml
index b26584f3..beeb12ba 100644
--- a/.travis.yml
+++ b/.travis.yml
@@ -4,10 +4,10 @@ android:
   components:
     - platform-tools
     - tools
-    - build-tools-22.0.1
+    - build-tools-23.0.1
 
     # The SDK version used to compile your project
-    - android-21
+    - android-23
 
     # Additional components
     - extra-android-support
@@ -20,6 +20,8 @@ android:
     # if you need to run emulator(s) during your tests
     - sys-img-armeabi-v7a-android-21
 
+before_install:
+    - android update sdk -u --filter platform-tools,android-23,build-tools-23.0.1 --no-ui --accept-license
 # Emulator Management: Create, Start and Wait
 # Re-enable this when we figure out how to reliably build on Travis
 #before_script:
diff --git a/app/src/androidTest/java/org/gnucash/android/test/ui/AccountsActivityTest.java b/app/src/androidTest/java/org/gnucash/android/test/ui/AccountsActivityTest.java
index ce9c3164..aec5011c 100644
--- a/app/src/androidTest/java/org/gnucash/android/test/ui/AccountsActivityTest.java
+++ b/app/src/androidTest/java/org/gnucash/android/test/ui/AccountsActivityTest.java
@@ -24,6 +24,8 @@
 import android.preference.PreferenceManager;
 import android.support.test.InstrumentationRegistry;
 import android.support.test.espresso.Espresso;
+import android.support.test.espresso.ViewInteraction;
+import android.support.test.espresso.matcher.ViewMatchers;
 import android.support.test.runner.AndroidJUnit4;
 import android.support.v4.app.Fragment;
 import android.test.ActivityInstrumentationTestCase2;
@@ -66,6 +68,7 @@
 import static android.support.test.espresso.matcher.ViewMatchers.isChecked;
 import static android.support.test.espresso.matcher.ViewMatchers.isDisplayed;
 import static android.support.test.espresso.matcher.ViewMatchers.isNotChecked;
+import static android.support.test.espresso.matcher.ViewMatchers.withEffectiveVisibility;
 import static android.support.test.espresso.matcher.ViewMatchers.withId;
 import static android.support.test.espresso.matcher.ViewMatchers.withText;
 import static org.assertj.core.api.Assertions.assertThat;
@@ -234,10 +237,17 @@ public void shouldHideParentAccountViewWhenNoParentsExist(){
         sleep(1000);
         onView(withId(R.id.checkbox_parent_account)).check(matches(allOf(isChecked())));
         onView(withId(R.id.input_account_name)).perform(typeText("Trading account"));
+        Espresso.closeSoftKeyboard();
+        onView(withId(R.id.layout_parent_account)).check(matches(isDisplayed()));
+
         onView(withId(R.id.input_account_type_spinner)).perform(click());
+
         onData(allOf(is(instanceOf(String.class)), is(AccountType.TRADING.name()))).perform(click());
 
+
+        onView(withId(R.id.layout_parent_account)).check(matches(withEffectiveVisibility(ViewMatchers.Visibility.GONE)));
         onView(withId(R.id.layout_parent_account)).check(matches(not(isDisplayed())));
+
         onView(withId(R.id.menu_save)).perform(click());
         sleep(1000);
         //no sub-accounts
diff --git a/app/src/androidTest/java/org/gnucash/android/test/ui/PieChartReportTest.java b/app/src/androidTest/java/org/gnucash/android/test/ui/PieChartReportTest.java
index 2fbadc8d..e6f42ba4 100644
--- a/app/src/androidTest/java/org/gnucash/android/test/ui/PieChartReportTest.java
+++ b/app/src/androidTest/java/org/gnucash/android/test/ui/PieChartReportTest.java
@@ -134,6 +134,7 @@ public void setUp() throws Exception {
     private void getTestActivity() {
         setActivityIntent(new Intent(Intent.ACTION_VIEW));
         mReportsActivity = getActivity();
+        onView(withId(R.id.btn_pie_chart)).perform(click());
     }
 
     private void addTransactionForCurrentMonth() throws Exception {
@@ -205,18 +206,18 @@ public void testSpinner() throws Exception {
 
         getTestActivity();
 
-//        onView(withId(R.id.chart_data_spinner)).perform(click());
-        onView(withText(containsString(AccountType.INCOME.name()))).perform(click());
+        onView(withId(R.id.report_account_type_spinner)).perform(click());
+        onView(withText(AccountType.INCOME.name())).perform(click());
 
         onView(withId(R.id.pie_chart)).perform(click());
         String selectedText = String.format(PieChartFragment.SELECTED_VALUE_PATTERN, GIFTS_RECEIVED_INCOME_ACCOUNT_NAME, TRANSACTION3_AMOUNT, 100f);
         onView(withId(R.id.selected_chart_slice)).check(matches(withText(selectedText)));
 
-//        onView(withId(R.id.chart_data_spinner)).perform(click());
-        onView(withText(containsString(AccountType.EXPENSE.name()))).perform(click());
+        onView(withId(R.id.report_account_type_spinner)).perform(click());
+        onView(withText(AccountType.EXPENSE.name())).perform(click());
 
         onView(withId(R.id.pie_chart)).perform(click());
-        onView(withId(R.id.selected_chart_slice)).check(matches(withText("")));
+        onView(withId(R.id.selected_chart_slice)).check(matches(withText(R.string.label_select_pie_slice_to_see_details)));
     }
 
     public static ViewAction clickXY(final Position horizontal, final Position vertical){
diff --git a/app/src/androidTest/java/org/gnucash/android/test/ui/TransactionsActivityTest.java b/app/src/androidTest/java/org/gnucash/android/test/ui/TransactionsActivityTest.java
index 9749d1df..9722f47a 100644
--- a/app/src/androidTest/java/org/gnucash/android/test/ui/TransactionsActivityTest.java
+++ b/app/src/androidTest/java/org/gnucash/android/test/ui/TransactionsActivityTest.java
@@ -208,7 +208,7 @@ private void sleep(long millis) {
 
 	/**
 	 * Checks that a specific toast message is displayed
-	 * @param toastString
+	 * @param toastString String that should be displayed
 	 */
 	private void assertToastDisplayed(int toastString) {
 		onView(withText(toastString))
@@ -316,6 +316,7 @@ public void testAutoBalanceTransactions(){
 	/**
 	 * Tests input of transaction splits using the split editor.
 	 * Also validates that the imbalance from the split editor will be automatically added as a split
+	 * //FIXME: find a more reliable way to test opening of the split editor
 	 */
 	@Test
 	public void testSplitEditor(){
@@ -337,13 +338,11 @@ public void testSplitEditor(){
 
 		onView(withId(R.id.split_list_layout)).check(matches(allOf(isDisplayed(), hasDescendant(withId(R.id.input_split_amount)))));
 
-		//TODO: enable this assert when we fix the sign of amounts in split editor
-
 		onView(withId(R.id.menu_add_split)).perform(click());
 
 		onView(allOf(withId(R.id.input_split_amount), withText(""))).perform(typeText("400"));
 
-		onView(withId(R.id.btn_save)).perform(click());
+		onView(withId(R.id.menu_save)).perform(click());
 		//after we use split editor, we should not be able to toggle the transaction type
 		onView(withId(R.id.input_transaction_type)).check(matches(not(isDisplayed())));
 
@@ -367,7 +366,7 @@ public void testSplitEditor(){
 		assertThat(imbalanceSplits).hasSize(1);
 
 		Split split = imbalanceSplits.get(0);
-		assertThat(split.getValue().asBigDecimal()).isEqualTo(new BigDecimal("99"));
+		assertThat(split.getValue().asBigDecimal()).isEqualTo(new BigDecimal("99.00"));
 		assertThat(split.getType()).isEqualTo(TransactionType.CREDIT);
 	}
 
@@ -494,6 +493,7 @@ public void testLegacyIntentTransactionRecording(){
 		transactionIntent.putExtra(Transaction.EXTRA_AMOUNT, new BigDecimal(4.99));
 		transactionIntent.putExtra(Transaction.EXTRA_ACCOUNT_UID, DUMMY_ACCOUNT_UID);
 		transactionIntent.putExtra(Transaction.EXTRA_TRANSACTION_TYPE, TransactionType.DEBIT.name());
+		transactionIntent.putExtra(Account.EXTRA_CURRENCY_CODE, "USD");
 
 		new TransactionRecorder().onReceive(mTransactionsActivity, transactionIntent);
 
@@ -524,9 +524,11 @@ public static ViewAction clickSplitIcon(){
 				new CoordinatesProvider() {
 					@Override
 					public float[] calculateCoordinates(View view) {
-						final int DRAWABLE_RIGHT = 2;
-						int x = view.getRight() - ((EditText)view).getCompoundDrawables()[DRAWABLE_RIGHT].getBounds().width();
-						int y = view.getTop() + view.getHeight()/2;
+						int[] xy = new int[2];
+						view.getLocationOnScreen(xy);
+
+						float x = xy[0] + view.getWidth()* 0.9f;
+						float y = xy[1] + view.getHeight() * 0.5f;
 
 						return new float[]{x + 5, y};
 					}
diff --git a/app/src/main/java/org/gnucash/android/db/AccountsDbAdapter.java b/app/src/main/java/org/gnucash/android/db/AccountsDbAdapter.java
index f59ee198..252951e1 100644
--- a/app/src/main/java/org/gnucash/android/db/AccountsDbAdapter.java
+++ b/app/src/main/java/org/gnucash/android/db/AccountsDbAdapter.java
@@ -107,7 +107,9 @@ public void addRecord(@NonNull Account account){
 		if (account.getAccountType() != AccountType.ROOT){
             //update the fully qualified account name
             updateRecord(accountUID, AccountEntry.COLUMN_FULL_NAME, getFullyQualifiedAccountName(accountUID));
-			for (Transaction t : account.getTransactions()) {
+            String commodityUID = getCommodityUID(account.getCurrency().getCurrencyCode());
+            for (Transaction t : account.getTransactions()) {
+                t.setCommodityUID(commodityUID);
 		        mTransactionsAdapter.addRecord(t);
 			}
 		}
@@ -925,7 +927,7 @@ public String getOrCreateGnuCashRootAccountUID() {
         contentValues.put(AccountEntry.COLUMN_HIDDEN, rootAccount.isHidden() ? 1 : 0);
         String defaultCurrencyCode = GnuCashApplication.getDefaultCurrencyCode();
         contentValues.put(AccountEntry.COLUMN_CURRENCY, defaultCurrencyCode);
-        contentValues.put(AccountEntry.COLUMN_COMMODITY_UID, CommoditiesDbAdapter.getInstance().getCommodityUID(defaultCurrencyCode));
+        contentValues.put(AccountEntry.COLUMN_COMMODITY_UID, getCommodityUID(defaultCurrencyCode));
         Log.i(LOG_TAG, "Creating ROOT account");
         mDb.insert(AccountEntry.TABLE_NAME, null, contentValues);
         return rootAccount.getUID();
diff --git a/app/src/main/java/org/gnucash/android/db/CommoditiesDbAdapter.java b/app/src/main/java/org/gnucash/android/db/CommoditiesDbAdapter.java
index 6a384c3a..3a62142e 100644
--- a/app/src/main/java/org/gnucash/android/db/CommoditiesDbAdapter.java
+++ b/app/src/main/java/org/gnucash/android/db/CommoditiesDbAdapter.java
@@ -106,28 +106,6 @@ public Commodity getCommodity(String currencyCode){
         return commodity;
     }
 
-    /**
-     * Returns the commodity GUID for the given ISO 4217 currency code
-     * @param currencyCode ISO 4217 currency code
-     * @return GUID of commodity
-     */
-    public String getCommodityUID(String currencyCode){
-        String where = CommodityEntry.COLUMN_MNEMONIC + "= ?";
-        String[] whereArgs = new String[]{currencyCode};
-
-        Cursor cursor = mDb.query(mTableName, new String[]{CommodityEntry.COLUMN_UID},
-                where, whereArgs, null, null, null);
-        try {
-            if (cursor.moveToNext()) {
-                return cursor.getString(cursor.getColumnIndexOrThrow(CommodityEntry.COLUMN_UID));
-            } else {
-                throw new IllegalArgumentException("Currency code not found in commodities");
-            }
-        } finally {
-            cursor.close();
-        }
-    }
-
     public String getCurrencyCode(@NonNull String guid) {
         Cursor cursor = mDb.query(mTableName, new String[]{CommodityEntry.COLUMN_MNEMONIC},
                 DatabaseSchema.CommonColumns.COLUMN_UID + " = ?", new String[]{guid},
diff --git a/app/src/main/java/org/gnucash/android/db/DatabaseAdapter.java b/app/src/main/java/org/gnucash/android/db/DatabaseAdapter.java
index e24e33c2..286741dc 100644
--- a/app/src/main/java/org/gnucash/android/db/DatabaseAdapter.java
+++ b/app/src/main/java/org/gnucash/android/db/DatabaseAdapter.java
@@ -191,7 +191,7 @@ public boolean isOpen(){
      * @param model Model to be saved to the database
      */
     public void addRecord(@NonNull final Model model){
-        Log.d(LOG_TAG, String.format("Adding %s record to database: ", model.getClass().getName()));
+        Log.d(LOG_TAG, String.format("Adding %s record to database: ", model.getClass().getSimpleName()));
         compileReplaceStatement(model).execute();
     }
 
@@ -454,6 +454,30 @@ public String getAccountCurrencyCode(@NonNull String accountUID) {
         }
     }
 
+
+    /**
+     * Returns the commodity GUID for the given ISO 4217 currency code
+     * @param currencyCode ISO 4217 currency code
+     * @return GUID of commodity
+     */
+    public String getCommodityUID(String currencyCode){
+        String where = DatabaseSchema.CommodityEntry.COLUMN_MNEMONIC + "= ?";
+        String[] whereArgs = new String[]{currencyCode};
+
+        Cursor cursor = mDb.query(DatabaseSchema.CommodityEntry.TABLE_NAME,
+                new String[]{DatabaseSchema.CommodityEntry.COLUMN_UID},
+                where, whereArgs, null, null, null);
+        try {
+            if (cursor.moveToNext()) {
+                return cursor.getString(cursor.getColumnIndexOrThrow(DatabaseSchema.CommodityEntry.COLUMN_UID));
+            } else {
+                throw new IllegalArgumentException("Currency code not found in commodities");
+            }
+        } finally {
+            cursor.close();
+        }
+    }
+
     /**
      * Returns the {@link org.gnucash.android.model.AccountType} of the account with unique ID <code>uid</code>
      * @param accountUID Unique ID of the account
diff --git a/app/src/main/java/org/gnucash/android/db/TransactionsDbAdapter.java b/app/src/main/java/org/gnucash/android/db/TransactionsDbAdapter.java
index 9c85a205..4fa53152 100644
--- a/app/src/main/java/org/gnucash/android/db/TransactionsDbAdapter.java
+++ b/app/src/main/java/org/gnucash/android/db/TransactionsDbAdapter.java
@@ -182,7 +182,7 @@ protected SQLiteStatement compileReplaceStatement(@NonNull final Transaction tra
 
         String commodityUID = transaction.getCommodityUID();
         if (commodityUID == null)
-            commodityUID = CommoditiesDbAdapter.getInstance().getCommodityUID(transaction.getCurrency().getCurrencyCode());
+            commodityUID = getCommodityUID(transaction.getCurrency().getCurrencyCode());
 
         mReplaceStatement.bindString(7, commodityUID);
         mReplaceStatement.bindString(8, transaction.getCreatedTimestamp().toString());
diff --git a/app/src/main/java/org/gnucash/android/model/Account.java b/app/src/main/java/org/gnucash/android/model/Account.java
index 453e3dba..42ca5279 100644
--- a/app/src/main/java/org/gnucash/android/model/Account.java
+++ b/app/src/main/java/org/gnucash/android/model/Account.java
@@ -21,7 +21,6 @@
 
 import org.gnucash.android.BuildConfig;
 import org.gnucash.android.app.GnuCashApplication;
-import org.gnucash.android.db.CommoditiesDbAdapter;
 import org.gnucash.android.export.Exporter;
 import org.gnucash.android.export.ofx.OfxHelper;
 import org.w3c.dom.Document;
@@ -160,7 +159,7 @@
 	public Account(String name) {
 		setName(name);
         this.mFullName  = mName;
-		this.mCurrency  = Currency.getInstance(GnuCashApplication.getDefaultCurrencyCode());
+		this.mCurrency  = Currency.getInstance(Money.DEFAULT_CURRENCY_CODE);
 	}
 	
 	/**
diff --git a/app/src/main/java/org/gnucash/android/model/Transaction.java b/app/src/main/java/org/gnucash/android/model/Transaction.java
index be1913e0..f6fc9bea 100644
--- a/app/src/main/java/org/gnucash/android/model/Transaction.java
+++ b/app/src/main/java/org/gnucash/android/model/Transaction.java
@@ -168,7 +168,7 @@ public Transaction(Transaction transaction, boolean generateNewUID){
 	 * Initializes the different fields to their default values.
 	 */
 	private void initDefaults(){
-        mCurrencyCode = GnuCashApplication.getDefaultCurrencyCode();
+        mCurrencyCode = Money.DEFAULT_CURRENCY_CODE;
 		this.mTimestamp = System.currentTimeMillis();
 	}
 
diff --git a/app/src/main/java/org/gnucash/android/receivers/TransactionRecorder.java b/app/src/main/java/org/gnucash/android/receivers/TransactionRecorder.java
index 0fe6b5ea..3e192af0 100644
--- a/app/src/main/java/org/gnucash/android/receivers/TransactionRecorder.java
+++ b/app/src/main/java/org/gnucash/android/receivers/TransactionRecorder.java
@@ -36,6 +36,7 @@
 import java.io.IOException;
 import java.io.StringReader;
 import java.math.BigDecimal;
+import java.math.MathContext;
 import java.util.Currency;
 
 /**
@@ -72,6 +73,7 @@ public void onReceive(Context context, Intent intent) {
         if (accountUID != null) {
             TransactionType type = TransactionType.valueOf(args.getString(Transaction.EXTRA_TRANSACTION_TYPE));
             BigDecimal amountBigDecimal = (BigDecimal) args.getSerializable(Transaction.EXTRA_AMOUNT);
+            amountBigDecimal = amountBigDecimal.setScale(Currency.getInstance(currencyCode).getDefaultFractionDigits(), BigDecimal.ROUND_HALF_EVEN).round(MathContext.DECIMAL128);
             Money amount = new Money(amountBigDecimal, Currency.getInstance(currencyCode));
             Split split = new Split(amount.absolute(), accountUID);
             split.setType(type);
diff --git a/app/src/main/java/org/gnucash/android/ui/report/PieChartFragment.java b/app/src/main/java/org/gnucash/android/ui/report/PieChartFragment.java
index 68fb669f..bcf97098 100644
--- a/app/src/main/java/org/gnucash/android/ui/report/PieChartFragment.java
+++ b/app/src/main/java/org/gnucash/android/ui/report/PieChartFragment.java
@@ -160,7 +160,7 @@ public void onResume() {
      * Manages all actions about displaying the pie chart
      */
     private void displayChart() {
-        mSelectedValueTextView.setText("Select a slice to see details");
+        mSelectedValueTextView.setText(R.string.label_select_pie_slice_to_see_details);
         mChart.highlightValues(null);
         mChart.clear();
 
diff --git a/app/src/main/java/org/gnucash/android/ui/transaction/TransactionFormFragment.java b/app/src/main/java/org/gnucash/android/ui/transaction/TransactionFormFragment.java
index 0e1b1434..d40ef231 100644
--- a/app/src/main/java/org/gnucash/android/ui/transaction/TransactionFormFragment.java
+++ b/app/src/main/java/org/gnucash/android/ui/transaction/TransactionFormFragment.java
@@ -811,7 +811,7 @@ private void saveNewTransaction() {
 
             String currencyCode = mAccountsDbAdapter.getAccountCurrencyCode(mAccountUID);
             mTransaction.setCurrencyCode(currencyCode);
-            mTransaction.setCommodityUID(CommoditiesDbAdapter.getInstance().getCommodityUID(currencyCode));
+            mTransaction.setCommodityUID(mAccountsDbAdapter.getCommodityUID(currencyCode));
             mTransaction.setTime(cal.getTimeInMillis());
             mTransaction.setNote(notes);
 
diff --git a/app/src/main/res/values-de/strings.xml b/app/src/main/res/values-de/strings.xml
index c4697b65..39979904 100644
--- a/app/src/main/res/values-de/strings.xml
+++ b/app/src/main/res/values-de/strings.xml
@@ -530,6 +530,7 @@ No user-identifiable information will be collected as part of this process!</str
 	<string name="error_converted_amount_required">The converted amount is required</string>
 	<string name="title_transfer_funds">Transfer Funds</string>
 	<string name="nav_menu_help"><![CDATA[Help & Feedback]]></string>
+	<string name="label_select_pie_slice_to_see_details">Select a slice to see details</string>
 	<string-array name="report_time_range">
 		<item>All time</item>
 		<item>Current month</item>
diff --git a/app/src/main/res/values-el/strings.xml b/app/src/main/res/values-el/strings.xml
index e991b114..b6e8d5fa 100644
--- a/app/src/main/res/values-el/strings.xml
+++ b/app/src/main/res/values-el/strings.xml
@@ -545,6 +545,7 @@ No user-identifiable information will be collected as part of this process!
 	<string name="error_converted_amount_required">The converted amount is required</string>
 	<string name="title_transfer_funds">Transfer Funds</string>
 	<string name="nav_menu_help"><![CDATA[Help & Feedback]]></string>
+	<string name="label_select_pie_slice_to_see_details">Select a slice to see details</string>
 	<string-array name="report_time_range">
 		<item>All time</item>
 		<item>Current month</item>
diff --git a/app/src/main/res/values-es-rMX/strings.xml b/app/src/main/res/values-es-rMX/strings.xml
index 3294c294..599f0d0f 100644
--- a/app/src/main/res/values-es-rMX/strings.xml
+++ b/app/src/main/res/values-es-rMX/strings.xml
@@ -534,6 +534,7 @@ No user-identifiable information will be collected as part of this process!
     <string name="error_converted_amount_required">The converted amount is required</string>
     <string name="title_transfer_funds">Transfer Funds</string>
     <string name="nav_menu_help"><![CDATA[Help & Feedback]]></string>
+    <string name="label_select_pie_slice_to_see_details">Select a slice to see details</string>
     <string-array name="report_time_range">
         <item>All time</item>
         <item>Current month</item>
diff --git a/app/src/main/res/values-es/strings.xml b/app/src/main/res/values-es/strings.xml
index 3fd9b418..09652187 100644
--- a/app/src/main/res/values-es/strings.xml
+++ b/app/src/main/res/values-es/strings.xml
@@ -531,6 +531,7 @@ Este proceso solo recoge informaci&#243;n que no permite identificar al usuario<
 	<string name="error_converted_amount_required">The converted amount is required</string>
 	<string name="title_transfer_funds">Transfer Funds</string>
 	<string name="nav_menu_help"><![CDATA[Help & Feedback]]></string>
+	<string name="label_select_pie_slice_to_see_details">Select a slice to see details</string>
 	<string-array name="report_time_range">
 		<item>All time</item>
 		<item>Current month</item>
diff --git a/app/src/main/res/values-fr/strings.xml b/app/src/main/res/values-fr/strings.xml
index 5e3eb032..6233080c 100644
--- a/app/src/main/res/values-fr/strings.xml
+++ b/app/src/main/res/values-fr/strings.xml
@@ -531,6 +531,7 @@ Aucune information permettant d\'identifier l\'utilisateur ne sera recueillis da
     <string name="error_converted_amount_required">The converted amount is required</string>
     <string name="title_transfer_funds">Transfer Funds</string>
     <string name="nav_menu_help"><![CDATA[Help & Feedback]]></string>
+    <string name="label_select_pie_slice_to_see_details">Select a slice to see details</string>
     <string-array name="report_time_range">
         <item>All time</item>
         <item>Current month</item>
diff --git a/app/src/main/res/values-hu/strings.xml b/app/src/main/res/values-hu/strings.xml
index 06527d52..7c07d142 100644
--- a/app/src/main/res/values-hu/strings.xml
+++ b/app/src/main/res/values-hu/strings.xml
@@ -535,6 +535,7 @@ No user-identifiable information will be collected as part of this process!
     <string name="error_converted_amount_required">The converted amount is required</string>
     <string name="title_transfer_funds">Transfer Funds</string>
     <string name="nav_menu_help"><![CDATA[Help & Feedback]]></string>
+    <string name="label_select_pie_slice_to_see_details">Select a slice to see details</string>
     <string-array name="report_time_range">
         <item>All time</item>
         <item>Current month</item>
diff --git a/app/src/main/res/values-it/strings.xml b/app/src/main/res/values-it/strings.xml
index 3aa53ba4..5abe8ac2 100644
--- a/app/src/main/res/values-it/strings.xml
+++ b/app/src/main/res/values-it/strings.xml
@@ -535,6 +535,7 @@ No user-identifiable information will be collected as part of this process!
     <string name="error_converted_amount_required">The converted amount is required</string>
     <string name="title_transfer_funds">Transfer Funds</string>
     <string name="nav_menu_help"><![CDATA[Help & Feedback]]></string>
+    <string name="label_select_pie_slice_to_see_details">Select a slice to see details</string>
     <string-array name="report_time_range">
         <item>All time</item>
         <item>Current month</item>
diff --git a/app/src/main/res/values-nb/strings.xml b/app/src/main/res/values-nb/strings.xml
index 0d2c9c82..3a7e1763 100644
--- a/app/src/main/res/values-nb/strings.xml
+++ b/app/src/main/res/values-nb/strings.xml
@@ -532,6 +532,7 @@ Ingen brukerinformasjon vil bli delt i denne prosessen!
 	<string name="error_converted_amount_required">The converted amount is required</string>
 	<string name="title_transfer_funds">Transfer Funds</string>
 	<string name="nav_menu_help"><![CDATA[Help & Feedback]]></string>
+	<string name="label_select_pie_slice_to_see_details">Select a slice to see details</string>
 	<string-array name="report_time_range">
 		<item>All time</item>
 		<item>Current month</item>
diff --git a/app/src/main/res/values-nl/strings.xml b/app/src/main/res/values-nl/strings.xml
index 5ee3af1e..8afb2e84 100644
--- a/app/src/main/res/values-nl/strings.xml
+++ b/app/src/main/res/values-nl/strings.xml
@@ -536,6 +536,7 @@ No user-identifiable information will be collected as part of this process!
     <string name="error_converted_amount_required">The converted amount is required</string>
     <string name="title_transfer_funds">Transfer Funds</string>
     <string name="nav_menu_help"><![CDATA[Help & Feedback]]></string>
+    <string name="label_select_pie_slice_to_see_details">Select a slice to see details</string>
     <string-array name="report_time_range">
         <item>All time</item>
         <item>Current month</item>
diff --git a/app/src/main/res/values-pl/strings.xml b/app/src/main/res/values-pl/strings.xml
index ff0f24ff..1a009f0a 100644
--- a/app/src/main/res/values-pl/strings.xml
+++ b/app/src/main/res/values-pl/strings.xml
@@ -531,6 +531,7 @@
     <string name="error_converted_amount_required">The converted amount is required</string>
     <string name="title_transfer_funds">Transfer Funds</string>
     <string name="nav_menu_help"><![CDATA[Help & Feedback]]></string>
+    <string name="label_select_pie_slice_to_see_details">Select a slice to see details</string>
     <string-array name="report_time_range">
         <item>All time</item>
         <item>Current month</item>
diff --git a/app/src/main/res/values-pt-rBR/strings.xml b/app/src/main/res/values-pt-rBR/strings.xml
index e35e8763..73400771 100644
--- a/app/src/main/res/values-pt-rBR/strings.xml
+++ b/app/src/main/res/values-pt-rBR/strings.xml
@@ -534,6 +534,7 @@ Nenhuma informao de  identificao do usurio ser coletada neste proces
 	<string name="error_converted_amount_required">The converted amount is required</string>
 	<string name="title_transfer_funds">Transfer Funds</string>
 	<string name="nav_menu_help"><![CDATA[Help & Feedback]]></string>
+	<string name="label_select_pie_slice_to_see_details">Select a slice to see details</string>
 	<string-array name="report_time_range">
 		<item>All time</item>
 		<item>Current month</item>
diff --git a/app/src/main/res/values-pt/strings.xml b/app/src/main/res/values-pt/strings.xml
index b85d963f..c96a2c72 100644
--- a/app/src/main/res/values-pt/strings.xml
+++ b/app/src/main/res/values-pt/strings.xml
@@ -501,4 +501,5 @@ Neste processo n&#227;o ser&#227;o recolhidas informa&#231;&#245;es do utilizado
     <string name="label_no_scheduled_exports_to_display">N&#227;o existem exporta&#231;&#245;es agendadas para mostrar</string>
     <string name="title_create_export_schedule">Criar uma exporta&#231;&#227;o agendada</string>
     <string name="toast_exported_to">Exportado para : %1$s</string>
+    <string name="label_select_pie_slice_to_see_details">Select a slice to see details</string>
 </resources>
diff --git a/app/src/main/res/values-ru/strings.xml b/app/src/main/res/values-ru/strings.xml
index 6b2d5b85..3e63a84e 100644
--- a/app/src/main/res/values-ru/strings.xml
+++ b/app/src/main/res/values-ru/strings.xml
@@ -538,6 +538,7 @@
     <string name="error_converted_amount_required">The converted amount is required</string>
     <string name="title_transfer_funds">Transfer Funds</string>
     <string name="nav_menu_help"><![CDATA[Help & Feedback]]></string>
+    <string name="label_select_pie_slice_to_see_details">Select a slice to see details</string>
     <string-array name="report_time_range">
         <item>All time</item>
         <item>Current month</item>
diff --git a/app/src/main/res/values-uk/strings.xml b/app/src/main/res/values-uk/strings.xml
index 0667bdb4..b84fb50b 100644
--- a/app/src/main/res/values-uk/strings.xml
+++ b/app/src/main/res/values-uk/strings.xml
@@ -518,6 +518,7 @@
     <string name="error_converted_amount_required">The converted amount is required</string>
     <string name="title_transfer_funds">Transfer Funds</string>
     <string name="nav_menu_help"><![CDATA[Help & Feedback]]></string>
+    <string name="label_select_pie_slice_to_see_details">Select a slice to see details</string>
     <string-array name="report_time_range">
         <item>All time</item>
         <item>Current month</item>
diff --git a/app/src/main/res/values-zh-rTW/strings.xml b/app/src/main/res/values-zh-rTW/strings.xml
index f6f4f927..8af6231e 100644
--- a/app/src/main/res/values-zh-rTW/strings.xml
+++ b/app/src/main/res/values-zh-rTW/strings.xml
@@ -532,6 +532,7 @@ No user-identifiable information will be collected as part of this process!
     <string name="error_converted_amount_required">The converted amount is required</string>
     <string name="title_transfer_funds">Transfer Funds</string>
     <string name="nav_menu_help"><![CDATA[Help & Feedback]]></string>
+    <string name="label_select_pie_slice_to_see_details">Select a slice to see details</string>
     <string-array name="report_time_range">
         <item>All time</item>
         <item>Current month</item>
diff --git a/app/src/main/res/values-zh/strings.xml b/app/src/main/res/values-zh/strings.xml
index bfc732e0..4ec521c8 100644
--- a/app/src/main/res/values-zh/strings.xml
+++ b/app/src/main/res/values-zh/strings.xml
@@ -533,6 +533,7 @@ No user-identifiable information will be collected as part of this process!
     <string name="error_converted_amount_required">The converted amount is required</string>
     <string name="title_transfer_funds">Transfer Funds</string>
     <string name="nav_menu_help"><![CDATA[Help & Feedback]]></string>
+    <string name="label_select_pie_slice_to_see_details">Select a slice to see details</string>
     <string-array name="report_time_range">
         <item>All time</item>
         <item>Current month</item>
diff --git a/app/src/main/res/values/strings.xml b/app/src/main/res/values/strings.xml
index 7f4c9335..554a59c9 100644
--- a/app/src/main/res/values/strings.xml
+++ b/app/src/main/res/values/strings.xml
@@ -537,6 +537,7 @@
     <string name="error_converted_amount_required">The converted amount is required</string>
     <string name="title_transfer_funds">Transfer Funds</string>
     <string name="nav_menu_help"><![CDATA[Help & Feedback]]></string>
+    <string name="label_select_pie_slice_to_see_details">Select a slice to see details</string>
     <string-array name="report_time_range">
         <item>All time</item>
         <item>Current month</item>
diff --git a/app/src/test/java/org/gnucash/android/test/unit/db/AccountsDbAdapterTest.java b/app/src/test/java/org/gnucash/android/test/unit/db/AccountsDbAdapterTest.java
index 57a5537b..5baf5fb4 100644
--- a/app/src/test/java/org/gnucash/android/test/unit/db/AccountsDbAdapterTest.java
+++ b/app/src/test/java/org/gnucash/android/test/unit/db/AccountsDbAdapterTest.java
@@ -1,7 +1,5 @@
 package org.gnucash.android.test.unit.db;
 
-import android.os.Build;
-
 import org.assertj.core.data.Index;
 import org.gnucash.android.BuildConfig;
 import org.gnucash.android.R;
@@ -20,6 +18,7 @@
 import org.gnucash.android.model.TransactionType;
 import org.gnucash.android.test.unit.util.GnucashTestRunner;
 import org.gnucash.android.test.unit.util.ShadowCrashlytics;
+import org.gnucash.android.test.unit.util.ShadowUserVoice;
 import org.junit.After;
 import org.junit.Before;
 import org.junit.Test;
@@ -39,7 +38,7 @@
 import static org.junit.Assert.assertEquals;
 
 @RunWith(GnucashTestRunner.class) //package is required so that resources can be found in dev mode
-@Config(constants = BuildConfig.class, sdk = 21, packageName = "org.gnucash.android", shadows = {ShadowCrashlytics.class})
+@Config(constants = BuildConfig.class, sdk = 21, packageName = "org.gnucash.android", shadows = {ShadowCrashlytics.class, ShadowUserVoice.class})
 public class AccountsDbAdapterTest{
 
 	private static final String BRAVO_ACCOUNT_NAME = "Bravo";
diff --git a/app/src/test/java/org/gnucash/android/test/unit/db/SplitsDbAdapterTest.java b/app/src/test/java/org/gnucash/android/test/unit/db/SplitsDbAdapterTest.java
index 8c7939ce..1685ee24 100644
--- a/app/src/test/java/org/gnucash/android/test/unit/db/SplitsDbAdapterTest.java
+++ b/app/src/test/java/org/gnucash/android/test/unit/db/SplitsDbAdapterTest.java
@@ -13,6 +13,7 @@
 import org.gnucash.android.model.Transaction;
 import org.gnucash.android.test.unit.util.GnucashTestRunner;
 import org.gnucash.android.test.unit.util.ShadowCrashlytics;
+import org.gnucash.android.test.unit.util.ShadowUserVoice;
 import org.junit.After;
 import org.junit.Before;
 import org.junit.Test;
@@ -27,7 +28,7 @@
  * Some tests for the splits database adapter
  */
 @RunWith(GnucashTestRunner.class) //package is required so that resources can be found in dev mode
-@Config(constants = BuildConfig.class, sdk = 21, packageName = "org.gnucash.android", shadows = {ShadowCrashlytics.class})
+@Config(constants = BuildConfig.class, sdk = 21, packageName = "org.gnucash.android", shadows = {ShadowCrashlytics.class, ShadowUserVoice.class})
 public class SplitsDbAdapterTest {
 
     private AccountsDbAdapter mAccountsDbAdapter;
diff --git a/app/src/test/java/org/gnucash/android/test/unit/db/TransactionsDbAdapterTest.java b/app/src/test/java/org/gnucash/android/test/unit/db/TransactionsDbAdapterTest.java
index 7b3999b7..de8fefc6 100644
--- a/app/src/test/java/org/gnucash/android/test/unit/db/TransactionsDbAdapterTest.java
+++ b/app/src/test/java/org/gnucash/android/test/unit/db/TransactionsDbAdapterTest.java
@@ -11,6 +11,7 @@
 import org.gnucash.android.model.Transaction;
 import org.gnucash.android.test.unit.util.GnucashTestRunner;
 import org.gnucash.android.test.unit.util.ShadowCrashlytics;
+import org.gnucash.android.test.unit.util.ShadowUserVoice;
 import org.junit.After;
 import org.junit.Before;
 import org.junit.Test;
@@ -25,7 +26,7 @@
 
 
 @RunWith(GnucashTestRunner.class) //package is required so that resources can be found in dev mode
-@Config(constants = BuildConfig.class, sdk = 21, packageName = "org.gnucash.android", shadows = {ShadowCrashlytics.class})
+@Config(constants = BuildConfig.class, sdk = 21, packageName = "org.gnucash.android", shadows = {ShadowCrashlytics.class, ShadowUserVoice.class})
 public class TransactionsDbAdapterTest {
 	private static final String ALPHA_ACCOUNT_NAME  = "Alpha";
 	private static final String BRAVO_ACCOUNT_NAME  = "Bravo";
diff --git a/app/src/test/java/org/gnucash/android/test/unit/util/GnucashTestRunner.java b/app/src/test/java/org/gnucash/android/test/unit/util/GnucashTestRunner.java
index 964b0623..48c75462 100644
--- a/app/src/test/java/org/gnucash/android/test/unit/util/GnucashTestRunner.java
+++ b/app/src/test/java/org/gnucash/android/test/unit/util/GnucashTestRunner.java
@@ -1,10 +1,11 @@
 package org.gnucash.android.test.unit.util;
 
+import com.crashlytics.android.Crashlytics;
+import com.uservoice.uservoicesdk.UserVoice;
+
 import org.junit.runners.model.InitializationError;
 import org.robolectric.RobolectricGradleTestRunner;
-import org.robolectric.internal.SdkConfig;
-import org.robolectric.internal.bytecode.ClassHandler;
-import org.robolectric.internal.bytecode.ShadowMap;
+import org.robolectric.internal.bytecode.InstrumentationConfiguration;
 
 /**
  * Test runner for application
@@ -16,16 +17,11 @@ public GnucashTestRunner(Class<?> klass) throws InitializationError {
     }
 
     @Override
-    protected ShadowMap createShadowMap() {
-        return super.createShadowMap()
-                .newBuilder().addShadowClass(ShadowCrashlytics.class).build();
-    }
+    public InstrumentationConfiguration createClassLoaderConfig() {
+        InstrumentationConfiguration.Builder builder = InstrumentationConfiguration.newBuilder()
+                .addInstrumentedClass(Crashlytics.class.getName())
+                .addInstrumentedClass(UserVoice.class.getName());
 
-    @Override
-    protected ClassHandler createClassHandler(ShadowMap shadowMap, SdkConfig sdkConfig) {
-        ShadowMap map = shadowMap.newBuilder().addShadowClass(ShadowCrashlytics.class).build();
-        return super.createClassHandler(map, sdkConfig);
+        return builder.build();
     }
-
-
 }
diff --git a/app/src/test/java/org/gnucash/android/test/unit/util/ShadowUserVoice.java b/app/src/test/java/org/gnucash/android/test/unit/util/ShadowUserVoice.java
new file mode 100644
index 00000000..31f3f476
--- /dev/null
+++ b/app/src/test/java/org/gnucash/android/test/unit/util/ShadowUserVoice.java
@@ -0,0 +1,21 @@
+package org.gnucash.android.test.unit.util;
+
+import android.content.Context;
+
+import com.uservoice.uservoicesdk.Config;
+import com.uservoice.uservoicesdk.UserVoice;
+
+import org.robolectric.annotation.Implementation;
+import org.robolectric.annotation.Implements;
+
+/**
+ * Shadow class for uservoice during testing
+ */
+@Implements(UserVoice.class)
+public class ShadowUserVoice {
+
+    @Implementation
+    public static void init(Config config, Context context){
+        //do nothing
+    }
+}
