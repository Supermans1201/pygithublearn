From 932e349571b49b285923e6cac1ae14da265d340b Mon Sep 17 00:00:00 2001
From: Ngewi Fet <ngewif@gmail.com>
Date: Fri, 18 Sep 2015 17:04:50 +0200
Subject: [PATCH] Use the custom calculator keyboard for the split editor

Fix negative sign shown for positive amounts in split editor
Create new custom EditText which uses the calculator
Remove imbalance from split editor layout / use menu option for adding split
Mark "exported" column in transaction table as deprecated
Code cleanup and refactoring
---
 .../gnucash/android/app/GnuCashApplication.java    |   2 -
 .../org/gnucash/android/db/DatabaseSchema.java     |   6 +
 .../ui/transaction/SplitEditorFragment.java        |  97 ++-----
 .../ui/transaction/TransactionFormFragment.java    | 147 +++-------
 .../android/ui/util/CalculatorEditText.java        | 322 +++++++++++++++++++++
 .../android/ui/util/CalculatorKeyboard.java        | 143 ++-------
 .../android/ui/util/TransactionTypeSwitch.java     |  11 +-
 app/src/main/res/layout/dialog_transfer_funds.xml  | 260 +++++++++--------
 app/src/main/res/layout/fragment_split_editor.xml  |  79 ++---
 .../main/res/layout/fragment_transaction_form.xml  |   9 +-
 app/src/main/res/layout/item_split_entry.xml       |  13 +-
 app/src/main/res/menu/split_editor_actions.xml     |  27 ++
 app/src/main/res/values-de/strings.xml             |   1 +
 app/src/main/res/values-el/strings.xml             |   1 +
 app/src/main/res/values-es-rMX/strings.xml         |   1 +
 app/src/main/res/values-es/strings.xml             |   1 +
 app/src/main/res/values-fr/strings.xml             |   1 +
 app/src/main/res/values-hu/strings.xml             |   1 +
 app/src/main/res/values-it/strings.xml             |   1 +
 app/src/main/res/values-nb/strings.xml             |   1 +
 app/src/main/res/values-nl/strings.xml             |   1 +
 app/src/main/res/values-pl/strings.xml             |   1 +
 app/src/main/res/values-pt-rBR/strings.xml         |   1 +
 app/src/main/res/values-ru/strings.xml             |   1 +
 app/src/main/res/values-uk/strings.xml             |   1 +
 app/src/main/res/values-zh-rTW/strings.xml         |   1 +
 app/src/main/res/values-zh/strings.xml             |   1 +
 app/src/main/res/values/arrays.xml                 |  15 +
 app/src/main/res/values/attrs.xml                  |  22 ++
 app/src/main/res/values/strings.xml                |   1 +
 30 files changed, 696 insertions(+), 473 deletions(-)
 create mode 100644 app/src/main/java/org/gnucash/android/ui/util/CalculatorEditText.java
 create mode 100644 app/src/main/res/menu/split_editor_actions.xml
 create mode 100644 app/src/main/res/values/attrs.xml

diff --git a/app/src/main/java/org/gnucash/android/app/GnuCashApplication.java b/app/src/main/java/org/gnucash/android/app/GnuCashApplication.java
index d98a0b64..850babde 100644
--- a/app/src/main/java/org/gnucash/android/app/GnuCashApplication.java
+++ b/app/src/main/java/org/gnucash/android/app/GnuCashApplication.java
@@ -24,14 +24,12 @@
 import android.database.SQLException;
 import android.database.sqlite.SQLiteDatabase;
 import android.graphics.Color;
-import android.os.Build;
 import android.preference.PreferenceManager;
 import android.util.Log;
 
 import com.crashlytics.android.Crashlytics;
 import com.crashlytics.android.core.CrashlyticsCore;
 
-import org.gnucash.android.BuildConfig;
 import org.gnucash.android.R;
 import org.gnucash.android.db.AccountsDbAdapter;
 import org.gnucash.android.db.CommoditiesDbAdapter;
diff --git a/app/src/main/java/org/gnucash/android/db/DatabaseSchema.java b/app/src/main/java/org/gnucash/android/db/DatabaseSchema.java
index 88b9928c..de4b3e72 100644
--- a/app/src/main/java/org/gnucash/android/db/DatabaseSchema.java
+++ b/app/src/main/java/org/gnucash/android/db/DatabaseSchema.java
@@ -80,6 +80,12 @@ private DatabaseSchema(){}
         public static final String COLUMN_CURRENCY              = "currency_code";
         public static final String COLUMN_COMMODITY_UID         = "commodity_uid";
         public static final String COLUMN_TIMESTAMP             = "timestamp";
+
+        /**
+         * Flag for marking transactions which have been exported
+         * @deprecated Transactions are exported based on last modified timestamp
+         */
+        @Deprecated
         public static final String COLUMN_EXPORTED              = "is_exported";
         public static final String COLUMN_TEMPLATE              = "is_template";
         public static final String COLUMN_SCHEDX_ACTION_UID     = "scheduled_action_uid";
diff --git a/app/src/main/java/org/gnucash/android/ui/transaction/SplitEditorFragment.java b/app/src/main/java/org/gnucash/android/ui/transaction/SplitEditorFragment.java
index 37401935..21a0a410 100644
--- a/app/src/main/java/org/gnucash/android/ui/transaction/SplitEditorFragment.java
+++ b/app/src/main/java/org/gnucash/android/ui/transaction/SplitEditorFragment.java
@@ -18,6 +18,7 @@
 import android.app.Activity;
 import android.content.Intent;
 import android.database.Cursor;
+import android.inputmethodservice.KeyboardView;
 import android.os.Bundle;
 import android.support.v4.app.Fragment;
 import android.support.v4.widget.SimpleCursorAdapter;
@@ -50,7 +51,8 @@
 import org.gnucash.android.ui.FormActivity;
 import org.gnucash.android.ui.UxArgument;
 import org.gnucash.android.ui.transaction.dialog.TransferFundsDialogFragment;
-import org.gnucash.android.ui.util.AmountInputFormatter;
+import org.gnucash.android.ui.util.CalculatorEditText;
+import org.gnucash.android.ui.util.CalculatorKeyboard;
 import org.gnucash.android.ui.util.OnTransferFundsListener;
 import org.gnucash.android.ui.util.TransactionTypeSwitch;
 import org.gnucash.android.util.QualifiedAccountNameCursorAdapter;
@@ -71,9 +73,8 @@
  */
 public class SplitEditorFragment extends Fragment {
 
-    @Bind(R.id.split_list_layout) LinearLayout mSplitsLinearLayout;
-    @Bind(R.id.imbalance_textview) TextView mImbalanceTextView;
-    @Bind(R.id.btn_add_split) Button mAddSplit;
+    @Bind(R.id.split_list_layout)   LinearLayout mSplitsLinearLayout;
+    @Bind(R.id.calculator_keyboard) KeyboardView mKeyboardView;
 
     private AccountsDbAdapter mAccountsDbAdapter;
     private Cursor mCursor;
@@ -81,11 +82,11 @@
     private List<View> mSplitItemViewList;
     private String mAccountUID;
 
-    private BalanceTextWatcher mBalanceUpdater = new BalanceTextWatcher();
     private BigDecimal mBaseAmount = BigDecimal.ZERO;
 
     private ArrayList<String> mRemovedSplitUIDs = new ArrayList<>();
 
+    CalculatorKeyboard mCalculatorKeyboard;
     /**
      * Create and return a new instance of the fragment with the appropriate paramenters
      * @param args Arguments to be set to the fragment. <br>
@@ -102,13 +103,6 @@ public static SplitEditorFragment newInstance(Bundle args){
     public View onCreateView(LayoutInflater inflater, ViewGroup container, Bundle savedInstanceState) {
         View view = inflater.inflate(R.layout.fragment_split_editor, container, false);
         ButterKnife.bind(this, view);
-
-        mAddSplit.setOnClickListener(new View.OnClickListener() {
-            @Override
-            public void onClick(View view) {
-                addSplitView(null);
-            }
-        });
         return view;
     }
 
@@ -118,9 +112,10 @@ public void onActivityCreated(Bundle savedInstanceState) {
 
         ActionBar actionBar = ((AppCompatActivity)getActivity()).getSupportActionBar();
         assert actionBar != null;
-        actionBar.setTitle(R.string.title_transaction_splits);
+        actionBar.setTitle(R.string.title_split_editor);
         setHasOptionsMenu(true);
 
+        mCalculatorKeyboard = new CalculatorKeyboard(getActivity(), mKeyboardView, R.xml.calculator_keyboard);
         mSplitItemViewList = new ArrayList<>();
 
         //we are editing splits for a new transaction.
@@ -147,8 +142,6 @@ public void onActivityCreated(Bundle savedInstanceState) {
             view.findViewById(R.id.input_accounts_spinner).setEnabled(false);
             view.findViewById(R.id.btn_remove_split).setVisibility(View.GONE);
         }
-
-        updateTotal();
     }
 
     private void loadSplitViews(List<Split> splitList) {
@@ -159,7 +152,7 @@ private void loadSplitViews(List<Split> splitList) {
 
     @Override
     public void onCreateOptionsMenu(Menu menu, MenuInflater inflater) {
-        inflater.inflate(R.menu.default_save_actions, menu);
+        inflater.inflate(R.menu.split_editor_actions, menu);
     }
 
     @Override
@@ -175,6 +168,10 @@ public boolean onOptionsItemSelected(MenuItem item) {
                 saveSplits();
                 return true;
 
+            case R.id.menu_add_split:
+                addSplitView(null);
+                return true;
+
             default:
                 return super.onOptionsItemSelected(item);
         }
@@ -217,7 +214,7 @@ private void initArgs() {
      */
     class SplitViewHolder implements OnTransferFundsListener{
         @Bind(R.id.input_split_memo)        EditText splitMemoEditText;
-        @Bind(R.id.input_split_amount)      EditText splitAmountEditText;
+        @Bind(R.id.input_split_amount)      CalculatorEditText splitAmountEditText;
         @Bind(R.id.btn_remove_split)        ImageView removeSplitButton;
         @Bind(R.id.input_accounts_spinner)  Spinner accountsSpinner;
         @Bind(R.id.split_currency_symbol)   TextView splitCurrencyTextView;
@@ -226,7 +223,6 @@ private void initArgs() {
 
         View splitView;
         Money quantity;
-        AmountInputFormatter amountInputFormatter;
 
         public SplitViewHolder(View splitView, Split split){
             ButterKnife.bind(this, splitView);
@@ -242,8 +238,7 @@ public void transferComplete(Money amount) {
         }
 
         private void setListeners(Split split){
-            amountInputFormatter = new AmountInputFormatter(splitAmountEditText);
-            splitAmountEditText.addTextChangedListener(amountInputFormatter);
+            splitAmountEditText.bindListeners(mCalculatorKeyboard);
 
             removeSplitButton.setOnClickListener(new View.OnClickListener() {
                 @Override
@@ -251,7 +246,6 @@ public void onClick(View view) {
                     mRemovedSplitUIDs.add(splitUidTextView.getText().toString());
                     mSplitsLinearLayout.removeView(splitView);
                     mSplitItemViewList.remove(splitView);
-                    updateTotal();
                 }
             });
 
@@ -264,6 +258,7 @@ public void onClick(View view) {
             splitUidTextView.setText(UUID.randomUUID().toString());
 
             if (split != null) {
+                splitAmountEditText.setCurrency(split.getValue().getCurrency());
                 splitAmountEditText.setText(split.getFormattedValue().toPlainString());
                 splitCurrencyTextView.setText(split.getValue().getCurrency().getSymbol());
                 splitMemoEditText.setText(split.getMemo());
@@ -276,14 +271,6 @@ public void onClick(View view) {
 
             accountsSpinner.setOnItemSelectedListener(new SplitAccountListener(splitTypeButton, this));
 
-            //put these balance update triggers last last so as to avoid computing while still loading
-            splitAmountEditText.addTextChangedListener(mBalanceUpdater);
-            splitTypeButton.setOnClickListener(new View.OnClickListener() {
-                @Override
-                public void onClick(View view) {
-                    updateTotal();
-                }
-            });
         }
     }
 
@@ -330,10 +317,11 @@ private void saveSplits() {
         List<Split> splitList = new ArrayList<>();
         for (View splitView : mSplitItemViewList) {
             SplitViewHolder viewHolder = (SplitViewHolder) splitView.getTag();
-            if (viewHolder.splitAmountEditText.getText().toString().isEmpty())
+            if (viewHolder.splitAmountEditText.getText().length() == 0)
                 continue;
 
-            BigDecimal amountBigDecimal = TransactionFormFragment.parseInputToDecimal(viewHolder.splitAmountEditText.getText().toString());
+            BigDecimal amountBigDecimal = viewHolder.splitAmountEditText.getValue();
+
             String currencyCode = mAccountsDbAdapter.getCurrencyCode(mAccountUID);
             Money valueAmount = new Money(amountBigDecimal, Currency.getInstance(currencyCode));
 
@@ -350,45 +338,6 @@ private void saveSplits() {
     }
 
     /**
-     * Updates the displayed total for the transaction.
-     * Computes the total of the splits, the unassigned balance and the split sum
-     */
-    private void updateTotal(){
-        List<Split> splitList   = extractSplitsFromView();
-        String currencyCode     = mAccountsDbAdapter.getCurrencyCode(mAccountUID);
-        Money splitSum          = Money.createZeroInstance(currencyCode);
-        for (Split split : splitList) {
-            Money amount = split.getValue().absolute();
-            if (split.getType() == TransactionType.DEBIT)
-                splitSum = splitSum.subtract(amount);
-            else
-                splitSum = splitSum.add(amount);
-        }
-        TransactionsActivity.displayBalance(mImbalanceTextView, splitSum);
-    }
-
-    /**
-     * Updates the displayed balance of the accounts when the amount of a split is changed
-     */
-    private class BalanceTextWatcher implements TextWatcher {
-
-        @Override
-        public void beforeTextChanged(CharSequence charSequence, int i, int i2, int i3) {
-
-        }
-
-        @Override
-        public void onTextChanged(CharSequence charSequence, int i, int i2, int i3) {
-
-        }
-
-        @Override
-        public void afterTextChanged(Editable editable) {
-            updateTotal();
-        }
-    }
-
-    /**
      * Listens to changes in the transfer account and updates the currency symbol, the label of the
      * transaction type and if neccessary
      */
@@ -420,13 +369,11 @@ public void onItemSelected(AdapterView<?> parentView, View selectedItemView, int
                 return;
             }
 
-            String stringAmount = mSplitViewHolder.splitAmountEditText.getText().toString();
-            if (stringAmount.isEmpty())
+            BigDecimal amountBigD = mSplitViewHolder.splitAmountEditText.getValue();
+            if (amountBigD == null)
                 return;
 
-            Money amount = new Money(
-                    TransactionFormFragment.parseInputToDecimal(stringAmount),
-                    Currency.getInstance(fromCurrencyCode));
+            Money amount = new Money(amountBigD, Currency.getInstance(fromCurrencyCode));
             TransferFundsDialogFragment fragment
                     = TransferFundsDialogFragment.getInstance(amount, targetCurrencyCode, mSplitViewHolder);
             fragment.show(getFragmentManager(), "tranfer_funds_editor");
diff --git a/app/src/main/java/org/gnucash/android/ui/transaction/TransactionFormFragment.java b/app/src/main/java/org/gnucash/android/ui/transaction/TransactionFormFragment.java
index a48b4b12..26446bdd 100644
--- a/app/src/main/java/org/gnucash/android/ui/transaction/TransactionFormFragment.java
+++ b/app/src/main/java/org/gnucash/android/ui/transaction/TransactionFormFragment.java
@@ -22,6 +22,7 @@
 import android.content.SharedPreferences;
 import android.content.res.Configuration;
 import android.database.Cursor;
+import android.inputmethodservice.KeyboardView;
 import android.os.Bundle;
 import android.preference.PreferenceManager;
 import android.support.v4.app.Fragment;
@@ -30,7 +31,6 @@
 import android.support.v4.widget.SimpleCursorAdapter;
 import android.support.v7.app.ActionBar;
 import android.support.v7.app.AppCompatActivity;
-import android.text.Editable;
 import android.text.format.DateUtils;
 import android.text.format.Time;
 import android.util.Log;
@@ -71,8 +71,7 @@
 import org.gnucash.android.ui.FormActivity;
 import org.gnucash.android.ui.UxArgument;
 import org.gnucash.android.ui.transaction.dialog.TransferFundsDialogFragment;
-import org.gnucash.android.ui.util.AmountInputFormatter;
-import org.gnucash.android.ui.util.CalculatorKeyboard;
+import org.gnucash.android.ui.util.CalculatorEditText;
 import org.gnucash.android.ui.util.OnTransferFundsListener;
 import org.gnucash.android.ui.util.RecurrenceParser;
 import org.gnucash.android.ui.util.TransactionTypeSwitch;
@@ -91,6 +90,9 @@
 import java.util.List;
 import java.util.Locale;
 
+import butterknife.Bind;
+import butterknife.ButterKnife;
+
 /**
  * Fragment for creating or editing transactions
  * @author Ngewi Fet <ngewif@gmail.com>
@@ -140,58 +142,50 @@
 	/**
 	 * Button for setting the transaction type, either credit or debit
 	 */
-	private TransactionTypeSwitch mTransactionTypeButton;
+	@Bind(R.id.input_transaction_type) TransactionTypeSwitch mTransactionTypeSwitch;
 
 	/**
 	 * Input field for the transaction name (description)
 	 */
-	private AutoCompleteTextView mDescriptionEditText;
+	@Bind(R.id.input_transaction_name) AutoCompleteTextView mDescriptionEditText;
 
 	/**
 	 * Input field for the transaction amount
 	 */
-	private EditText mAmountEditText;
+	@Bind(R.id.input_transaction_amount) CalculatorEditText mAmountEditText;
 
 	/**
 	 * Field for the transaction currency.
 	 * The transaction uses the currency of the account
 	 */
-	private TextView mCurrencyTextView;
+	@Bind(R.id.currency_symbol) TextView mCurrencyTextView;
 
 	/**
 	 * Input field for the transaction description (note)
 	 */
-	private EditText mNotesEditText;
+	@Bind(R.id.input_description) EditText mNotesEditText;
 
 	/**
 	 * Input field for the transaction date
 	 */
-	private TextView mDateTextView;
+	@Bind(R.id.input_date) TextView mDateTextView;
 
 	/**
 	 * Input field for the transaction time
 	 */
-	private TextView mTimeTextView;
-
-	/**
-	 * {@link Calendar} for holding the set date
-	 */
-	private Calendar mDate;
-
-	/**
-	 * {@link Calendar} object holding the set time
-	 */
-	private Calendar mTime;
+	@Bind(R.id.input_time) TextView mTimeTextView;
 
 	/**
 	 * Spinner for selecting the transfer account
 	 */
-	private Spinner mTransferAccountSpinner;
+	@Bind(R.id.input_transfer_account_spinner) Spinner mTransferAccountSpinner;
 
     /**
      * Checkbox indicating if this transaction should be saved as a template or not
      */
-    private CheckBox mSaveTemplateCheckbox;
+    @Bind(R.id.checkbox_save_template) CheckBox mSaveTemplateCheckbox;
+
+    @Bind(R.id.input_recurrence) TextView mRecurrenceTextView;
 
     /**
      * Flag to note if double entry accounting is in use or not
@@ -199,18 +193,25 @@
 	private boolean mUseDoubleEntry;
 
     /**
+     * {@link Calendar} for holding the set date
+     */
+    private Calendar mDate;
+
+    /**
+     * {@link Calendar} object holding the set time
+     */
+    private Calendar mTime;
+
+    /**
      * The AccountType of the account to which this transaction belongs.
      * Used for determining the accounting rules for credits and debits
      */
     AccountType mAccountType;
 
-    TextView mRecurrenceTextView;
 
     private String mRecurrenceRule;
     private EventRecurrence mEventRecurrence = new EventRecurrence();
 
-    private AmountInputFormatter mAmountInputFormatter;
-
     private String mAccountUID;
 
     private List<Split> mSplitsList = new ArrayList<>();
@@ -218,11 +219,6 @@
     private boolean mEditMode = false;
 
     /**
-     * Custom calculator keyboard
-     */
-    private CalculatorKeyboard mCalculatorKeyboard;
-
-    /**
      * Split quantity which will be set from the funds transfer dialog
      */
     private Money mSplitQuantity;
@@ -234,18 +230,8 @@
     public View onCreateView(LayoutInflater inflater, ViewGroup container,
 			Bundle savedInstanceState) {
 		View v = inflater.inflate(R.layout.fragment_transaction_form, container, false);
-
-		mDescriptionEditText = (AutoCompleteTextView) v.findViewById(R.id.input_transaction_name);
-		mNotesEditText = (EditText) v.findViewById(R.id.input_description);
-		mDateTextView           = (TextView) v.findViewById(R.id.input_date);
-		mTimeTextView           = (TextView) v.findViewById(R.id.input_time);
-		mAmountEditText         = (EditText) v.findViewById(R.id.input_transaction_amount);
-		mCurrencyTextView       = (TextView) v.findViewById(R.id.currency_symbol);
-		mTransactionTypeButton  = (TransactionTypeSwitch) v.findViewById(R.id.input_transaction_type);
-		mTransferAccountSpinner = (Spinner) v.findViewById(R.id.input_transfer_account_spinner);
-        mRecurrenceTextView     = (TextView) v.findViewById(R.id.input_recurrence);
-        mSaveTemplateCheckbox = (CheckBox) v.findViewById(R.id.checkbox_save_template);
-
+        ButterKnife.bind(this, v);
+        mAmountEditText.bindListeners((KeyboardView) v.findViewById(R.id.calculator_keyboard));
         return v;
 	}
 
@@ -258,11 +244,11 @@ private void startTransferFunds() {
         String targetCurrency = mAccountsDbAdapter.getCurrencyCode((mAccountsDbAdapter.getUID(id)));
 
         if (fromCurrency.equals(Currency.getInstance(targetCurrency))
-                || !mAmountInputFormatter.isInputModified()
+                || !mAmountEditText.isInputModified()
                 || mSplitQuantity != null) //if both accounts have same currency
             return;
 
-        BigDecimal amountBigd = parseInputToDecimal(mAmountEditText.getText().toString());
+        BigDecimal amountBigd = mAmountEditText.getValue();
         if (mSplitQuantity != null || amountBigd.equals(BigDecimal.ZERO))
             return;
         Money amount 	= new Money(amountBigd, fromCurrency).absolute();
@@ -275,7 +261,6 @@ private void startTransferFunds() {
     @Override
     public void onConfigurationChanged(Configuration newConfig) {
         super.onConfigurationChanged(newConfig);
-        initCalculatorKeyboard();
     }
 
     @Override
@@ -347,22 +332,9 @@ public void onNothingSelected(AdapterView<?> adapterView) {
 			initializeViewsWithTransaction();
             mEditMode = true;
 		}
-
-        initCalculatorKeyboard();
 	}
 
     /**
-     * Initializes the calculator keyboard
-     */
-    private void initCalculatorKeyboard() {
-        mCalculatorKeyboard = new CalculatorKeyboard(getActivity(), R.id.calculator_keyboard, R.xml.calculator_keyboard);
-        mCalculatorKeyboard.setCurrency(Currency.getInstance(mAccountsDbAdapter.getCurrencyCode(mAccountUID)));
-        mCalculatorKeyboard.registerEditText(R.id.input_transaction_amount);
-        // FIXME: decouple from FormActivity
-        ((FormActivity) getActivity()).setOnBackListener(mCalculatorKeyboard);
-    }
-
-    /**
      * Extension of SimpleCursorAdapter which is used to populate the fields for the list items
      * in the transactions suggestions (auto-complete transaction description).
      */
@@ -418,7 +390,7 @@ public void onItemClick(AdapterView<?> adapterView, View view, int position, lon
                 mTransaction = new Transaction(mTransactionsDbAdapter.getRecord(id), true);
                 mTransaction.setTime(System.currentTimeMillis());
                 //we check here because next method will modify it and we want to catch user-modification
-                boolean amountEntered = mAmountInputFormatter.isInputModified();
+                boolean amountEntered = mAmountEditText.isInputModified();
                 initializeViewsWithTransaction();
                 List<Split> splitList = mTransaction.getSplits();
                 boolean isSplitPair = splitList.size() == 2 && splitList.get(0).isPairOf(splitList.get(1));
@@ -451,10 +423,10 @@ private void initializeViewsWithTransaction(){
 		mDescriptionEditText.setText(mTransaction.getDescription());
         mDescriptionEditText.setSelection(mDescriptionEditText.getText().length());
 
-        mTransactionTypeButton.setAccountType(mAccountType);
-        mTransactionTypeButton.setChecked(mTransaction.getBalance(mAccountUID).isNegative());
+        mTransactionTypeSwitch.setAccountType(mAccountType);
+        mTransactionTypeSwitch.setChecked(mTransaction.getBalance(mAccountUID).isNegative());
 
-		if (!mAmountInputFormatter.isInputModified()){
+		if (!mAmountEditText.isInputModified()){
             //when autocompleting, only change the amount if the user has not manually changed it already
             mAmountEditText.setText(mTransaction.getBalance(mAccountUID).toPlainString());
         }
@@ -510,7 +482,7 @@ private void initializeViewsWithTransaction(){
 
     private void setAmountEditViewVisible(int visibility) {
         getView().findViewById(R.id.layout_double_entry).setVisibility(visibility);
-        mTransactionTypeButton.setVisibility(visibility);
+        mTransactionTypeSwitch.setVisibility(visibility);
     }
 
     private void toggleAmountInputEntryMode(boolean enabled){
@@ -537,9 +509,9 @@ private void initalizeViews() {
 		mTimeTextView.setText(TIME_FORMATTER.format(time));
 		mTime = mDate = Calendar.getInstance();
 
-        mTransactionTypeButton.setAccountType(mAccountType);
+        mTransactionTypeSwitch.setAccountType(mAccountType);
 		String typePref = PreferenceManager.getDefaultSharedPreferences(getActivity()).getString(getString(R.string.key_default_transaction_type), "DEBIT");
-        mTransactionTypeButton.setChecked(TransactionType.valueOf(typePref));
+        mTransactionTypeSwitch.setChecked(TransactionType.valueOf(typePref));
 
 		String code = Money.DEFAULT_CURRENCY_CODE;
 		if (mAccountUID != null){
@@ -594,7 +566,7 @@ private void openSplitEditor(){
         String baseAmountString;
 
         if (mTransaction == null){ //if we are creating a new transaction (not editing an existing one)
-            BigDecimal enteredAmount = parseInputToDecimal(mAmountEditText.getText().toString());
+            BigDecimal enteredAmount = mAmountEditText.getValue();
             baseAmountString = enteredAmount.toPlainString();
         } else {
             Money biggestAmount = Money.createZeroInstance(mTransaction.getCurrencyCode());
@@ -623,8 +595,6 @@ private void openSplitEditor(){
 	 * Sets click listeners for the dialog buttons
 	 */
 	private void setListeners() {
-        mAmountInputFormatter = new AmountTextWatcher(mAmountEditText);
-        //mAmountEditText.addTextChangedListener(mAmountInputFormatter);
         mAmountEditText.setOnTouchListener(new View.OnTouchListener() {
             @Override
             public boolean onTouch(View v, MotionEvent event) {
@@ -637,8 +607,8 @@ public boolean onTouch(View v, MotionEvent event) {
                     if (event.getRawX() >= (mAmountEditText.getRight() - mAmountEditText.getCompoundDrawables()[DRAWABLE_RIGHT].getBounds().width())) {
                         openSplitEditor();
                         return true;
-                    } else if (!mCalculatorKeyboard.isCustomKeyboardVisible()) {
-                        mCalculatorKeyboard.showCustomKeyboard(v);
+                    } else if (!mAmountEditText.getCalculatorKeyboard().isCustomKeyboardVisible()) {
+                        mAmountEditText.getCalculatorKeyboard().showCustomKeyboard(v);
                     }
                 }
 
@@ -647,7 +617,7 @@ public boolean onTouch(View v, MotionEvent event) {
             }
         });
 
-		mTransactionTypeButton.setAmountFormattingListener(mAmountEditText, mCurrencyTextView);
+		mTransactionTypeSwitch.setAmountFormattingListener(mAmountEditText, mCurrencyTextView);
 
 		mDateTextView.setOnClickListener(new View.OnClickListener() {
 
@@ -746,6 +716,7 @@ public void run() {
 	 * and save a transaction
 	 */
 	private void saveNewTransaction() {
+        mAmountEditText.getCalculatorKeyboard().hideCustomKeyboard();
 		Calendar cal = new GregorianCalendar(
 				mDate.get(Calendar.YEAR),
 				mDate.get(Calendar.MONTH),
@@ -755,7 +726,7 @@ private void saveNewTransaction() {
 				mTime.get(Calendar.SECOND));
 		String description = mDescriptionEditText.getText().toString();
 		String notes = mNotesEditText.getText().toString();
-		BigDecimal amountBigd = new BigDecimal(mAmountEditText.getText().toString().replaceAll(",", ".").trim());
+		BigDecimal amountBigd = mAmountEditText.getValue();
 
 		Currency currency = Currency.getInstance(mTransactionsDbAdapter.getAccountCurrencyCode(mAccountUID));
 		Money amount 	= new Money(amountBigd, currency).absolute();
@@ -776,10 +747,10 @@ private void saveNewTransaction() {
             //if it is a simple transfer where the editor was not used, then respect the button
             for (Split split : mSplitsList) {
                 if (split.getAccountUID().equals(mAccountUID)){
-                    split.setType(mTransactionTypeButton.getTransactionType());
+                    split.setType(mTransactionTypeSwitch.getTransactionType());
                     split.setValue(amount);
                 } else {
-                    split.setType(mTransactionTypeButton.getTransactionType().invert());
+                    split.setType(mTransactionTypeSwitch.getTransactionType().invert());
                     if (mSplitQuantity != null)
                         split.setQuantity(mSplitQuantity);
                     split.setValue(amount);
@@ -810,7 +781,7 @@ private void saveNewTransaction() {
                 //****************** amount entered in the simple interface (not using splits Editor) ************************
                 if (mSplitsList.isEmpty()) {
                     Split split = new Split(amount, mAccountUID);
-                    split.setType(mTransactionTypeButton.getTransactionType());
+                    split.setType(mTransactionTypeSwitch.getTransactionType());
                     mTransaction.addSplit(split);
 
                     String transferAcctUID;
@@ -959,8 +930,7 @@ public boolean onOptionsItemSelected(MenuItem item) {
      * @return {@code true} if the transaction can be saved, {@code false} otherwise
      */
     private boolean canSave(){
-        mCalculatorKeyboard.evaluateEditTextExpression(mAmountEditText);
-        return (mAmountEditText.getText().length() > 0 && mAmountEditText.getError() == null)
+        return (mAmountEditText.isInputValid())
                 || (mUseDoubleEntry && mTransferAccountSpinner.getCount() == 0);
     }
 
@@ -973,7 +943,7 @@ public void setSplitList(List<Split> splitList, List<String> removedSplitUIDs){
         Money balance = Transaction.computeBalance(mAccountUID, mSplitsList);
 
         mAmountEditText.setText(balance.toPlainString());
-        mTransactionTypeButton.setChecked(balance.isNegative());
+        mTransactionTypeSwitch.setChecked(balance.isNegative());
         //once we set the split list, do not allow direct editing of the total
         if (mSplitsList.size() > 1){
             toggleAmountInputEntryMode(false);
@@ -1087,25 +1057,4 @@ public void onActivityResult(int requestCode, int resultCode, Intent data) {
             setSplitList(splitList, removedSplits);
         }
     }
-
-    /**
-     * Formats the amount and adds a negative sign if the amount will decrease the account balance
-     */
-    public class AmountTextWatcher extends AmountInputFormatter {
-
-        public AmountTextWatcher(EditText amountInput) {
-            super(amountInput);
-        }
-
-        @Override
-        public void afterTextChanged(Editable s) {
-            String value = s.toString();
-            if (value.length() > 0 && mTransactionTypeButton.isChecked()){
-                if (s.charAt(0) != '-'){
-                    s = Editable.Factory.getInstance().newEditable("-" + value);
-                }
-            }
-            super.afterTextChanged(s);
-        }
-    }
 }
diff --git a/app/src/main/java/org/gnucash/android/ui/util/CalculatorEditText.java b/app/src/main/java/org/gnucash/android/ui/util/CalculatorEditText.java
new file mode 100644
index 00000000..16955a6c
--- /dev/null
+++ b/app/src/main/java/org/gnucash/android/ui/util/CalculatorEditText.java
@@ -0,0 +1,322 @@
+/*
+ * Copyright (c) 2014 Ngewi Fet <ngewif@gmail.com>
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *     http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+package org.gnucash.android.ui.util;
+
+import android.app.Activity;
+import android.content.Context;
+import android.content.res.TypedArray;
+import android.inputmethodservice.KeyboardView;
+import android.support.annotation.XmlRes;
+import android.text.Editable;
+import android.text.InputType;
+import android.text.TextWatcher;
+import android.util.AttributeSet;
+import android.util.Log;
+import android.view.MotionEvent;
+import android.view.View;
+import android.view.inputmethod.InputMethodManager;
+import android.widget.EditText;
+
+import com.crashlytics.android.Crashlytics;
+
+import net.objecthunter.exp4j.Expression;
+import net.objecthunter.exp4j.ExpressionBuilder;
+
+import org.gnucash.android.R;
+import org.gnucash.android.app.GnuCashApplication;
+import org.gnucash.android.ui.FormActivity;
+
+import java.math.BigDecimal;
+import java.text.DecimalFormat;
+import java.text.NumberFormat;
+import java.util.Currency;
+import java.util.Locale;
+
+/**
+ * A custom EditText which supports computations and uses a custom calculator keyboard.
+ * <p>Afer the view is inflated, make sure to call {@link #bindListeners(KeyboardView)}
+ * with the view from your layout where the calculator keyboard should be displayed:</p>
+ * @author Ngewi Fet <ngewif@gmail.com>
+ */
+public class CalculatorEditText extends EditText {
+    CalculatorKeyboard mCalculatorKeyboard;
+    private Currency mCurrency = Currency.getInstance(GnuCashApplication.getDefaultCurrencyCode());
+    private Context mContext;
+
+    /**
+     * Flag which is set if the contents of this view have been modified
+     */
+    private boolean isContentModified = false;
+
+    private int mCalculatorKeysLayout;
+    private KeyboardView mCalculatorKeyboardView;
+
+    public CalculatorEditText(Context context) {
+        super(context);
+        this.mContext = context;
+    }
+
+    public CalculatorEditText(Context context, AttributeSet attrs) {
+        super(context, attrs);
+        init(context, attrs);
+    }
+
+    public CalculatorEditText(Context context, AttributeSet attrs, int defStyleAttr) {
+        super(context, attrs, defStyleAttr);
+        init(context, attrs);
+    }
+
+    /**
+     * Overloaded constructor
+     * Reads any attributes which are specified in XML and applies them
+     * @param context Activity context
+     * @param attrs View attributes
+     */
+    private void init(Context context, AttributeSet attrs){
+        this.mContext = context;
+        TypedArray a = context.getTheme().obtainStyledAttributes(
+                attrs,
+                R.styleable.CalculatorEditText,
+                0, 0);
+
+        try {
+            mCalculatorKeysLayout = a.getResourceId(R.styleable.CalculatorEditText_keyboardKeysLayout, R.xml.calculator_keyboard);
+        } finally {
+            a.recycle();
+        }
+
+        addTextChangedListener(new TextWatcher() {
+            @Override
+            public void beforeTextChanged(CharSequence s, int start, int count, int after) {
+
+            }
+
+            @Override
+            public void onTextChanged(CharSequence s, int start, int before, int count) {
+
+            }
+
+            @Override
+            public void afterTextChanged(Editable s) {
+                isContentModified = true;
+            }
+        });
+    }
+
+    public void bindListeners(CalculatorKeyboard calculatorKeyboard){
+        mCalculatorKeyboard = calculatorKeyboard;
+        mContext = calculatorKeyboard.getContext();
+        setOnFocusChangeListener(new OnFocusChangeListener() {
+            // NOTE By setting the on focus listener, we can show the custom keyboard when the edit box gets focus, but also hide it when the edit box loses focus
+            @Override
+            public void onFocusChange(View v, boolean hasFocus) {
+                if (hasFocus)
+                    mCalculatorKeyboard.showCustomKeyboard(v);
+                else {
+                    mCalculatorKeyboard.hideCustomKeyboard();
+                    evaluate();
+                }
+            }
+        });
+
+        setOnClickListener(new OnClickListener() {
+            // NOTE By setting the on click listener we can show the custom keyboard again,
+            // by tapping on an edit box that already had focus (but that had the keyboard hidden).
+            @Override
+            public void onClick(View v) {
+                mCalculatorKeyboard.showCustomKeyboard(v);
+            }
+        });
+
+        // Disable spell check (hex strings look like words to Android)
+        setInputType(getInputType() | InputType.TYPE_TEXT_FLAG_NO_SUGGESTIONS);
+
+        // FIXME: for some reason, this prevents the text selection from working
+        setOnLongClickListener(new View.OnLongClickListener() {
+            @Override
+            public boolean onLongClick(View v) {
+                if (v != null)
+                    ((InputMethodManager) GnuCashApplication.getAppContext()
+                            .getSystemService(Activity.INPUT_METHOD_SERVICE))
+                            .hideSoftInputFromWindow(v.getWindowToken(), 0);
+
+                return false;
+            }
+        });
+
+        setOnTouchListener(new OnTouchListener() {
+            @Override
+            public boolean onTouch(View v, MotionEvent event) {
+                if (!mCalculatorKeyboard.isCustomKeyboardVisible())
+                    mCalculatorKeyboard.showCustomKeyboard(v);
+
+
+                // XXX: Use dispatchTouchEvent()?
+                onTouchEvent(event);               // Call native handler
+                return false;
+            }
+        });
+
+        ((FormActivity)mContext).setOnBackListener(mCalculatorKeyboard);
+    }
+    /**
+     * Initializes listeners on the edittext
+     */
+    public void bindListeners(KeyboardView keyboardView){
+        bindListeners(new CalculatorKeyboard(mContext, keyboardView, mCalculatorKeysLayout));
+    }
+
+    /**
+     * Returns the calculator keyboard instantiated by this edittext
+     * @return CalculatorKeyboard
+     */
+    public CalculatorKeyboard getCalculatorKeyboard(){
+        return mCalculatorKeyboard;
+    }
+
+    /**
+     * Returns the view Id of the keyboard view
+     * @return Keyboard view
+     */
+    public KeyboardView getCalculatorKeyboardView() {
+        return mCalculatorKeyboardView;
+    }
+
+    /**
+     * Set the keyboard view used for displaying the keyboard
+     * @param calculatorKeyboardView Calculator keyboard view
+     */
+    public void setCalculatorKeyboardView(KeyboardView calculatorKeyboardView) {
+        this.mCalculatorKeyboardView = calculatorKeyboardView;
+        bindListeners(calculatorKeyboardView);
+    }
+
+    /**
+     * Returns the XML resource ID describing the calculator keys layout
+     * @return XML resource ID
+     */
+    public int getCalculatorKeysLayout() {
+        return mCalculatorKeysLayout;
+    }
+
+    /**
+     * Sets the XML resource describing the layout of the calculator keys
+     * @param mCalculatorKeysLayout XML resource ID
+     */
+    public void setCalculatorKeysLayout(@XmlRes int mCalculatorKeysLayout) {
+        this.mCalculatorKeysLayout = mCalculatorKeysLayout;
+        bindListeners(mCalculatorKeyboardView);
+    }
+
+    /**
+     * Sets the calculator keyboard to use for this EditText
+     * @param keyboard Properly intialized calculator keyobard
+     */
+    public void setCalculatorKeyboard(CalculatorKeyboard keyboard){
+        this.mCalculatorKeyboard = keyboard;
+    }
+
+    /**
+     * Returns the currency used for computations
+     * @return ISO 4217 currency
+     */
+    public Currency getCurrency() {
+        return mCurrency;
+    }
+
+    /**
+     * Sets the currency to use for calculations
+     * The currency determines the number of decimal places used
+     * @param currency ISO 4217 currency
+     */
+    public void setCurrency(Currency currency) {
+        this.mCurrency = currency;
+    }
+
+    /**
+     * Evaluates the arithmetic expression in the editText and sets the text property
+     * @return Result of arithmetic evaluation which is same as text displayed in edittext
+     */
+    public String evaluate(){
+        String amountText = getText().toString();
+        amountText = amountText.replaceAll(",", ".");
+        if (amountText.trim().isEmpty())
+            return amountText.trim();
+
+        ExpressionBuilder expressionBuilder = new ExpressionBuilder(amountText);
+        Expression expression;
+
+        try {
+            expression = expressionBuilder.build();
+        } catch (RuntimeException e) {
+            // FIXME: i18n
+            setError("Invalid expression!");
+            String msg = "Invalid expression: " + amountText;
+            Log.e(this.getClass().getSimpleName(), msg);
+            Crashlytics.log(msg);
+            return "";
+        }
+
+        if (expression != null && expression.validate().isValid()) {
+            BigDecimal result = new BigDecimal(expression.evaluate());
+            result = result.setScale(mCurrency.getDefaultFractionDigits(), BigDecimal.ROUND_HALF_EVEN);
+
+            DecimalFormat formatter = (DecimalFormat) NumberFormat.getInstance(Locale.getDefault());
+            formatter.setMinimumFractionDigits(0);
+            formatter.setMaximumFractionDigits(mCurrency.getDefaultFractionDigits());
+            formatter.setGroupingUsed(false);
+            String resultString = formatter.format(result.doubleValue());
+
+            setText(resultString);
+            setSelection(resultString.length());
+        } else {
+            // FIXME: i18n
+            setError("Invalid expression!");
+            Log.w(VIEW_LOG_TAG, "Expression is null or invalid: " + expression);
+        }
+        return getText().toString();
+    }
+
+    /**
+     * Evaluates the expression in the text and returns true if the result is valid
+     * @return @{code true} if the input is valid, {@code false} otherwise
+     */
+    public boolean isInputValid(){
+        evaluate();
+        return getText().length() > 0 && getError() == null;
+    }
+
+    /**
+     * Returns true if the content of this view has been modified
+     * @return {@code true} if content has changed, {@code false} otherwise
+     */
+    public boolean isInputModified(){
+        return this.isContentModified;
+    }
+
+    /**
+     * Returns the value of the amount in the edit text or null if the field is empty.
+     * Performs an evaluation of the expression first
+     * @return BigDecimal value
+     */
+    public BigDecimal getValue(){
+        evaluate();
+        String amountText = getText().toString();
+        if (amountText.isEmpty())
+            return null;
+        return new BigDecimal(amountText.replaceAll(",", ".").trim());
+    }
+}
diff --git a/app/src/main/java/org/gnucash/android/ui/util/CalculatorKeyboard.java b/app/src/main/java/org/gnucash/android/ui/util/CalculatorKeyboard.java
index 97a4bded..384ca205 100644
--- a/app/src/main/java/org/gnucash/android/ui/util/CalculatorKeyboard.java
+++ b/app/src/main/java/org/gnucash/android/ui/util/CalculatorKeyboard.java
@@ -25,10 +25,13 @@
 package org.gnucash.android.ui.util;
 
 import android.app.Activity;
+import android.content.Context;
 import android.inputmethodservice.Keyboard;
 import android.inputmethodservice.KeyboardView;
 import android.inputmethodservice.KeyboardView.OnKeyboardActionListener;
+import android.support.annotation.IdRes;
 import android.support.annotation.LayoutRes;
+import android.support.annotation.XmlRes;
 import android.text.Editable;
 import android.text.InputType;
 import android.util.Log;
@@ -69,34 +72,36 @@
  *
  * @author Maarten Pennings, extended by SimplicityApks
  * @date 2012 December 23
+ *
+ * @author lex Magaz Graa <rivaldi8@gmail.com>
+ * @author Ngewi Fet <ngewif@gmail.com>
+ *
  */
 public class CalculatorKeyboard {
 
     public static final int KEY_CODE_DECIMAL_SEPARATOR = 46;
     /** A link to the KeyboardView that is used to render this CalculatorKeyboard. */
     private KeyboardView mKeyboardView;
-    /** A link to the activity that hosts the {@link #mKeyboardView}. */
-    private Activity mHostActivity;
-    private boolean hapticFeedback;
 
-    private Currency mCurrency = Currency.getInstance(GnuCashApplication.getDefaultCurrencyCode());
+    private Context mContext;
+    private boolean hapticFeedback;
 
     final String mDecimalSeparator = Character.toString(DecimalFormatSymbols.getInstance().getDecimalSeparator());
 
     private OnKeyboardActionListener mOnKeyboardActionListener = new OnKeyboardActionListener() {
         @Override
         public void onKey(int primaryCode, int[] keyCodes) {
-            View focusCurrent = mHostActivity.getWindow().getCurrentFocus();
+            View focusCurrent = ((Activity)mContext).getWindow().getCurrentFocus();
 
             /*
             if (focusCurrent == null || focusCurrent.getClass() != EditText.class)
                 return;
             */
 
-            EditText edittext = (EditText) focusCurrent;
-            Editable editable = edittext.getText();
-            int start = edittext.getSelectionStart();
-            int end = edittext.getSelectionEnd();
+            CalculatorEditText calculatorEditText = (CalculatorEditText) focusCurrent;
+            Editable editable = calculatorEditText.getText();
+            int start = calculatorEditText.getSelectionStart();
+            int end = calculatorEditText.getSelectionEnd();
 
             // FIXME: use replace() down
             // delete the selection, if chars are selected:
@@ -130,11 +135,11 @@ public void onKey(int primaryCode, int[] keyCodes) {
                     editable.delete(deleteStart, end);
                     break;
                 case 1001:
-                    evaluateEditTextExpression(edittext);
+                    calculatorEditText.evaluate();
                     break;
                 case 1002:
                     // FIXME: show the keyboard too
-                    edittext.focusSearch(View.FOCUS_DOWN).requestFocus();
+                    calculatorEditText.focusSearch(View.FOCUS_DOWN).requestFocus();
                     break;
             }
         }
@@ -159,16 +164,15 @@ public void onPress(int arg0) {
      * and load the keyboard layout from xml file <var>layoutid</var> (see {@link Keyboard} for description).
      * Note that the <var>host</var> activity must have a <var>KeyboardView</var> in its layout (typically aligned with the bottom of the activity).
      * Note that the keyboard layout xml file may include key codes for navigation; see the constants in this class for their values.
-     * Note that to enable EditText's to use this custom keyboard, call the {@link #registerEditText(int)}.
      *
-     * @param host The hosting activity.
-     * @param keyboardViewId The id of the KeyboardView.
-     * @param xmlLayoutResId The id of the xml file containing the keyboard layout.
+     * @param context Context within with the calculator is created
+     * @param keyboardView KeyboardView in the layout
+     * @param keyboardLayoutResId The id of the xml file containing the keyboard layout.
      */
-    public CalculatorKeyboard(Activity host, int keyboardViewId, @LayoutRes int xmlLayoutResId) {
-        mHostActivity = host;
-        mKeyboardView = (KeyboardView) mHostActivity.findViewById(keyboardViewId);
-        Keyboard keyboard = new Keyboard(mHostActivity, xmlLayoutResId);
+    public CalculatorKeyboard(Context context, KeyboardView keyboardView, @XmlRes int keyboardLayoutResId) {
+        mContext = context;
+        mKeyboardView = keyboardView;
+        Keyboard keyboard = new Keyboard(mContext, keyboardLayoutResId);
         for (Keyboard.Key key : keyboard.getKeys()) {
             if (key.codes[0] == KEY_CODE_DECIMAL_SEPARATOR){
                 key.label = mDecimalSeparator;
@@ -179,7 +183,7 @@ public CalculatorKeyboard(Activity host, int keyboardViewId, @LayoutRes int xmlL
         mKeyboardView.setPreviewEnabled(false); // NOTE Do not show the preview balloons
         mKeyboardView.setOnKeyboardActionListener(mOnKeyboardActionListener);
         // Hide the standard keyboard initially
-        mHostActivity.getWindow().setSoftInputMode(WindowManager.LayoutParams.SOFT_INPUT_STATE_ALWAYS_HIDDEN);
+        ((Activity)mContext).getWindow().setSoftInputMode(WindowManager.LayoutParams.SOFT_INPUT_STATE_ALWAYS_HIDDEN);
     }
 
     /** Returns whether the CalculatorKeyboard is visible. */
@@ -190,7 +194,7 @@ public boolean isCustomKeyboardVisible() {
     /** Make the CalculatorKeyboard visible, and hide the system keyboard for view v. */
     public void showCustomKeyboard(View v) {
         if (v != null)
-            ((InputMethodManager) mHostActivity.getSystemService(Activity.INPUT_METHOD_SERVICE)).hideSoftInputFromWindow(v.getWindowToken(), 0);
+            ((InputMethodManager) mContext.getSystemService(Activity.INPUT_METHOD_SERVICE)).hideSoftInputFromWindow(v.getWindowToken(), 0);
 
         mKeyboardView.setVisibility(View.VISIBLE);
         mKeyboardView.setEnabled(true);
@@ -203,60 +207,6 @@ public void hideCustomKeyboard() {
     }
 
     /**
-     * Register <var>EditText<var> with resource id <var>resid</var> (on the hosting activity) for using this custom keyboard.
-     *
-     * @param resid The resource id of the EditText that registers to the custom keyboard.
-     */
-    public void registerEditText(int resid) {
-        // Find the EditText 'resid'
-        final EditText edittext = (EditText) mHostActivity.findViewById(resid);
-        // Make the custom keyboard appear
-        edittext.setOnFocusChangeListener(new OnFocusChangeListener() {
-            // NOTE By setting the on focus listener, we can show the custom keyboard when the edit box gets focus, but also hide it when the edit box loses focus
-            @Override
-            public void onFocusChange(View v, boolean hasFocus) {
-                if (hasFocus)
-                    showCustomKeyboard(v);
-                else {
-                    hideCustomKeyboard();
-                    evaluateEditTextExpression((EditText) v);
-                }
-            }
-        });
-
-        edittext.setOnClickListener(new OnClickListener() {
-            // NOTE By setting the on click listener we can show the custom keyboard again,
-            // by tapping on an edit box that already had focus (but that had the keyboard hidden).
-            @Override
-            public void onClick(View v) {
-                showCustomKeyboard(v);
-            }
-        });
-
-        // Disable spell check (hex strings look like words to Android)
-        edittext.setInputType(edittext.getInputType() | InputType.TYPE_TEXT_FLAG_NO_SUGGESTIONS);
-
-        // FIXME: for some reason, this prevents the text selection from working
-        edittext.setOnLongClickListener(new View.OnLongClickListener() {
-            @Override
-            public boolean onLongClick(View v) {
-                if (v != null)
-                    ((InputMethodManager) mHostActivity.getSystemService(Activity.INPUT_METHOD_SERVICE)).hideSoftInputFromWindow(v.getWindowToken(), 0);
-
-                return false;
-            }
-        });
-    }
-
-    /**
-     * Sets the currency to be used for this calculation
-     * @param currency Currency of the amount being computed
-     */
-    public void setCurrency(Currency currency){
-        this.mCurrency = currency;
-    }
-
-    /**
      * Enables or disables the Haptic feedback on keyboard touches
      * @param goEnabled true if you want haptic feedback, falso otherwise
      */
@@ -273,42 +223,11 @@ public boolean onBackPressed() {
             return false;
     }
 
-    public void evaluateEditTextExpression(EditText editText) {
-        String amountText = editText.getText().toString();
-        amountText = amountText.replaceAll(",", ".");
-        if (amountText.trim().isEmpty())
-            return;
-
-        ExpressionBuilder expressionBuilder = new ExpressionBuilder(amountText);
-        Expression expression;
-
-        try {
-            expression = expressionBuilder.build();
-        } catch (RuntimeException e) {
-            // FIXME: i18n
-            editText.setError("Invalid expression!");
-            String msg = "Invalid expression: " + amountText;
-            Log.e(this.getClass().getSimpleName(), msg);
-            Crashlytics.log(msg);
-            return;
-        }
-
-        if (expression != null && expression.validate().isValid()) {
-            BigDecimal result = new BigDecimal(expression.evaluate());
-            result = result.setScale(mCurrency.getDefaultFractionDigits(), BigDecimal.ROUND_HALF_EVEN);
-
-            DecimalFormat formatter = (DecimalFormat) NumberFormat.getInstance(Locale.getDefault());
-            formatter.setMinimumFractionDigits(0);
-            formatter.setMaximumFractionDigits(mCurrency.getDefaultFractionDigits());
-            formatter.setGroupingUsed(false);
-            String resultString = formatter.format(result.doubleValue());
-
-            editText.setText(resultString);
-            editText.setSelection(resultString.length());
-        } else {
-            // FIXME: i18n
-            editText.setError("Invalid expression!");
-            // TODO: log error
-        }
+    /**
+     * Returns the context of this keyboard
+     * @return Context
+     */
+    public Context getContext(){
+        return mContext;
     }
 }
diff --git a/app/src/main/java/org/gnucash/android/ui/util/TransactionTypeSwitch.java b/app/src/main/java/org/gnucash/android/ui/util/TransactionTypeSwitch.java
index f93164a1..b62b6fd8 100644
--- a/app/src/main/java/org/gnucash/android/ui/util/TransactionTypeSwitch.java
+++ b/app/src/main/java/org/gnucash/android/ui/util/TransactionTypeSwitch.java
@@ -166,8 +166,15 @@ public void onCheckedChanged(CompoundButton compoundButton, boolean isChecked) {
             }
             String amountText = mAmountEditText.getText().toString();
             if (amountText.length() > 0){
-                String changedSignText = TransactionFormFragment.parseInputToDecimal(amountText).negate().toPlainString();
-                mAmountEditText.setText(changedSignText); //trigger an edit to update the number sign
+                String newText = amountText;
+                if (isChecked && !amountText.startsWith("-")){
+                    newText = "-" + amountText;
+                }
+                if (!isChecked && amountText.startsWith("-")){
+                    newText = amountText.substring(1);
+                }
+                mAmountEditText.setText(newText);
+                mAmountEditText.setSelection(newText.length());
             }
         }
     }
diff --git a/app/src/main/res/layout/dialog_transfer_funds.xml b/app/src/main/res/layout/dialog_transfer_funds.xml
index 65c59081..8e4493f8 100644
--- a/app/src/main/res/layout/dialog_transfer_funds.xml
+++ b/app/src/main/res/layout/dialog_transfer_funds.xml
@@ -14,137 +14,157 @@
  See the License for the specific language governing permissions and
  limitations under the License.
 -->
-<TableLayout xmlns:android="http://schemas.android.com/apk/res/android"
+<RelativeLayout xmlns:android="http://schemas.android.com/apk/res/android"
+    xmlns:gnucash="http://schemas.android.com/apk/res-auto"
     xmlns:tools="http://schemas.android.com/tools"
-    android:orientation="vertical"
     android:layout_width="match_parent"
-    android:layout_height="wrap_content"
-    android:focusableInTouchMode="true">
-    <TableRow android:padding="@dimen/dialog_padding">
-        <TextView android:text="Amount:"
-            android:textSize="16sp"
-            android:layout_weight="1"
-            android:layout_width="0dp"
-            android:layout_height="wrap_content" />
-        <TextView android:id="@+id/amount_to_convert"
-            android:textSize="18sp"
-            tools:text="$ 2000.00"
-            android:layout_weight="2"
-            android:layout_width="0dp"
-            android:layout_height="wrap_content" />
-    </TableRow>
+    android:layout_height="match_parent">
 
-    <TableRow android:padding="@dimen/dialog_padding">
-        <TextView
-            android:text="From:"
-            android:layout_width="0dp"
-            android:layout_weight="1"
-            android:textSize="16sp"
-            android:gravity="left"
-            android:layout_height="wrap_content" />
-        <TextView android:id="@+id/from_currency"
-            android:layout_width="0dp"
-            android:layout_weight="1.5"
-            android:layout_height="wrap_content"
-            android:textStyle="bold"
-            android:textSize="18sp"
-            tools:text="USD"/>
-        <TextView android:text="To:"
-            android:layout_width="0dp"
-            android:layout_weight="1"
-            android:layout_height="wrap_content"
-            android:textSize="16sp" />
-        <TextView android:id="@+id/to_currency"
-            android:layout_width="0dp"
-            android:layout_weight="1.5"
-            android:layout_height="wrap_content"
-            android:textStyle="bold"
-            android:textSize="18sp"
-            tools:text="EUR"/>
-    </TableRow>
-
-    <TextView
-        android:padding="@dimen/dialog_padding"
+    <ScrollView
         android:layout_width="match_parent"
-        android:layout_height="wrap_content"
-        android:text="Provide either the converted amount or exchange rate in order to transfer funds"
-        />
-    <TableRow android:gravity="center_vertical"
-        android:paddingTop="@dimen/dialog_padding"
-        android:paddingLeft="@dimen/dialog_padding"
-        android:paddingRight="@dimen/dialog_padding">
-        <RadioButton android:id="@+id/radio_exchange_rate"
-            android:layout_width="0dp"
-            android:layout_weight="0.5"
-            android:layout_height="wrap_content"
-            android:checked="false" />
-
-        <android.support.design.widget.TextInputLayout
-            android:id="@+id/exchange_rate_text_input_layout"
-            android:layout_width="0dp"
-            android:layout_weight="2"
-            android:layout_height="wrap_content">
-        <EditText android:id="@+id/input_exchange_rate"
+        android:layout_height="match_parent">
+        <TableLayout
+            android:orientation="vertical"
             android:layout_width="match_parent"
             android:layout_height="wrap_content"
-            android:enabled="false"
-            android:inputType="number"
-            android:hint="Exchange rate"/>
-        </android.support.design.widget.TextInputLayout>
+            android:focusableInTouchMode="true">
+            <TableRow android:padding="@dimen/dialog_padding">
+                <TextView android:text="Amount:"
+                    android:textSize="16sp"
+                    android:layout_weight="1"
+                    android:layout_width="0dp"
+                    android:layout_height="wrap_content" />
+                <TextView android:id="@+id/amount_to_convert"
+                    android:textSize="18sp"
+                    tools:text="$ 2000.00"
+                    android:layout_weight="2"
+                    android:layout_width="0dp"
+                    android:layout_height="wrap_content" />
+            </TableRow>
 
-        <!-- TODO: re-enable this button when fetching of price quotes is implemented -->
-        <Button android:id="@+id/btn_fetch_exchange_rate"
-            style="?attr/borderlessButtonStyle"
-            android:textColor="@color/theme_accent"
-            android:layout_width="0dp"
-            android:layout_weight="1"
-            android:layout_height="wrap_content"
-            android:enabled="false"
-            android:visibility="gone"
-            android:text="Fetch quote"/>
-    </TableRow>
-    <TextView android:id="@+id/label_exchange_rate_example"
-        android:paddingLeft="@dimen/dialog_padding"
-        android:paddingRight="@dimen/dialog_padding"
-        android:paddingBottom="@dimen/dialog_padding"
-        android:layout_width="match_parent"
-        android:layout_height="wrap_content"
-        android:gravity="center"
-        tools:text="1 USD = 1.34 EUR"
-        />
+            <TableRow android:padding="@dimen/dialog_padding">
+                <TextView
+                    android:text="From:"
+                    android:layout_width="0dp"
+                    android:layout_weight="1"
+                    android:textSize="16sp"
+                    android:gravity="left"
+                    android:layout_height="wrap_content" />
+                <TextView android:id="@+id/from_currency"
+                    android:layout_width="0dp"
+                    android:layout_weight="1.5"
+                    android:layout_height="wrap_content"
+                    android:textStyle="bold"
+                    android:textSize="18sp"
+                    tools:text="USD"/>
+                <TextView android:text="To:"
+                    android:layout_width="0dp"
+                    android:layout_weight="1"
+                    android:layout_height="wrap_content"
+                    android:textSize="16sp" />
+                <TextView android:id="@+id/to_currency"
+                    android:layout_width="0dp"
+                    android:layout_weight="1.5"
+                    android:layout_height="wrap_content"
+                    android:textStyle="bold"
+                    android:textSize="18sp"
+                    tools:text="EUR"/>
+            </TableRow>
 
-    <TableRow android:gravity="center_vertical"
-        android:padding="@dimen/dialog_padding">
-        <RadioButton android:id="@+id/radio_converted_amount"
-            android:layout_width="0dp"
-            android:layout_weight="0.5"
-            android:layout_height="wrap_content"
-            android:checked="true" />
+            <TextView
+                android:padding="@dimen/dialog_padding"
+                android:layout_width="match_parent"
+                android:layout_height="wrap_content"
+                android:text="Provide either the converted amount or exchange rate in order to transfer funds"
+                />
+            <TableRow android:gravity="center_vertical"
+                android:paddingTop="@dimen/dialog_padding"
+                android:paddingLeft="@dimen/dialog_padding"
+                android:paddingRight="@dimen/dialog_padding">
+                <RadioButton android:id="@+id/radio_exchange_rate"
+                    android:layout_width="0dp"
+                    android:layout_weight="0.5"
+                    android:layout_height="wrap_content"
+                    android:checked="false" />
 
-        <android.support.design.widget.TextInputLayout
-            android:id="@+id/converted_amount_text_input_layout"
-            android:layout_width="0dp"
-            android:layout_weight="2"
-            android:layout_height="wrap_content">
-            <EditText android:id="@+id/input_converted_amount"
+                <android.support.design.widget.TextInputLayout
+                    android:id="@+id/exchange_rate_text_input_layout"
+                    android:layout_width="0dp"
+                    android:layout_weight="2"
+                    android:layout_height="wrap_content">
+                    <EditText android:id="@+id/input_exchange_rate"
+                        android:layout_width="match_parent"
+                        android:layout_height="wrap_content"
+                        android:enabled="false"
+                        android:inputType="numberDecimal"
+                        gnucash:keyboardKeysLayout="@xml/calculator_keyboard"
+                        android:hint="Exchange rate"/>
+                </android.support.design.widget.TextInputLayout>
+
+                <!-- TODO: re-enable this button when fetching of price quotes is implemented -->
+                <Button android:id="@+id/btn_fetch_exchange_rate"
+                    style="?attr/borderlessButtonStyle"
+                    android:textColor="@color/theme_accent"
+                    android:layout_width="0dp"
+                    android:layout_weight="1"
+                    android:layout_height="wrap_content"
+                    android:enabled="false"
+                    android:visibility="gone"
+                    android:text="Fetch quote"/>
+            </TableRow>
+            <TextView android:id="@+id/label_exchange_rate_example"
+                android:paddingLeft="@dimen/dialog_padding"
+                android:paddingRight="@dimen/dialog_padding"
+                android:paddingBottom="@dimen/dialog_padding"
                 android:layout_width="match_parent"
                 android:layout_height="wrap_content"
-                android:inputType="number"
-                android:hint="Converted Amount">
-                <requestFocus />
-            </EditText>
-        </android.support.design.widget.TextInputLayout>
+                android:gravity="center"
+                tools:text="1 USD = 1.34 EUR"
+                />
 
-        <TextView android:id="@+id/target_currency"
-            android:textSize="16sp"
-            android:layout_weight="0.7"
-            android:layout_width="wrap_content"
-            android:layout_height="wrap_content"
-            android:gravity="center"
-            tools:text="EUR"/>
-    </TableRow>
+            <TableRow android:gravity="center_vertical"
+                android:padding="@dimen/dialog_padding">
+                <RadioButton android:id="@+id/radio_converted_amount"
+                    android:layout_width="0dp"
+                    android:layout_weight="0.5"
+                    android:layout_height="wrap_content"
+                    android:checked="true" />
 
-    <include layout="@layout/default_buttons"
+                <android.support.design.widget.TextInputLayout
+                    android:id="@+id/converted_amount_text_input_layout"
+                    android:layout_width="0dp"
+                    android:layout_weight="2"
+                    android:layout_height="wrap_content">
+                    <EditText android:id="@+id/input_converted_amount"
+                        android:layout_width="match_parent"
+                        android:layout_height="wrap_content"
+                        android:inputType="numberDecimal"
+                        android:hint="Converted Amount">
+                        <requestFocus />
+                    </EditText>
+                </android.support.design.widget.TextInputLayout>
+
+                <TextView android:id="@+id/target_currency"
+                    android:textSize="16sp"
+                    android:layout_weight="0.7"
+                    android:layout_width="wrap_content"
+                    android:layout_height="wrap_content"
+                    android:gravity="center"
+                    tools:text="EUR"/>
+            </TableRow>
+
+            <include layout="@layout/default_buttons"
+                android:layout_height="wrap_content"
+                android:layout_width="wrap_content"/>
+        </TableLayout>
+    </ScrollView>
+    <android.inputmethodservice.KeyboardView android:id="@+id/calculator_keyboard"
+        android:layout_width="match_parent"
         android:layout_height="wrap_content"
-        android:layout_width="wrap_content"/>
-</TableLayout>
\ No newline at end of file
+        android:layout_alignParentBottom="true"
+        android:layout_alignParentLeft="true"
+        android:layout_alignParentRight="true"
+        android:focusable="true"
+        android:focusableInTouchMode="true"
+        android:visibility="gone" />
+</RelativeLayout>
\ No newline at end of file
diff --git a/app/src/main/res/layout/fragment_split_editor.xml b/app/src/main/res/layout/fragment_split_editor.xml
index f3d48b82..7e7bbb6f 100644
--- a/app/src/main/res/layout/fragment_split_editor.xml
+++ b/app/src/main/res/layout/fragment_split_editor.xml
@@ -16,62 +16,37 @@ limitations under the License.
 -->
 <RelativeLayout xmlns:android="http://schemas.android.com/apk/res/android"
     xmlns:tools="http://schemas.android.com/tools"
-    xmlns:app="http://schemas.android.com/apk/res-auto"
-    android:orientation="vertical"
-                android:layout_width="match_parent"
-                android:layout_height="match_parent"
-                android:paddingLeft="@dimen/dialog_padding"
-                android:paddingRight="@dimen/dialog_padding"
-                android:paddingTop="@dimen/dialog_padding"
+    android:layout_width="match_parent"
+    android:layout_height="match_parent"
     tools:context=".ui.FormActivity">
 
-    <ScrollView android:layout_width="match_parent"
-                android:layout_height="match_parent"
-                android:layout_above="@+id/footer">
-        <LinearLayout android:id="@+id/split_list_layout"
-                      android:layout_width="match_parent"
-                      android:layout_height="wrap_content"
-                      android:orientation="vertical">
-            <!-- Split edit views will be added here at runtime-->
-        </LinearLayout>
-    </ScrollView>
-
-
-    <include layout="@layout/horizontal_line"
-             android:layout_width="match_parent"
-             android:layout_height="1dp"
-             android:layout_above="@id/footer"/>
+    <LinearLayout
+        android:orientation="vertical"
+        android:layout_width="match_parent"
+        android:layout_height="match_parent">
+
+        <ScrollView
+            android:layout_width="match_parent"
+            android:layout_height="wrap_content"
+            android:padding="@dimen/dialog_padding"
+            android:layout_above="@+id/footer">
+            <LinearLayout android:id="@+id/split_list_layout"
+                android:layout_width="match_parent"
+                android:layout_height="wrap_content"
+                android:minHeight="200dp"
+                android:orientation="vertical">
+                <!-- Split edit views will be added here at runtime-->
+            </LinearLayout>
+        </ScrollView>
 
-    <Button android:id="@+id/btn_add_split"
-        android:layout_width="wrap_content"
+    </LinearLayout>
+    <android.inputmethodservice.KeyboardView android:id="@+id/calculator_keyboard"
+        android:layout_width="match_parent"
         android:layout_height="wrap_content"
-        android:minWidth="100dp"
         android:layout_alignParentBottom="true"
+        android:layout_alignParentLeft="true"
         android:layout_alignParentRight="true"
-        android:layout_alignParentEnd="true"
-        android:layout_gravity="center"
-        android:textColor="@android:color/white"
-        android:text="@string/btn_add_split"/>
-
-    <LinearLayout android:id="@+id/footer"
-                 android:layout_width="match_parent"
-                 android:layout_height="wrap_content"
-                 android:layout_above="@id/btn_add_split">
-
-            <TextView
-                    android:layout_width="wrap_content"
-                    android:layout_height="match_parent"
-                    android:textAppearance="?android:attr/textAppearanceSmall"
-                    android:gravity="center_vertical"
-                    android:text="@string/label_imbalance"/>
-
-            <TextView android:id="@+id/imbalance_textview"
-                      android:layout_width="0dp"
-                      android:layout_height="match_parent"
-                      android:layout_weight="1"
-                      android:textAppearance="?android:attr/textAppearanceSmall"
-                      android:gravity="right|center_vertical"
-                      tools:text="$200"/>
-    </LinearLayout>
-
+        android:focusable="true"
+        android:focusableInTouchMode="true"
+        android:visibility="gone" />
 </RelativeLayout>
\ No newline at end of file
diff --git a/app/src/main/res/layout/fragment_transaction_form.xml b/app/src/main/res/layout/fragment_transaction_form.xml
index d2b66c4a..1f8a6c1f 100644
--- a/app/src/main/res/layout/fragment_transaction_form.xml
+++ b/app/src/main/res/layout/fragment_transaction_form.xml
@@ -16,15 +16,13 @@
 -->
 
 <RelativeLayout xmlns:android="http://schemas.android.com/apk/res/android"
+    xmlns:gnucash="http://schemas.android.com/apk/res-auto"
     android:layout_width="match_parent"
     android:layout_height="match_parent">
 
     <ScrollView
         android:layout_width="match_parent"
         android:layout_height="match_parent">
-        android:padding="@dimen/dialog_padding"
-        android:stretchColumns="1"
-        android:orientation="vertical" >
 
         <TableLayout android:id="@+id/fragment_transaction_form"
             android:layout_width="match_parent"
@@ -57,7 +55,7 @@
                     android:textSize="22dp"
                     android:text="$" />
 
-                <EditText
+                <org.gnucash.android.ui.util.CalculatorEditText
                     android:id="@+id/input_transaction_amount"
                     android:layout_width="0dp"
                     android:layout_weight="3"
@@ -69,7 +67,8 @@
                     android:drawableEnd="@drawable/content_split_holo_light"
                     android:background="@android:color/transparent"
                     android:textColor="@color/debit_red"
-                    android:textSize="20sp" />
+                    android:textSize="20sp"
+                    gnucash:keyboardKeysLayout="@xml/calculator_keyboard"/>
 
                 <org.gnucash.android.ui.util.TransactionTypeSwitch
                     android:id="@+id/input_transaction_type"
diff --git a/app/src/main/res/layout/item_split_entry.xml b/app/src/main/res/layout/item_split_entry.xml
index 74fc1061..dd62af0f 100644
--- a/app/src/main/res/layout/item_split_entry.xml
+++ b/app/src/main/res/layout/item_split_entry.xml
@@ -16,6 +16,7 @@ limitations under the License.
 -->
 <LinearLayout xmlns:android="http://schemas.android.com/apk/res/android"
     xmlns:tools="http://schemas.android.com/tools"
+    xmlns:gnucash="http://schemas.android.com/apk/res-auto"
         android:layout_height="match_parent"
         android:layout_width="match_parent"
         android:orientation="vertical">
@@ -35,20 +36,20 @@ limitations under the License.
                 android:textSize="22sp"
                 android:text="$"/>
 
-        <EditText
+        <org.gnucash.android.ui.util.CalculatorEditText
                 android:id="@+id/input_split_amount"
                 android:layout_width="0dp"
                 android:layout_weight="3"
                 android:layout_height="match_parent"
                 android:layout_marginBottom="@dimen/dialog_padding"
                 android:hint="@string/label_transaction_amount"
-                android:inputType="number"
+                android:inputType="none"
                 android:nextFocusDown="@+id/input_split_memo"
                 android:textColor="@color/debit_red"
-            android:gravity="center_vertical"
-            android:textSize="18sp"
-            android:background="@android:color/transparent"
-                />
+                android:gravity="center_vertical"
+                android:textSize="18sp"
+                android:background="@android:color/transparent"
+                gnucash:keyboardKeysLayout="@xml/calculator_keyboard" />
 
         <org.gnucash.android.ui.util.TransactionTypeSwitch
             android:id="@+id/btn_split_type"
diff --git a/app/src/main/res/menu/split_editor_actions.xml b/app/src/main/res/menu/split_editor_actions.xml
new file mode 100644
index 00000000..937e9396
--- /dev/null
+++ b/app/src/main/res/menu/split_editor_actions.xml
@@ -0,0 +1,27 @@
+<?xml version="1.0" encoding="utf-8"?>
+<!--
+Copyright (c) 2015 Ngewi Fet <ngewif@gmail.com>
+
+Licensed under the Apache License, Version 2.0 (the "License");
+you may not use this file except in compliance with the License.
+You may obtain a copy of the License at
+
+http://www.apache.org/licenses/LICENSE-2.0
+
+Unless required by applicable law or agreed to in writing, software
+distributed under the License is distributed on an "AS IS" BASIS,
+WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+See the License for the specific language governing permissions and
+limitations under the License.
+-->
+<menu xmlns:android="http://schemas.android.com/apk/res/android"
+    xmlns:app="http://schemas.android.com/apk/res-auto">
+    <item android:id="@+id/menu_add_split"
+        android:icon="@drawable/ic_add_white_24dp"
+        android:title="@string/btn_add_split"
+        app:showAsAction="always"/>
+
+    <item android:id="@+id/menu_save"
+        android:title="@string/btn_save"
+        app:showAsAction="always|withText"/>
+</menu>
\ No newline at end of file
diff --git a/app/src/main/res/values-de/strings.xml b/app/src/main/res/values-de/strings.xml
index 9dc13776..0d369ba9 100644
--- a/app/src/main/res/values-de/strings.xml
+++ b/app/src/main/res/values-de/strings.xml
@@ -522,6 +522,7 @@ No user-identifiable information will be collected as part of this process!</str
 	<string name="title_setup_gnucash">Setup GnuCash</string>
 	<string name="wizard_title_welcome_to_gnucash">Welcome to GnuCash</string>
 	<string name="msg_wizard_welcome_page">Before you dive in, \nlet\'s setup a few things first\n\nTo continue, press Next</string>
+	<string name="title_split_editor">Split Editor</string>
 	<string-array name="report_time_range">
 		<item>All time</item>
 		<item>Current month</item>
diff --git a/app/src/main/res/values-el/strings.xml b/app/src/main/res/values-el/strings.xml
index 602a8ef3..eca4cb61 100644
--- a/app/src/main/res/values-el/strings.xml
+++ b/app/src/main/res/values-el/strings.xml
@@ -541,6 +541,7 @@ No user-identifiable information will be collected as part of this process!
 	<string name="title_setup_gnucash">Setup GnuCash</string>
 	<string name="wizard_title_welcome_to_gnucash">Welcome to GnuCash</string>
 	<string name="msg_wizard_welcome_page">Before you dive in, \nlet\'s setup a few things first\n\nTo continue, press Next</string>
+	<string name="title_split_editor">Split Editor</string>
 	<string-array name="report_time_range">
 		<item>All time</item>
 		<item>Current month</item>
diff --git a/app/src/main/res/values-es-rMX/strings.xml b/app/src/main/res/values-es-rMX/strings.xml
index 06555f1d..60c2e19a 100644
--- a/app/src/main/res/values-es-rMX/strings.xml
+++ b/app/src/main/res/values-es-rMX/strings.xml
@@ -526,6 +526,7 @@ No user-identifiable information will be collected as part of this process!
     <string name="title_setup_gnucash">Setup GnuCash</string>
     <string name="wizard_title_welcome_to_gnucash">Welcome to GnuCash</string>
     <string name="msg_wizard_welcome_page">Before you dive in, \nlet\'s setup a few things first\n\nTo continue, press Next</string>
+    <string name="title_split_editor">Split Editor</string>
     <string-array name="report_time_range">
         <item>All time</item>
         <item>Current month</item>
diff --git a/app/src/main/res/values-es/strings.xml b/app/src/main/res/values-es/strings.xml
index 9863b027..83e660be 100644
--- a/app/src/main/res/values-es/strings.xml
+++ b/app/src/main/res/values-es/strings.xml
@@ -523,6 +523,7 @@ Este proceso solo recoge informaci&#243;n que no permite identificar al usuario<
 	<string name="title_setup_gnucash">Setup GnuCash</string>
 	<string name="wizard_title_welcome_to_gnucash">Welcome to GnuCash</string>
 	<string name="msg_wizard_welcome_page">Before you dive in, \nlet\'s setup a few things first\n\nTo continue, press Next</string>
+	<string name="title_split_editor">Split Editor</string>
 	<string-array name="report_time_range">
 		<item>All time</item>
 		<item>Current month</item>
diff --git a/app/src/main/res/values-fr/strings.xml b/app/src/main/res/values-fr/strings.xml
index ee0189eb..a292f54b 100644
--- a/app/src/main/res/values-fr/strings.xml
+++ b/app/src/main/res/values-fr/strings.xml
@@ -523,6 +523,7 @@ Aucune information permettant d\'identifier l\'utilisateur ne sera recueillis da
     <string name="title_setup_gnucash">Setup GnuCash</string>
     <string name="wizard_title_welcome_to_gnucash">Welcome to GnuCash</string>
     <string name="msg_wizard_welcome_page">Before you dive in, \nlet\'s setup a few things first\n\nTo continue, press Next</string>
+    <string name="title_split_editor">Split Editor</string>
     <string-array name="report_time_range">
         <item>All time</item>
         <item>Current month</item>
diff --git a/app/src/main/res/values-hu/strings.xml b/app/src/main/res/values-hu/strings.xml
index e07bb308..794d7897 100644
--- a/app/src/main/res/values-hu/strings.xml
+++ b/app/src/main/res/values-hu/strings.xml
@@ -527,6 +527,7 @@ No user-identifiable information will be collected as part of this process!
     <string name="title_setup_gnucash">Setup GnuCash</string>
     <string name="wizard_title_welcome_to_gnucash">Welcome to GnuCash</string>
     <string name="msg_wizard_welcome_page">Before you dive in, \nlet\'s setup a few things first\n\nTo continue, press Next</string>
+    <string name="title_split_editor">Split Editor</string>
     <string-array name="report_time_range">
         <item>All time</item>
         <item>Current month</item>
diff --git a/app/src/main/res/values-it/strings.xml b/app/src/main/res/values-it/strings.xml
index 48f7bfac..cf17ebda 100644
--- a/app/src/main/res/values-it/strings.xml
+++ b/app/src/main/res/values-it/strings.xml
@@ -527,6 +527,7 @@ No user-identifiable information will be collected as part of this process!
     <string name="title_setup_gnucash">Setup GnuCash</string>
     <string name="wizard_title_welcome_to_gnucash">Welcome to GnuCash</string>
     <string name="msg_wizard_welcome_page">Before you dive in, \nlet\'s setup a few things first\n\nTo continue, press Next</string>
+    <string name="title_split_editor">Split Editor</string>
     <string-array name="report_time_range">
         <item>All time</item>
         <item>Current month</item>
diff --git a/app/src/main/res/values-nb/strings.xml b/app/src/main/res/values-nb/strings.xml
index 67d6ee55..db7151a7 100644
--- a/app/src/main/res/values-nb/strings.xml
+++ b/app/src/main/res/values-nb/strings.xml
@@ -524,6 +524,7 @@ Ingen brukerinformasjon vil bli delt i denne prosessen!
 	<string name="title_setup_gnucash">Setup GnuCash</string>
 	<string name="wizard_title_welcome_to_gnucash">Welcome to GnuCash</string>
 	<string name="msg_wizard_welcome_page">Before you dive in, \nlet\'s setup a few things first\n\nTo continue, press Next</string>
+	<string name="title_split_editor">Split Editor</string>
 	<string-array name="report_time_range">
 		<item>All time</item>
 		<item>Current month</item>
diff --git a/app/src/main/res/values-nl/strings.xml b/app/src/main/res/values-nl/strings.xml
index 1f26202c..b5aa2199 100644
--- a/app/src/main/res/values-nl/strings.xml
+++ b/app/src/main/res/values-nl/strings.xml
@@ -528,6 +528,7 @@ No user-identifiable information will be collected as part of this process!
     <string name="title_setup_gnucash">Setup GnuCash</string>
     <string name="wizard_title_welcome_to_gnucash">Welcome to GnuCash</string>
     <string name="msg_wizard_welcome_page">Before you dive in, \nlet\'s setup a few things first\n\nTo continue, press Next</string>
+    <string name="title_split_editor">Split Editor</string>
     <string-array name="report_time_range">
         <item>All time</item>
         <item>Current month</item>
diff --git a/app/src/main/res/values-pl/strings.xml b/app/src/main/res/values-pl/strings.xml
index 32c8880a..c91e3abf 100644
--- a/app/src/main/res/values-pl/strings.xml
+++ b/app/src/main/res/values-pl/strings.xml
@@ -524,6 +524,7 @@
     <string name="title_setup_gnucash">Setup GnuCash</string>
     <string name="wizard_title_welcome_to_gnucash">Welcome to GnuCash</string>
     <string name="msg_wizard_welcome_page">Before you dive in, \nlet\'s setup a few things first\n\nTo continue, press Next</string>
+    <string name="title_split_editor">Split Editor</string>
     <string-array name="report_time_range">
         <item>All time</item>
         <item>Current month</item>
diff --git a/app/src/main/res/values-pt-rBR/strings.xml b/app/src/main/res/values-pt-rBR/strings.xml
index 17ac2916..e5fde424 100644
--- a/app/src/main/res/values-pt-rBR/strings.xml
+++ b/app/src/main/res/values-pt-rBR/strings.xml
@@ -526,6 +526,7 @@ Nenhuma informao de  identificao do usurio ser coletada neste proces
 	<string name="title_setup_gnucash">Setup GnuCash</string>
 	<string name="wizard_title_welcome_to_gnucash">Welcome to GnuCash</string>
 	<string name="msg_wizard_welcome_page">Before you dive in, \nlet\'s setup a few things first\n\nTo continue, press Next</string>
+	<string name="title_split_editor">Split Editor</string>
 	<string-array name="report_time_range">
 		<item>All time</item>
 		<item>Current month</item>
diff --git a/app/src/main/res/values-ru/strings.xml b/app/src/main/res/values-ru/strings.xml
index 1825c4bf..b5651a09 100644
--- a/app/src/main/res/values-ru/strings.xml
+++ b/app/src/main/res/values-ru/strings.xml
@@ -530,6 +530,7 @@
     <string name="title_setup_gnucash">Setup GnuCash</string>
     <string name="wizard_title_welcome_to_gnucash">Welcome to GnuCash</string>
     <string name="msg_wizard_welcome_page">Before you dive in, \nlet\'s setup a few things first\n\nTo continue, press Next</string>
+    <string name="title_split_editor">Split Editor</string>
     <string-array name="report_time_range">
         <item>All time</item>
         <item>Current month</item>
diff --git a/app/src/main/res/values-uk/strings.xml b/app/src/main/res/values-uk/strings.xml
index 48d97d5e..b31ccb34 100644
--- a/app/src/main/res/values-uk/strings.xml
+++ b/app/src/main/res/values-uk/strings.xml
@@ -510,6 +510,7 @@
     <string name="title_setup_gnucash">Setup GnuCash</string>
     <string name="wizard_title_welcome_to_gnucash">Welcome to GnuCash</string>
     <string name="msg_wizard_welcome_page">Before you dive in, \nlet\'s setup a few things first\n\nTo continue, press Next</string>
+    <string name="title_split_editor">Split Editor</string>
     <string-array name="report_time_range">
         <item>All time</item>
         <item>Current month</item>
diff --git a/app/src/main/res/values-zh-rTW/strings.xml b/app/src/main/res/values-zh-rTW/strings.xml
index de9b0d2d..4eacdb09 100644
--- a/app/src/main/res/values-zh-rTW/strings.xml
+++ b/app/src/main/res/values-zh-rTW/strings.xml
@@ -524,6 +524,7 @@ No user-identifiable information will be collected as part of this process!
     <string name="title_setup_gnucash">Setup GnuCash</string>
     <string name="wizard_title_welcome_to_gnucash">Welcome to GnuCash</string>
     <string name="msg_wizard_welcome_page">Before you dive in, \nlet\'s setup a few things first\n\nTo continue, press Next</string>
+    <string name="title_split_editor">Split Editor</string>
     <string-array name="report_time_range">
         <item>All time</item>
         <item>Current month</item>
diff --git a/app/src/main/res/values-zh/strings.xml b/app/src/main/res/values-zh/strings.xml
index 5591db95..063d6a26 100644
--- a/app/src/main/res/values-zh/strings.xml
+++ b/app/src/main/res/values-zh/strings.xml
@@ -525,6 +525,7 @@ No user-identifiable information will be collected as part of this process!
     <string name="title_setup_gnucash">Setup GnuCash</string>
     <string name="wizard_title_welcome_to_gnucash">Welcome to GnuCash</string>
     <string name="msg_wizard_welcome_page">Before you dive in, \nlet\'s setup a few things first\n\nTo continue, press Next</string>
+    <string name="title_split_editor">Split Editor</string>
     <string-array name="report_time_range">
         <item>All time</item>
         <item>Current month</item>
diff --git a/app/src/main/res/values/arrays.xml b/app/src/main/res/values/arrays.xml
index 29fff55f..f324e138 100644
--- a/app/src/main/res/values/arrays.xml
+++ b/app/src/main/res/values/arrays.xml
@@ -1,4 +1,19 @@
 <?xml version="1.0" encoding="utf-8"?>
+<!--
+ Copyright (c) 2015 Ngewi Fet <ngewif@gmail.com>
+
+ Licensed under the Apache License, Version 2.0 (the "License");
+ you may not use this file except in compliance with the License.
+ You may obtain a copy of the License at
+
+    http://www.apache.org/licenses/LICENSE-2.0
+
+ Unless required by applicable law or agreed to in writing, software
+ distributed under the License is distributed on an "AS IS" BASIS,
+ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ See the License for the specific language governing permissions and
+ limitations under the License.
+-->
 <resources>
     <array name="account_colors">
         <item>#0B57A4</item> <!-- aqua -->
diff --git a/app/src/main/res/values/attrs.xml b/app/src/main/res/values/attrs.xml
new file mode 100644
index 00000000..95887275
--- /dev/null
+++ b/app/src/main/res/values/attrs.xml
@@ -0,0 +1,22 @@
+<?xml version="1.0" encoding="utf-8"?>
+<!--
+ Copyright (c) 2015 Ngewi Fet <ngewif@gmail.com>
+
+ Licensed under the Apache License, Version 2.0 (the "License");
+ you may not use this file except in compliance with the License.
+ You may obtain a copy of the License at
+
+    http://www.apache.org/licenses/LICENSE-2.0
+
+ Unless required by applicable law or agreed to in writing, software
+ distributed under the License is distributed on an "AS IS" BASIS,
+ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ See the License for the specific language governing permissions and
+ limitations under the License.
+-->
+<resources>
+    <declare-styleable name="CalculatorEditText">
+        <attr name="keyboardKeysLayout" format="reference" />
+    </declare-styleable>
+
+</resources>
\ No newline at end of file
diff --git a/app/src/main/res/values/strings.xml b/app/src/main/res/values/strings.xml
index c55be383..4df85f44 100644
--- a/app/src/main/res/values/strings.xml
+++ b/app/src/main/res/values/strings.xml
@@ -530,6 +530,7 @@
     <string name="title_setup_gnucash">Setup GnuCash</string>
     <string name="wizard_title_welcome_to_gnucash">Welcome to GnuCash</string>
     <string name="msg_wizard_welcome_page">Before you dive in, \nlet\'s setup a few things first\n\nTo continue, press Next</string>
+    <string name="title_split_editor">Split Editor</string>
     <string-array name="report_time_range">
         <item>All time</item>
         <item>Current month</item>
