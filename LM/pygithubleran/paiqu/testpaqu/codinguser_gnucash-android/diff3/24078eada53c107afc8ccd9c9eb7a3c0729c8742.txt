From 44eb8f28a314d47cfd09edf39427124422743b02 Mon Sep 17 00:00:00 2001
From: Ngewi Fet <ngewif@gmail.com>
Date: Fri, 8 Feb 2013 16:02:25 +0100
Subject: [PATCH 01/10] Display number of sub-accounts in account list view
 Display toast when saving transaction with no amount Refactored layouts for
 reusability

---
 app/res/layout/list_item_2_lines.xml               |  43 +++++++++
 app/res/layout/list_item_account.xml               |  79 ++++++++-------
 app/res/layout/list_item_transaction.xml           | 107 +++++++++------------
 app/res/values-de/strings.xml                      |   5 +
 app/res/values-el/strings.xml                      |   7 +-
 app/res/values-es-rMX/strings.xml                  |   5 +
 app/res/values-es/strings.xml                      |   7 +-
 app/res/values-fr/strings.xml                      |   5 +
 app/res/values-hu/strings.xml                      |   7 +-
 app/res/values-it/strings.xml                      |   5 +
 app/res/values-nb/strings.xml                      |   5 +
 app/res/values-nl/strings.xml                      |   5 +
 app/res/values-pt-rBR/strings.xml                  |   5 +
 app/res/values-ru/strings.xml                      |   5 +
 app/res/values/strings.xml                         |   5 +
 .../org/gnucash/android/db/AccountsDbAdapter.java  |  13 ++-
 .../android/ui/accounts/AccountsListFragment.java  |  13 ++-
 .../ui/transactions/NewTransactionFragment.java    |  77 ++++-----------
 .../ui/transactions/TransactionsListFragment.java  |   4 +-
 19 files changed, 237 insertions(+), 165 deletions(-)
 create mode 100644 app/res/layout/list_item_2_lines.xml

diff --git a/app/res/layout/list_item_2_lines.xml b/app/res/layout/list_item_2_lines.xml
new file mode 100644
index 00000000..5bd6da13
--- /dev/null
+++ b/app/res/layout/list_item_2_lines.xml
@@ -0,0 +1,43 @@
+<?xml version="1.0" encoding="utf-8"?>
+<!--
+Copyright (c) 2013 Ngewi Fet <ngewif@gmail.com>
+
+Licensed under the Apache License, Version 2.0 (the "License");
+you may not use this file except in compliance with the License.
+You may obtain a copy of the License at
+
+http://www.apache.org/licenses/LICENSE-2.0
+
+Unless required by applicable law or agreed to in writing, software
+distributed under the License is distributed on an "AS IS" BASIS,
+WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+See the License for the specific language governing permissions and
+limitations under the License.
+-->
+
+<RelativeLayout
+        xmlns:android="http://schemas.android.com/apk/res/android"
+        android:layout_height="wrap_content"
+        android:layout_width="0dp"
+        android:layout_weight="1"
+        android:orientation="vertical">
+
+    <TextView
+            android:id="@+id/primary_text"
+            android:layout_width="wrap_content"
+            android:layout_height="wrap_content"
+            android:singleLine="true"
+            android:ellipsize="end"
+            android:text="@string/label_transaction_name"
+            style="@style/ListItemText"/>
+
+    <TextView
+            android:id="@+id/secondary_text"
+            android:layout_width="wrap_content"
+            android:layout_height="wrap_content"
+            android:singleLine="true"
+            android:ellipsize="end"
+            android:layout_below="@id/primary_text"
+            android:textAppearance="?android:attr/textAppearanceSmall"
+            android:text="@string/label_transaction_name"/>
+</RelativeLayout>
\ No newline at end of file
diff --git a/app/res/layout/list_item_account.xml b/app/res/layout/list_item_account.xml
index b6f63706..f8fdb565 100644
--- a/app/res/layout/list_item_account.xml
+++ b/app/res/layout/list_item_account.xml
@@ -16,46 +16,45 @@
 -->
 
 <LinearLayout xmlns:android="http://schemas.android.com/apk/res/android"
-    android:layout_width="match_parent"
-	android:layout_height="?android:attr/listPreferredItemHeight"
-	android:gravity="center_vertical"
-	android:paddingLeft="5dp"
-	android:paddingRight="@dimen/edge_padding"
-    android:orientation="horizontal"
-    style="@style/ListItem">
+              android:layout_width="match_parent"
+              android:layout_height="?android:attr/listPreferredItemHeight"
+              android:gravity="center_vertical"
+              android:paddingLeft="5dp"
+              android:paddingRight="@dimen/edge_padding"
+              android:orientation="horizontal"
+              style="@style/ListItem">
+
+    <include
+            layout="@layout/list_item_2_lines"
+            android:layout_height="wrap_content"
+            android:layout_width="0dp"
+            android:layout_weight="1"
+            android:layout_marginLeft="@dimen/edge_padding"
+            android:layout_marginRight="@dimen/edge_padding"/>
+
+    <TextView
+            android:id="@+id/transactions_summary"
+            android:layout_width="wrap_content"
+            android:layout_height="match_parent"
+            android:singleLine="true"
+            style="@style/ListItemText"
+            android:layout_marginRight="@dimen/edge_padding"/>
 
-     <TextView android:id="@+id/account_name" 
-         android:layout_width="0dp"
-         android:layout_height="match_parent"
-         android:layout_weight="1"
-         android:singleLine="true"
-         android:ellipsize="end"
-         android:paddingLeft="@dimen/edge_padding"
-         android:paddingRight="@dimen/edge_padding"
-         android:text="@string/label_account_name"              
-         style="@style/ListItemText" /> 
-                
-    <TextView android:id="@+id/transactions_summary"
-        android:layout_width="wrap_content"
-        android:layout_height="match_parent"
-        android:singleLine="true" 
-        style="@style/ListItemText"
-        android:layout_marginRight="@dimen/edge_padding" />      
-	
     <View
-        android:id="@+id/vertical_line" 
-        android:layout_width="1dp"
-        android:layout_height="40dp"
-        android:background="@android:color/darker_gray"
-        android:layout_marginRight="10dp"
-        />
-    
-    <ImageView android:id="@+id/btn_new_transaction" 
-        android:layout_width="wrap_content"
-        android:layout_height="wrap_content" 
-        android:background="@drawable/content_new_holo_light"  
-        android:padding="2dp"
-        android:clickable="true"
-        android:contentDescription="@string/description_add_transaction_icon"/>
-        
+            android:id="@+id/vertical_line"
+            android:layout_width="1dp"
+            android:layout_height="40dp"
+            android:background="@android:color/darker_gray"
+            android:layout_marginRight="10dp"
+            />
+
+    <ImageView
+            android:id="@+id/btn_new_transaction"
+            android:layout_width="wrap_content"
+            android:layout_height="wrap_content"
+            android:background="@drawable/content_new_holo_light"
+            android:padding="2dp"
+            android:clickable="true"
+            android:contentDescription="@string/description_add_transaction_icon"/>
+
 </LinearLayout>
\ No newline at end of file
diff --git a/app/res/layout/list_item_transaction.xml b/app/res/layout/list_item_transaction.xml
index 56bd0674..65e6e36d 100644
--- a/app/res/layout/list_item_transaction.xml
+++ b/app/res/layout/list_item_transaction.xml
@@ -16,64 +16,51 @@
 -->
 
 <LinearLayout xmlns:android="http://schemas.android.com/apk/res/android"
-    android:layout_width="match_parent"
-    android:layout_height="match_parent"
-    android:orientation="vertical">
-    
-    <TextView android:id="@+id/date_section_header" 
-        android:layout_width="match_parent"
-        android:layout_height="20dp"
-        android:paddingLeft="10dp"
-        android:background="#CCCCCC"
-        android:textColor="@android:color/white"
-        android:visibility="gone"                
-        />
-    
-    <LinearLayout 
-        android:layout_width="match_parent"
-	    android:layout_height="wrap_content"
-	    style="@style/ListItem"
-	    android:orientation="horizontal" >
-	    
-	    <CheckBox android:id="@+id/checkbox"
-	        android:layout_width="wrap_content"
-	        android:layout_height="wrap_content"
-	        android:focusable="false"        
-	        />
-	    <RelativeLayout 
-	        android:layout_height="wrap_content"	        
-	        android:layout_width="0dp"
-	        android:layout_weight="1"
-	        android:orientation="vertical">
-	        
-			<TextView android:id="@+id/transaction_name" 
-		            android:layout_width="wrap_content"
-		            android:layout_height="wrap_content"			            	            
-					android:paddingLeft="5dp"                                 
-			        android:singleLine="true"
-			        android:ellipsize="end"
-			        android:text="@string/label_transaction_name"                
-		            style="@style/ListItemText" /> 
-		            
-		    <TextView android:id="@+id/transaction_note" 
-		            android:layout_width="wrap_content"
-		            android:layout_height="wrap_content"
-					android:paddingLeft="5dp"                                 
-			        android:singleLine="true"
-			        android:ellipsize="end"
-			        android:layout_below="@id/transaction_name"			        
-			        android:textAppearance="?android:attr/textAppearanceSmall"
-			        android:text="@string/label_transaction_name"  />
-	    </RelativeLayout>
-		<TextView android:id="@+id/transaction_amount" 
-	            android:layout_width="wrap_content"
-	            android:layout_height="match_parent"
-	            android:singleLine="true"
-	            android:ellipsize="end"
-	            android:text="@string/label_transaction_amount"         
-	            android:minWidth="100dp"   
-	            android:gravity="right|center_vertical"  
-	            android:layout_marginRight="12dp"   
-	            style="@style/ListItemText" /> 
-		</LinearLayout>	
+              android:layout_width="match_parent"
+              android:layout_height="match_parent"
+              android:orientation="vertical">
+
+    <TextView
+            android:id="@+id/date_section_header"
+            android:layout_width="match_parent"
+            android:layout_height="20dp"
+            android:paddingLeft="10dp"
+            android:background="#CCCCCC"
+            android:textColor="@android:color/white"
+            android:visibility="gone"
+            />
+
+    <LinearLayout
+            android:layout_width="match_parent"
+            android:layout_height="wrap_content"
+            style="@style/ListItem"
+            android:orientation="horizontal">
+
+        <CheckBox
+                android:id="@+id/checkbox"
+                android:layout_width="wrap_content"
+                android:layout_height="wrap_content"
+                android:focusable="false"
+                />
+
+        <include
+                layout="@layout/list_item_2_lines"
+                android:layout_height="wrap_content"
+                android:layout_width="0dp"
+                android:layout_weight="1"
+                android:layout_marginLeft="5dp"
+                />
+
+        <TextView
+                android:id="@+id/transaction_amount"
+                android:layout_width="wrap_content"
+                android:layout_height="match_parent"
+                android:singleLine="true"
+                android:ellipsize="end"
+                android:text="@string/label_transaction_amount"
+                android:minWidth="100dp"
+                android:gravity="right|center_vertical"
+                android:layout_marginRight="12dp"
+                style="@style/ListItemText"/>
+    </LinearLayout>
 </LinearLayout>
\ No newline at end of file
diff --git a/app/res/values-de/strings.xml b/app/res/values-de/strings.xml
index 1d2bcea3..17812496 100644
--- a/app/res/values-de/strings.xml
+++ b/app/res/values-de/strings.xml
@@ -315,4 +315,9 @@
         - Behebung von diverse Fehlern\n	        
 	</string>
 	<string name="label_dismiss">Schlieen</string>
+    <string name="toast_transanction_amount_required">Geben Sie einen Betrag ein um die Buchung speichern zu knnen</string>
+    <plurals name="label_sub_accounts">
+        <item quantity="one">%d Unterkonto</item>
+        <item quantity="other">%d Unterkonten</item>
+    </plurals>
 </resources>
\ No newline at end of file
diff --git a/app/res/values-el/strings.xml b/app/res/values-el/strings.xml
index d7ee655f..d34625ba 100644
--- a/app/res/values-el/strings.xml
+++ b/app/res/values-el/strings.xml
@@ -321,4 +321,9 @@
         -    \n        
 	</string>
 	<string name="label_dismiss"></string>
-</resources>
+    <string name="toast_transanction_amount_required">Enter an amount to save the transaction</string>
+    <plurals name="label_sub_accounts">
+        <item quantity="one">%d sub-account</item>
+        <item quantity="other">%d sub-accounts</item>
+    </plurals>
+</resources>
diff --git a/app/res/values-es-rMX/strings.xml b/app/res/values-es-rMX/strings.xml
index 255d9be8..2b159d04 100644
--- a/app/res/values-es-rMX/strings.xml
+++ b/app/res/values-es-rMX/strings.xml
@@ -314,4 +314,9 @@
         - Numerous bug fixes\n	        
 	</string>
 	<string name="label_dismiss">Dismiss</string>
+    <string name="toast_transanction_amount_required">Enter an amount to save the transaction</string>
+    <plurals name="label_sub_accounts">
+        <item quantity="one">%d sub-account</item>
+        <item quantity="other">%d sub-accounts</item>
+    </plurals>
 </resources>
\ No newline at end of file
diff --git a/app/res/values-es/strings.xml b/app/res/values-es/strings.xml
index 93326927..8a416d1e 100644
--- a/app/res/values-es/strings.xml
+++ b/app/res/values-es/strings.xml
@@ -314,5 +314,10 @@
         - SGML es el formato por defecto para la exportaci&#243;n OFX\n
         - Varios bugs solucionados\n	        
 	</string>
-	<string name="label_dismiss">Cerrar</string>	
+	<string name="label_dismiss">Cerrar</string>
+    <string name="toast_transanction_amount_required">Enter an amount to save the transaction</string>
+    <plurals name="label_sub_accounts">
+        <item quantity="one">%d sub-account</item>
+        <item quantity="other">%d sub-accounts</item>
+    </plurals>
 </resources>
diff --git a/app/res/values-fr/strings.xml b/app/res/values-fr/strings.xml
index 64672e76..2688dba0 100644
--- a/app/res/values-fr/strings.xml
+++ b/app/res/values-fr/strings.xml
@@ -315,4 +315,9 @@
         - Plusieurs correctifs\n	        
 	</string>
 	<string name="label_dismiss">Passer</string>
+    <string name="toast_transanction_amount_required">Enter an amount to save the transaction</string>
+    <plurals name="label_sub_accounts">
+        <item quantity="one">%d sub-account</item>
+        <item quantity="other">%d sub-accounts</item>
+    </plurals>
 </resources>
\ No newline at end of file
diff --git a/app/res/values-hu/strings.xml b/app/res/values-hu/strings.xml
index b9d5486c..feee1d1e 100644
--- a/app/res/values-hu/strings.xml
+++ b/app/res/values-hu/strings.xml
@@ -313,5 +313,10 @@
         - SGML is default OFX export format\n
         - Numerous bug fixes\n	        
 	</string>
-	<string name="label_dismiss">Dismiss</string>	
+	<string name="label_dismiss">Dismiss</string>
+    <string name="toast_transanction_amount_required">Enter an amount to save the transaction</string>
+    <plurals name="label_sub_accounts">
+        <item quantity="one">%d sub-account</item>
+        <item quantity="other">%d sub-accounts</item>
+    </plurals>
 </resources>
\ No newline at end of file
diff --git a/app/res/values-it/strings.xml b/app/res/values-it/strings.xml
index fb80a1b4..dd4b7682 100644
--- a/app/res/values-it/strings.xml
+++ b/app/res/values-it/strings.xml
@@ -315,4 +315,9 @@
         - Molte correzioni di bug\n	        
 	</string>
 	<string name="label_dismiss">Chiudi</string>
+    <string name="toast_transanction_amount_required">Enter an amount to save the transaction</string>
+    <plurals name="label_sub_accounts">
+        <item quantity="one">%d sub-account</item>
+        <item quantity="other">%d sub-accounts</item>
+    </plurals>
 </resources>
diff --git a/app/res/values-nb/strings.xml b/app/res/values-nb/strings.xml
index 47d4959c..ea054998 100644
--- a/app/res/values-nb/strings.xml
+++ b/app/res/values-nb/strings.xml
@@ -318,4 +318,9 @@ format og importeres i regnskapsprogrammet GnuCash for PC.</string>
         - Mange feilrettinger\n	        
 	</string>
 	<string name="label_dismiss">Ferdig</string>
+    <string name="toast_transanction_amount_required">Enter an amount to save the transaction</string>
+    <plurals name="label_sub_accounts">
+        <item quantity="one">%d sub-account</item>
+        <item quantity="other">%d sub-accounts</item>
+    </plurals>
 </resources>
diff --git a/app/res/values-nl/strings.xml b/app/res/values-nl/strings.xml
index 76673b99..03c63533 100644
--- a/app/res/values-nl/strings.xml
+++ b/app/res/values-nl/strings.xml
@@ -315,4 +315,9 @@
         - Numerous bug fixes\n        
 	</string>
 	<string name="label_dismiss">Dismiss</string>
+    <string name="toast_transanction_amount_required">Enter an amount to save the transaction</string>
+    <plurals name="label_sub_accounts">
+        <item quantity="one">%d sub-account</item>
+        <item quantity="other">%d sub-accounts</item>
+    </plurals>
 </resources>
diff --git a/app/res/values-pt-rBR/strings.xml b/app/res/values-pt-rBR/strings.xml
index 6dd7a471..4ea0ade1 100644
--- a/app/res/values-pt-rBR/strings.xml
+++ b/app/res/values-pt-rBR/strings.xml
@@ -314,4 +314,9 @@
 	    - Diversas correes de bugs\n	        
 	  </string>
 	  <string name="label_dismiss">Descartar</string>
+    <string name="toast_transanction_amount_required">Enter an amount to save the transaction</string>
+    <plurals name="label_sub_accounts">
+        <item quantity="one">%d sub-account</item>
+        <item quantity="other">%d sub-accounts</item>
+    </plurals>
 </resources>
diff --git a/app/res/values-ru/strings.xml b/app/res/values-ru/strings.xml
index 82ac3a40..5c55ed18 100644
--- a/app/res/values-ru/strings.xml
+++ b/app/res/values-ru/strings.xml
@@ -315,4 +315,9 @@
         -   \n
 	</string>
 	<string name="label_dismiss">Dismiss</string>
+    <string name="toast_transanction_amount_required">Enter an amount to save the transaction</string>
+    <plurals name="label_sub_accounts">
+        <item quantity="one">%d sub-account</item>
+        <item quantity="other">%d sub-accounts</item>
+    </plurals>
 </resources>
diff --git a/app/res/values/strings.xml b/app/res/values/strings.xml
index ad913b50..9d6cd1fe 100644
--- a/app/res/values/strings.xml
+++ b/app/res/values/strings.xml
@@ -508,4 +508,9 @@
         - Numerous bug fixes\n	        
 	</string>
 	<string name="label_dismiss">Dismiss</string>
+    <string name="toast_transanction_amount_required">Enter an amount to save the transaction</string>
+    <plurals name="label_sub_accounts">
+        <item quantity="one">%d sub-account</item>
+        <item quantity="other">%d sub-accounts</item>
+    </plurals>
 </resources>
diff --git a/app/src/org/gnucash/android/db/AccountsDbAdapter.java b/app/src/org/gnucash/android/db/AccountsDbAdapter.java
index 3a3acb11..3d22fd15 100644
--- a/app/src/org/gnucash/android/db/AccountsDbAdapter.java
+++ b/app/src/org/gnucash/android/db/AccountsDbAdapter.java
@@ -362,7 +362,7 @@ public Money getAllAccountsBalance(){
      * @return Account Balance of an account including sub-accounts
      */
     public Money getAccountBalance(long accountId){
-        List<Long> subAccounts = fetchSubAccounts(accountId);
+        List<Long> subAccounts = getSubAccountIds(accountId);
         Money balance = Money.createInstance(getCurrencyCode(accountId));
         for (long id : subAccounts){
             //recurse because arbitrary nesting depth is allowed
@@ -376,7 +376,7 @@ public Money getAccountBalance(long accountId){
      * @param accountId Account ID whose sub-accounts are to be retrieved
      * @return List of IDs for the sub-accounts for account <code>accountId</code>
      */
-    public List<Long> fetchSubAccounts(long accountId){
+    public List<Long> getSubAccountIds(long accountId){
         List<Long> subAccounts = new ArrayList<Long>();
         Cursor cursor = mDb.query(DatabaseHelper.ACCOUNTS_TABLE_NAME,
                 new String[]{DatabaseHelper.KEY_ROW_ID}, DatabaseHelper.KEY_PARENT_ACCOUNT_UID + " = ?",
@@ -392,6 +392,15 @@ public Money getAccountBalance(long accountId){
         return subAccounts;
     }
 
+    /**
+     * Returns the number of accounts for which the account with ID <code>accoundId</code> is a first level parent
+     * @param accountId Database ID of parent account
+     * @return Number of sub accounts
+     */
+    public int getSubAccountCount(long accountId){
+        return getSubAccountIds(accountId).size();
+    }
+
 	/**
 	 * Returns the balance for all transactions while taking double entry into consideration
 	 * This means that double transactions will be counted twice
diff --git a/app/src/org/gnucash/android/ui/accounts/AccountsListFragment.java b/app/src/org/gnucash/android/ui/accounts/AccountsListFragment.java
index 6d56be56..03df6565 100644
--- a/app/src/org/gnucash/android/ui/accounts/AccountsListFragment.java
+++ b/app/src/org/gnucash/android/ui/accounts/AccountsListFragment.java
@@ -226,7 +226,7 @@ public void onCreate(Bundle savedInstanceState) {
 				getActivity().getApplicationContext(), 
 				R.layout.list_item_account, null,
 				new String[] { DatabaseHelper.KEY_NAME },
-				new int[] { R.id.account_name });
+				new int[] { R.id.primary_text });
 						
 		setListAdapter(mAccountsCursorAdapter);
 	}
@@ -497,7 +497,16 @@ public void bindView(View v, Context context, Cursor cursor) {
 			TextView summary = (TextView) v
 					.findViewById(R.id.transactions_summary);
 			final long accountId = cursor.getLong(DatabaseAdapter.COLUMN_ROW_ID);
-			
+
+            TextView subAccountTextView = (TextView) v.findViewById(R.id.secondary_text);
+            int subAccountCount = mAccountsDbAdapter.getSubAccountCount(accountId);
+            if (subAccountCount > 0){
+                subAccountTextView.setVisibility(View.VISIBLE);
+                String text = getResources().getQuantityString(R.plurals.label_sub_accounts, subAccountCount, subAccountCount);
+                subAccountTextView.setText(text);
+            } else
+                subAccountTextView.setVisibility(View.GONE);
+
 			Money balance = mAccountsDbAdapter.getAccountBalance(accountId);//transactionsDBAdapter.getTransactionsSum(accountId);
 			summary.setText(balance.formattedString(Locale.getDefault()));
 			int fontColor = balance.isNegative() ? getResources().getColor(R.color.debit_red) : 
diff --git a/app/src/org/gnucash/android/ui/transactions/NewTransactionFragment.java b/app/src/org/gnucash/android/ui/transactions/NewTransactionFragment.java
index a620fb20..995ec9ab 100644
--- a/app/src/org/gnucash/android/ui/transactions/NewTransactionFragment.java
+++ b/app/src/org/gnucash/android/ui/transactions/NewTransactionFragment.java
@@ -28,6 +28,7 @@
 import java.util.GregorianCalendar;
 import java.util.Locale;
 
+import android.widget.*;
 import org.gnucash.android.R;
 import org.gnucash.android.data.Money;
 import org.gnucash.android.data.Transaction;
@@ -58,14 +59,7 @@
 import android.view.View;
 import android.view.ViewGroup;
 import android.view.inputmethod.InputMethodManager;
-import android.widget.CompoundButton;
 import android.widget.CompoundButton.OnCheckedChangeListener;
-import android.widget.DatePicker;
-import android.widget.EditText;
-import android.widget.Spinner;
-import android.widget.TextView;
-import android.widget.TimePicker;
-import android.widget.ToggleButton;
 
 import com.actionbarsherlock.app.ActionBar;
 import com.actionbarsherlock.app.SherlockFragment;
@@ -173,12 +167,6 @@
 	private Calendar mTime;
 
 	/**
-	 * ActionBar Menu item for saving the transaction
-	 * A transaction needs atleast a name and amount, only then is the save menu item enabled
-	 */
-	private MenuItem mSaveMenuItem;
-
-	/**
 	 * Spinner for selecting the transfer account
 	 */
 	private Spinner mDoubleAccountSpinner;
@@ -319,10 +307,6 @@ private void updateTransferAccountsList(){
 	 * Sets click listeners for the dialog buttons
 	 */
 	private void setListeners() {
-		ValidationsWatcher validations = new ValidationsWatcher();
-		mAmountEditText.addTextChangedListener(validations);
-		mNameEditText.addTextChangedListener(validations);
-		
 		mAmountEditText.addTextChangedListener(new AmountInputFormatter());
 		
 		mTransactionTypeButton.setOnCheckedChangeListener(new OnCheckedChangeListener() {
@@ -383,8 +367,12 @@ public void onClick(View v) {
 				fragment.show(ft, "time_dialog");
 			}
 		});
-	}	
-	
+	}
+
+    /**
+     * Updates the spinner to the selected transfer account
+     * @param accountId Database ID of the transfer account
+     */
 	private void setSelectedTransferAccount(long accountId){
 		for (int pos = 0; pos < mCursorAdapter.getCount(); pos++) {
 			if (mCursorAdapter.getItemId(pos) == accountId){
@@ -393,12 +381,21 @@ private void setSelectedTransferAccount(long accountId){
 			}
 		}
 	}
-	
+
+    /**
+     * Returns true if we are editing the transaction from within it's transfer account,
+     * rather than the account in which the transaction was created
+     * @return <code>true</code> if in transfer account, <code>false</code> otherwise
+     */
 	private boolean isInDoubleAccount(){
 		long accountId = mTransactionsDbAdapter.getAccountID(mTransaction.getAccountUID());
 		return ((TransactionsActivity)getActivity()).getCurrentAccountID() != accountId;
 	}
 
+    /**
+     * Callback when the account in the navigation bar is changed by the user
+     * @param newAccountId Database record ID of the newly selected account
+     */
 	public void onAccountChanged(long newAccountId){
 		AccountsDbAdapter accountsDbAdapter = new AccountsDbAdapter(getActivity());
 		String currencyCode = accountsDbAdapter.getCurrencyCode(newAccountId);
@@ -477,9 +474,6 @@ public void onDestroyView() {
 	@Override
 	public void onCreateOptionsMenu(Menu menu, MenuInflater inflater) {
 		inflater.inflate(R.menu.default_save_actions, menu);
-		mSaveMenuItem = menu.findItem(R.id.menu_save);
-		//only initially enable if we are editing a transaction
-		mSaveMenuItem.setEnabled(mTransactionId > 0);
 	}
 	
 	@Override
@@ -494,7 +488,10 @@ public boolean onOptionsItemSelected(MenuItem item) {
 			return true;
 			
 		case R.id.menu_save:
-			saveNewTransaction();
+            if (mAmountEditText.getText().length() == 0){
+                Toast.makeText(getActivity(), R.string.toast_transanction_amount_required, Toast.LENGTH_SHORT).show();
+            } else
+			    saveNewTransaction();
 			return true;
 
 		default:
@@ -568,39 +565,7 @@ public BigDecimal parseInputToDecimal(String amountString){
 		return amount;
 	}
 
-	/**
-	 * Validates that the name and amount of the transaction is provided
-	 * before enabling the save button
-	 * @author Ngewi Fet <ngewif@gmail.com>
-	 *
-	 */
-	private class ValidationsWatcher implements TextWatcher {
 
-		@Override
-		public void afterTextChanged(Editable s) {
-			boolean valid = (mAmountEditText.getText().length() > 0);
-			
-			//JellyBean 4.2 calls onActivityCreated before creating the menu
-			if (mSaveMenuItem != null)
-				mSaveMenuItem.setEnabled(valid);
-		}
-
-		@Override
-		public void beforeTextChanged(CharSequence s, int start, int count,
-				int after) {
-			// TODO Auto-generated method stub
-			
-		}
-
-		@Override
-		public void onTextChanged(CharSequence s, int start, int before,
-				int count) {
-			// TODO Auto-generated method stub
-			
-		}
-		
-	}
-	
 	/**
 	 * Captures input string in the amount input field and parses it into a formatted amount
 	 * The amount input field allows numbers to be input sequentially and they are parsed
diff --git a/app/src/org/gnucash/android/ui/transactions/TransactionsListFragment.java b/app/src/org/gnucash/android/ui/transactions/TransactionsListFragment.java
index e66e8783..13e78d60 100644
--- a/app/src/org/gnucash/android/ui/transactions/TransactionsListFragment.java
+++ b/app/src/org/gnucash/android/ui/transactions/TransactionsListFragment.java
@@ -173,7 +173,7 @@ public void onCreate(Bundle savedInstanceState) {
 				getActivity().getApplicationContext(), 
 				R.layout.list_item_transaction, null, 
 				new String[] {DatabaseHelper.KEY_NAME, DatabaseHelper.KEY_AMOUNT}, 
-				new int[] {R.id.transaction_name, R.id.transaction_amount});
+				new int[] {R.id.primary_text, R.id.transaction_amount});
 		setListAdapter(mCursorAdapter);
 	}
 	
@@ -470,7 +470,7 @@ public void bindView(View view, Context context, Cursor cursor) {
 			else
 				tramount.setTextColor(getResources().getColor(R.color.credit_green));
 			
-			TextView trNote = (TextView) view.findViewById(R.id.transaction_note);
+			TextView trNote = (TextView) view.findViewById(R.id.secondary_text);
 			String description = cursor.getString(DatabaseAdapter.COLUMN_DESCRIPTION);
 			if (description == null || description.length() == 0)
 				trNote.setVisibility(View.GONE);

From f458236f533e5f36f5c1c69bc13fa2b4863fcd25 Mon Sep 17 00:00:00 2001
From: windwarrior <lennartbuit@gmail.com>
Date: Mon, 18 Feb 2013 00:43:29 +0100
Subject: [PATCH 02/10] Improved Dutch translations
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

Hi there, i am new to this, but i tried translating some strings for you after i read your blogpost at planet.gnome.org, the one i left untranslated were either unclear to me, or i could think of a fitting translation.

Hope this helps :). Feedback in my translations is muchappreciated.
---
 app/res/values-nl/strings.xml | 46 +++++++++++++++++++++----------------------
 1 file changed, 23 insertions(+), 23 deletions(-)

diff --git a/app/res/values-nl/strings.xml b/app/res/values-nl/strings.xml
index 76673b99..8cc16127 100644
--- a/app/res/values-nl/strings.xml
+++ b/app/res/values-nl/strings.xml
@@ -82,7 +82,7 @@
     <string name="label_permission_create_account">Dagboeken aanmaken</string>
     <string name="label_display_account">Dagboek tonen</string>
     <string name="btn_create_accounts">Dagboeken aanmaken</string>
-    <string name="title_default_accounts">Te aanmaken dagboeken selecteren</string>
+    <string name="title_default_accounts">Aan te maken dagboeken selecteren</string>
     <string-array name="currency_names">
         <item>Afghani</item>
 		<item>Algerian Dinar</item>
@@ -282,37 +282,37 @@
 	<string name="title_export_email">GnuCash OFX export</string>
 	<string name="description_export_email">GnuCash OFX Export van </string>
 	<string name="header_transaction_settings">Transacties</string>
-	<string name="title_transaction_preferences">Transaction Preferences</string>
-	<string name="title_account_preferences">Account Preferences</string>
-	<string name="title_default_transaction_type">Default Transaction Type</string>
-	<string name="summary_default_transaction_type">The type of transaction to use by default, CREDIT or DEBIT</string>
+	<string name="title_transaction_preferences">Transactie voorkeuren</string>
+	<string name="title_account_preferences">Account voorkeuren</string>
+	<string name="title_default_transaction_type">Standaard Transactietype</string>
+	<string name="summary_default_transaction_type">Het standaard transactietype, CREDIT or DEBIT</string>
 	<string-array name="transaction_types">
 		<item>CREDIT</item>
 		<item>DEBIT</item>
 	</string-array>
-	<string name="delete_all_transactions_confirmation_message">Are you sure you want to delete ALL transactions?</string>
-	<string name="delete_transaction_confirmation_message">Are you sure you want to delete this transaction?</string>
-	<string name="title_export_preference_category">Export</string>
-	<string name="title_export_all_transactions">Export all transactions</string>
-	<string name="title_always_delete_exported_transactions">Delete exported transactions</string>
-	<string name="title_default_export_email">Default export email</string>
+	<string name="delete_all_transactions_confirmation_message">Weet u zeker dat u alle transacties wil verwijderen?</string>
+	<string name="delete_transaction_confirmation_message">Weet u zeker dat u deze transactie wil verwijderen?</string>
+	<string name="title_export_preference_category">Exporteer</string>
+	<string name="title_export_all_transactions">Exporteer alle transacties</string>
+	<string name="title_always_delete_exported_transactions">Verwijder gexporteerde transacties</string>
+	<string name="title_default_export_email">Standaard export emailadres</string>
 	<string name="summary_default_export_email">The default email address to send exports to. You can still change this when you export.</string>	
-	<string name="label_double_entry_account">Transfer Account</string>
-	<string name="summary_use_double_entry">All transactions will be a transfer from one account to another</string>
+	<string name="label_double_entry_account">Draag Account over</string>
+	<string name="summary_use_double_entry">Alle transacties zullen worden overgedragen van het ene account naar de andere</string>
 	<string name="title_use_double_entry">Activate Double Entry</string>
-	<string name="account_balance">Balance</string>
-	<string name="toast_no_account_name_entered">Please enter an account name</string>
-	<string name="label_account_currency">Currency</string>
+	<string name="account_balance">Saldo</string>
+	<string name="toast_no_account_name_entered">Vul een accountnaam in</string>
+	<string name="label_account_currency">Munteenheid</string>
 	<string name="label_parent_account">Parent account</string>
-	<string name="title_xml_ofx_header">Use XML OFX header</string>
-	<string name="summary_xml_ofx_header">Enable this option when exporting to third-party application other than GnuCash for desktop</string>
-	<string name="title_whats_new">What\'s New</string>
+	<string name="title_xml_ofx_header">Gebruik XML OFX header</string>
+	<string name="summary_xml_ofx_header">Schakel deze optie in als u naar een applicatie anders dan GnuCash wil exporteren</string>
+	<string name="title_whats_new">Nieuw sinds de vorige versie</string>
 	<string name="whats_new">
-	    <b>Version 1.1.0 - 31.01.2013</b>\n\n
+	    <b>Versie 1.1.0 - 31.01.2013</b>\n\n
         - Double entry accounting\n
-        - Nested accounts\n
-        - SGML is default OFX export format\n
-        - Numerous bug fixes\n        
+        - Geneste accounts\n
+        - SGML is standaard OFX export formaat\n
+        - Vele bug fixes\n        
 	</string>
 	<string name="label_dismiss">Dismiss</string>
 </resources>

From 38c02d075a9f985b8a775b07800c0e3d6108f277 Mon Sep 17 00:00:00 2001
From: windwarrior <lennartbuit@gmail.com>
Date: Mon, 18 Feb 2013 19:21:20 +0100
Subject: [PATCH 03/10] Translated last strings for you

I translated a few more of your development branch, I could not figure out what you meant with "double entry accounting", so left that untranslated. I left the currencies untranslated, because that seems better to me.

Fellow Dutchies, please review :)
---
 app/res/values-nl/strings.xml | 14 +++++++-------
 1 file changed, 7 insertions(+), 7 deletions(-)

diff --git a/app/res/values-nl/strings.xml b/app/res/values-nl/strings.xml
index bda3672d..973ae9e9 100644
--- a/app/res/values-nl/strings.xml
+++ b/app/res/values-nl/strings.xml
@@ -55,7 +55,7 @@
     <string name="option_export_all_transactions">All transacties exporteren</string>
     <string name="hint_export_choice">Aanvinken om alle transacties te exporteren. Anders worden enkel de nieuwe transacties sinds de laatste export ge&#235;xporteerd.</string>
     <string name="error_exporting">Fout tijdens het exporteren van de OFX data</string>    
-    <string name="btn_export">Export</string>
+    <string name="btn_export">Exporteer</string>
     <string name="option_delete_after_export">Verwijderen na exporteren</string>
     <string name="hint_delete_after_export">Alle ge&#235;xporteerde transacties zullen verwijderd worden na de export</string>
     <string name="title_settings">Instellingen</string>
@@ -264,8 +264,8 @@
 	    <item>Uitgaven</item>
 	    <item>Inkomsten</item>
 	    <item>Activa</item>	    
-	    <item>Equity</item>
-	    <item>Liabilities</item>
+	    <item>Eigen Vermogen</item>
+	    <item>Passiva</item>
 	</string-array>
 	<string name="error_no_accounts">Geen dagboeken beschikbaar.\nU moet een dagboek aanmaken alvorens een widget toe te voegen</string>
 	<string name="title_build_version">Versie</string>
@@ -296,10 +296,10 @@
 	<string name="title_export_all_transactions">Exporteer alle transacties</string>
 	<string name="title_always_delete_exported_transactions">Verwijder gexporteerde transacties</string>
 	<string name="title_default_export_email">Standaard export emailadres</string>
-	<string name="summary_default_export_email">The default email address to send exports to. You can still change this when you export.</string>	
+	<string name="summary_default_export_email">Het standaard emailaddress om gexporteerde data heen te sturen. U kan dit emailadres nog wijzigen als u exporteerd.</string>	
 	<string name="label_double_entry_account">Draag Account over</string>
 	<string name="summary_use_double_entry">Alle transacties zullen worden overgedragen van het ene account naar de andere</string>
-	<string name="title_use_double_entry">Activate Double Entry</string>
+	<string name="title_use_double_entry">Schake Double Entry in</string>
 	<string name="account_balance">Saldo</string>
 	<string name="toast_no_account_name_entered">Vul een accountnaam in</string>
 	<string name="label_account_currency">Munteenheid</string>
@@ -314,8 +314,8 @@
         - SGML is standaard OFX export formaat\n
         - Vele bug fixes\n        
 	</string>
-	<string name="label_dismiss">Dismiss</string>
-    <string name="toast_transanction_amount_required">Enter an amount to save the transaction</string>
+	<string name="label_dismiss">Wijs af</string>
+    <string name="toast_transanction_amount_required">Vul een bedrag in om de transactie op te slaan.</string>
     <plurals name="label_sub_accounts">
         <item quantity="one">%d sub-account</item>
         <item quantity="other">%d sub-accounts</item>

From a052139f6429ecbcffd6fc341f370ae5a508d165 Mon Sep 17 00:00:00 2001
From: Ngewi Fet <ngewif@gmail.com>
Date: Mon, 25 Mar 2013 20:56:25 +0100
Subject: [PATCH 04/10] Enable use only accounts with same currency for double
 entry String update

---
 app/res/values-de/strings.xml                                |  2 +-
 app/res/values-el/strings.xml                                |  2 +-
 app/res/values-es-rMX/strings.xml                            |  2 +-
 app/res/values-es/strings.xml                                |  2 +-
 app/res/values-fr/strings.xml                                |  2 +-
 app/res/values-hu/strings.xml                                |  2 +-
 app/res/values-it/strings.xml                                |  2 +-
 app/res/values-nb/strings.xml                                |  2 +-
 app/res/values-pt-rBR/strings.xml                            |  2 +-
 app/res/values-ru/strings.xml                                |  2 +-
 app/res/values/strings.xml                                   |  2 +-
 app/src/org/gnucash/android/data/Account.java                |  2 +-
 .../gnucash/android/ui/accounts/AccountsListFragment.java    |  2 +-
 .../gnucash/android/ui/accounts/ExportDialogFragment.java    |  7 ++++---
 .../android/ui/transactions/NewTransactionFragment.java      | 12 ++++++++----
 .../android/ui/widget/WidgetConfigurationActivity.java       | 10 +++++++---
 16 files changed, 32 insertions(+), 23 deletions(-)

diff --git a/app/res/values-de/strings.xml b/app/res/values-de/strings.xml
index 17812496..02681fb9 100644
--- a/app/res/values-de/strings.xml
+++ b/app/res/values-de/strings.xml
@@ -301,7 +301,7 @@
 	<string name="summary_use_double_entry">Alle Buchungen stellen eine berweisung von einem Konto zu einem anderen dar</string>
 	<string name="title_use_double_entry">Doppelte Buchfhrung aktivieren</string>
 	<string name="account_balance">Kontostand</string>
-	<string name="toast_no_account_name_entered">Bitte geben Sie einen Kontonamen ein</string>
+	<string name="toast_no_account_name_entered">Geben Sie einen Kontonamen ein um das Konto zu erstellen</string>
 	<string name="label_account_currency">Whrung</string>
 	<string name="label_parent_account">Hauptkonto</string>
 	<string name="title_xml_ofx_header">XML OFX header verwenden</string>
diff --git a/app/res/values-el/strings.xml b/app/res/values-el/strings.xml
index d34625ba..deaf40e1 100644
--- a/app/res/values-el/strings.xml
+++ b/app/res/values-el/strings.xml
@@ -307,7 +307,7 @@
 	<string name="summary_use_double_entry">          .</string>
 	<string name="title_use_double_entry">   </string>
 	<string name="account_balance"></string>
-	<string name="toast_no_account_name_entered">    </string>
+	<string name="toast_no_account_name_entered">Enter an account name to create an account</string>
 	<string name="label_account_currency"></string>
 	<string name="label_parent_account"> </string>
 	<string name="title_xml_ofx_header">  XML OFX</string>
diff --git a/app/res/values-es-rMX/strings.xml b/app/res/values-es-rMX/strings.xml
index 2b159d04..ab94bf09 100644
--- a/app/res/values-es-rMX/strings.xml
+++ b/app/res/values-es-rMX/strings.xml
@@ -300,7 +300,7 @@
 	<string name="summary_use_double_entry">All transactions will be a transfer from one account to another</string>
 	<string name="title_use_double_entry">Activate Double Entry</string>
 	<string name="account_balance">Balance</string>
-	<string name="toast_no_account_name_entered">Please enter an account name</string>
+	<string name="toast_no_account_name_entered">Enter an account name to create an account</string>
 	<string name="label_account_currency">Currency</string>
 	<string name="label_parent_account">Parent account</string>
 	<string name="title_xml_ofx_header">Use XML OFX header</string>
diff --git a/app/res/values-es/strings.xml b/app/res/values-es/strings.xml
index 8a416d1e..bc2c76c3 100644
--- a/app/res/values-es/strings.xml
+++ b/app/res/values-es/strings.xml
@@ -301,7 +301,7 @@
 	<string name="summary_use_double_entry">Todas las transacciones ser&#225;n transferidas de una cuenta a otra</string>
 	<string name="title_use_double_entry">Activar Doble Entrada</string>
 	<string name="account_balance">Saldo</string>
-	<string name="toast_no_account_name_entered">Por favor introduzca un nombre para la cuenta</string>
+	<string name="toast_no_account_name_entered">Enter an account name to create an account</string>
 	<string name="label_account_currency">Divisa</string>
 	<string name="label_parent_account">Cuenta padre</string>
 	<string name="title_xml_ofx_header">Usar cabecera XML OFX</string>
diff --git a/app/res/values-fr/strings.xml b/app/res/values-fr/strings.xml
index 2688dba0..de0632a3 100644
--- a/app/res/values-fr/strings.xml
+++ b/app/res/values-fr/strings.xml
@@ -301,7 +301,7 @@
 	<string name="summary_use_double_entry">Toutes les transactions seront transf&#233;rer d\'un compte &#224; l\'autre</string>
 	<string name="title_use_double_entry">Activer les doubles entr&#233;es</string>
 	<string name="account_balance">Balance</string>
-	<string name="toast_no_account_name_entered">Veuillez entrer un nom de compte</string>
+	<string name="toast_no_account_name_entered">Enter an account name to create an account</string>
 	<string name="label_account_currency">Monnaie</string>
 	<string name="label_parent_account">Compte parent</string>
 	<string name="title_xml_ofx_header">Utiliser l\'ent&#234;te XML d\'OFX</string>
diff --git a/app/res/values-hu/strings.xml b/app/res/values-hu/strings.xml
index feee1d1e..053a5d41 100644
--- a/app/res/values-hu/strings.xml
+++ b/app/res/values-hu/strings.xml
@@ -300,7 +300,7 @@
 	<string name="summary_use_double_entry">All transactions will be a transfer from one account to another</string>
 	<string name="title_use_double_entry">Activate Double Entry</string>
 	<string name="account_balance">Balance</string>
-	<string name="toast_no_account_name_entered">Please enter an account name</string>
+	<string name="toast_no_account_name_entered">Enter an account name to create an account</string>
 	<string name="label_account_currency">Currency</string>
 	<string name="label_parent_account">Parent account</string>
 	<string name="title_xml_ofx_header">Use XML OFX header</string>
diff --git a/app/res/values-it/strings.xml b/app/res/values-it/strings.xml
index dd4b7682..dd4a3e3f 100644
--- a/app/res/values-it/strings.xml
+++ b/app/res/values-it/strings.xml
@@ -301,7 +301,7 @@
 	<string name="summary_use_double_entry">Tutte le transazioni consisteranno in un trasferimento di denaro da un conto a un altro</string>
 	<string name="title_use_double_entry">Abilita partita doppia</string>
 	<string name="account_balance">Saldo</string>
-	<string name="toast_no_account_name_entered">Inserire un nome per il conto</string>
+	<string name="toast_no_account_name_entered">Enter an account name to create an account</string>
 	<string name="label_account_currency">Valuta</string>
 	<string name="label_parent_account">Conto principale</string>
 	<string name="title_xml_ofx_header">Usa header XML OFX</string>
diff --git a/app/res/values-nb/strings.xml b/app/res/values-nb/strings.xml
index ea054998..71e844c5 100644
--- a/app/res/values-nb/strings.xml
+++ b/app/res/values-nb/strings.xml
@@ -304,7 +304,7 @@ format og importeres i regnskapsprogrammet GnuCash for PC.</string>
 	<string name="summary_use_double_entry">Alle transaksjoner vil bli overfrt fra en konto til en annen</string>
 	<string name="title_use_double_entry">Aktiver dobbel bokfring</string>
 	<string name="account_balance">Balanse</string>
-	<string name="toast_no_account_name_entered">Skriv inn et kontonavn</string>
+	<string name="toast_no_account_name_entered">Enter an account name to create an account</string>
 	<string name="label_account_currency">Valuta</string>
 	<string name="label_parent_account">Hovedkonto</string>
 	<string name="title_xml_ofx_header">Bruk XML OFX header</string>
diff --git a/app/res/values-pt-rBR/strings.xml b/app/res/values-pt-rBR/strings.xml
index 4ea0ade1..334bf4e4 100644
--- a/app/res/values-pt-rBR/strings.xml
+++ b/app/res/values-pt-rBR/strings.xml
@@ -300,7 +300,7 @@
 	  <string name="summary_use_double_entry">Todas as transaes sero uma transferncia de uma conta para outra</string>
 	  <string name="title_use_double_entry">Ativar Partidas Dobradas</string>
 	  <string name="account_balance">Balano</string>
-	  <string name="toast_no_account_name_entered">Por favor adicione um nome para a conta</string>
+	  <string name="toast_no_account_name_entered">Enter an account name to create an account</string>
 	  <string name="label_account_currency">Moeda</string>
 	  <string name="label_parent_account">Conta superior</string>
 	  <string name="title_xml_ofx_header">Usar cabealho XML OFX</string>
diff --git a/app/res/values-ru/strings.xml b/app/res/values-ru/strings.xml
index 5c55ed18..83fbb9cc 100644
--- a/app/res/values-ru/strings.xml
+++ b/app/res/values-ru/strings.xml
@@ -301,7 +301,7 @@
 	<string name="summary_use_double_entry">   (    ).         .</string>
 	<string name="title_use_double_entry">  </string>
 	<string name="account_balance"></string>
-	<string name="toast_no_account_name_entered">  </string>
+	<string name="toast_no_account_name_entered">Enter an account name to create an account</string>
 	<string name="label_account_currency"></string>
 	<string name="label_parent_account"> </string>
 	<string name="title_xml_ofx_header"> XML- OFX</string>
diff --git a/app/res/values/strings.xml b/app/res/values/strings.xml
index 9d6cd1fe..f97c9f81 100644
--- a/app/res/values/strings.xml
+++ b/app/res/values/strings.xml
@@ -493,7 +493,7 @@
 	<string name="summary_use_double_entry">All transactions will be a transfer from one account to another</string>
 	<string name="title_use_double_entry">Activate Double Entry</string>
 	<string name="account_balance">Balance</string>
-	<string name="toast_no_account_name_entered">Please enter an account name</string>
+	<string name="toast_no_account_name_entered">Enter an account name to create an account</string>
 	<string name="label_account_currency">Currency</string>
 	<string name="label_parent_account">Parent account</string>
 	<string name="title_xml_ofx_header">Use XML OFX header</string>
diff --git a/app/src/org/gnucash/android/data/Account.java b/app/src/org/gnucash/android/data/Account.java
index 383bbe54..c3ad8361 100644
--- a/app/src/org/gnucash/android/data/Account.java
+++ b/app/src/org/gnucash/android/data/Account.java
@@ -266,7 +266,7 @@ public boolean hasUnexportedTransactions(){
 	
 	/**
 	 * Returns the aggregate of all transactions in this account.
-	 * It takes into account debit and credit amounts
+	 * It takes into account debit and credit amounts, it does not however consider sub-accounts
 	 * @return {@link Money} aggregate amount of all transactions in account.
 	 */
 	public Money getBalance(){
diff --git a/app/src/org/gnucash/android/ui/accounts/AccountsListFragment.java b/app/src/org/gnucash/android/ui/accounts/AccountsListFragment.java
index 03df6565..9b8269c7 100644
--- a/app/src/org/gnucash/android/ui/accounts/AccountsListFragment.java
+++ b/app/src/org/gnucash/android/ui/accounts/AccountsListFragment.java
@@ -541,7 +541,7 @@ public AccountsCursorLoader(Context context) {
 		@Override
 		public Cursor loadInBackground() {			
 			mDatabaseAdapter = new AccountsDbAdapter(getContext());	
-			Cursor cursor = ((AccountsDbAdapter) mDatabaseAdapter).fetchAllRecords();
+			Cursor cursor = mDatabaseAdapter.fetchAllRecords();
 			if (cursor != null)
 				registerContentObserver(cursor);
 			return cursor;
diff --git a/app/src/org/gnucash/android/ui/accounts/ExportDialogFragment.java b/app/src/org/gnucash/android/ui/accounts/ExportDialogFragment.java
index 645b5efb..27ee3b27 100644
--- a/app/src/org/gnucash/android/ui/accounts/ExportDialogFragment.java
+++ b/app/src/org/gnucash/android/ui/accounts/ExportDialogFragment.java
@@ -226,7 +226,7 @@ public void onClick(View v) {
 	
 	/**
 	 * Writes the OFX document <code>doc</code> to external storage
-	 * @param Document containing OFX file data
+	 * @param doc Document containing OFX file data
 	 * @throws IOException if file could not be saved
 	 */
 	private void writeToExternalStorage(Document doc) throws IOException{
@@ -351,9 +351,10 @@ protected Document exportOfx(boolean exportAll) throws ParserConfigurationExcept
 	}
 	
 	/**
-	 * Writes out the file held in <code>document</code> to <code>outputWriter</code>
-	 * @param document {@link Document} containing the OFX document structure
+	 * Writes out the document held in <code>node</code> to <code>outputWriter</code>
+	 * @param node {@link Node} containing the OFX document structure. Usually the parent node
 	 * @param outputWriter {@link Writer} to use in writing the file to stream
+     * @param omitXmlDeclaration Flag which causes the XML declaration to be omitted
 	 */
 	public void write(Node node, Writer outputWriter, boolean omitXmlDeclaration){
 		try {
diff --git a/app/src/org/gnucash/android/ui/transactions/NewTransactionFragment.java b/app/src/org/gnucash/android/ui/transactions/NewTransactionFragment.java
index 995ec9ab..c0c57456 100644
--- a/app/src/org/gnucash/android/ui/transactions/NewTransactionFragment.java
+++ b/app/src/org/gnucash/android/ui/transactions/NewTransactionFragment.java
@@ -283,15 +283,19 @@ private void initalizeViews() {
 		Currency accountCurrency = Currency.getInstance(code);
 		mCurrencyTextView.setText(accountCurrency.getSymbol(Locale.getDefault()));
 	}
-	
+
+    /**
+     * Updates the list of possible transfer accounts.
+     * Only accounts with the same currency can be transferred to
+     */
 	private void updateTransferAccountsList(){
 		long accountId = ((TransactionsActivity)getActivity()).getCurrentAccountID();
 		
 		//TODO: we'll leave out the currency condition for now, maybe look at this in the future
-//		String conditions = "(" + DatabaseHelper.KEY_ROW_ID + " != " + accountId + ") AND " + "(" +
-//							DatabaseHelper.KEY_CURRENCY_CODE + " = '" + mAccountsDbAdapter.getCurrencyCode(accountId) + "')";
+		String conditions = "(" + DatabaseHelper.KEY_ROW_ID + " != " + accountId + ") AND " + "(" +
+							DatabaseHelper.KEY_CURRENCY_CODE + " = '" + mAccountsDbAdapter.getCurrencyCode(accountId) + "')";
 		
-		String conditions = "(" + DatabaseHelper.KEY_ROW_ID + " != " + accountId + ")";
+//		String conditions = "(" + DatabaseHelper.KEY_ROW_ID + " != " + accountId + ")";
 		mCursor = mAccountsDbAdapter.fetchAccounts(conditions);
 		
 		String[] from = new String[] {DatabaseHelper.KEY_NAME};
diff --git a/app/src/org/gnucash/android/ui/widget/WidgetConfigurationActivity.java b/app/src/org/gnucash/android/ui/widget/WidgetConfigurationActivity.java
index daf88b61..900cb8ad 100644
--- a/app/src/org/gnucash/android/ui/widget/WidgetConfigurationActivity.java
+++ b/app/src/org/gnucash/android/ui/widget/WidgetConfigurationActivity.java
@@ -20,6 +20,7 @@
 
 import org.gnucash.android.R;
 import org.gnucash.android.data.Account;
+import org.gnucash.android.data.Money;
 import org.gnucash.android.db.AccountsDbAdapter;
 import org.gnucash.android.db.DatabaseHelper;
 import org.gnucash.android.receivers.TransactionAppWidgetProvider;
@@ -156,7 +157,7 @@ public static void updateWidget(Context context, int appWidgetId, long accountId
 
 		AccountsDbAdapter accountsDbAdapter = new AccountsDbAdapter(context);
 		Account account = accountsDbAdapter.getAccount(accountId);
-		accountsDbAdapter.close();
+
 		
 		if (account == null){
 			Log.i("WidgetConfiguration", "Account not found, updating widget " + appWidgetId);
@@ -180,11 +181,14 @@ public static void updateWidget(Context context, int appWidgetId, long accountId
 		RemoteViews views = new RemoteViews(context.getPackageName(),
 				R.layout.widget_4x1);
 		views.setTextViewText(R.id.account_name, account.getName());
+        Money accountBalance = accountsDbAdapter.getAccountBalance(accountId);
 		views.setTextViewText(R.id.transactions_summary, 
-				account.getBalance().formattedString(Locale.getDefault()));
+				accountBalance.formattedString(Locale.getDefault()));
 		int color = account.getBalance().isNegative() ? R.color.debit_red : R.color.credit_green;
 		views.setTextColor(R.id.transactions_summary, context.getResources().getColor(color));
-		
+
+        accountsDbAdapter.close();
+
 		Intent accountViewIntent = new Intent(context, TransactionsActivity.class);
 		accountViewIntent.setAction(Intent.ACTION_VIEW);
 		accountViewIntent.addFlags(Intent.FLAG_ACTIVITY_NEW_TASK|Intent.FLAG_ACTIVITY_CLEAR_TASK);

From de24fa3b8c1d4bf26b16468bb58266022f2acf0f Mon Sep 17 00:00:00 2001
From: Ngewi Fet <ngewif@gmail.com>
Date: Wed, 3 Apr 2013 23:14:13 +0200
Subject: [PATCH 05/10] Feature: implemented importing account structure from
 Gnucash desktop. Option offered on first run of app Fixed: Crash when
 computing account balance for accounts with sub-accounts of different
 currency. Only consider sub-accounts of same currency when computing account
 balance Improved: Added account preferences for deleting all accounts
 Improved: Support for GnuCash ROOT account. Account will never be shown to
 user

---
 app/res/menu/account_actions.xml                   |   2 +-
 app/res/menu/global_actions.xml                    |   2 +-
 app/res/values-de/strings.xml                      |  15 +
 app/res/values-el/strings.xml                      |  15 +
 app/res/values-es-rMX/strings.xml                  |  15 +
 app/res/values-es/strings.xml                      |  15 +
 app/res/values-fr/strings.xml                      |  15 +
 app/res/values-hu/strings.xml                      |  15 +
 app/res/values-it/strings.xml                      |  15 +
 app/res/values-nb/strings.xml                      |  15 +
 app/res/values-nl/strings.xml                      |  15 +
 app/res/values-pt-rBR/strings.xml                  |  15 +
 app/res/values-ru/strings.xml                      |  15 +
 app/res/values/strings.xml                         |  17 +
 app/res/xml/fragment_about_preferences.xml         |   6 +-
 app/res/xml/fragment_account_preferences.xml       |  10 +
 app/res/xml/preference_headers.xml                 |   4 +-
 app/src/org/gnucash/android/data/Account.java      |   7 +-
 .../org/gnucash/android/db/AccountsDbAdapter.java  |  10 +-
 .../android/ui/accounts/AccountsActivity.java      |  73 +-
 .../android/ui/accounts/AccountsListFragment.java  | 961 +++++++++++----------
 .../ui/settings/AccountPreferencesFragment.java    | 102 +++
 .../settings/DeleteAccountsConfirmationDialog.java |  67 ++
 .../android/ui/settings/SettingsActivity.java      |   6 +-
 .../android/util/GnucashAccountXmlHandler.java     | 143 +++
 25 files changed, 1075 insertions(+), 500 deletions(-)
 create mode 100644 app/res/xml/fragment_account_preferences.xml
 create mode 100644 app/src/org/gnucash/android/ui/settings/AccountPreferencesFragment.java
 create mode 100644 app/src/org/gnucash/android/ui/settings/DeleteAccountsConfirmationDialog.java
 create mode 100644 app/src/org/gnucash/android/util/GnucashAccountXmlHandler.java

diff --git a/app/res/menu/account_actions.xml b/app/res/menu/account_actions.xml
index 89fd15bc..6b594b21 100644
--- a/app/res/menu/account_actions.xml
+++ b/app/res/menu/account_actions.xml
@@ -25,5 +25,5 @@
           android:icon="@drawable/content_import_export_holo_light"
           android:title="@string/menu_export_ofx"
           android:showAsAction="never"
-          android:orderInCategory="3"/>            
+          android:orderInCategory="3"/>
 </menu>
\ No newline at end of file
diff --git a/app/res/menu/global_actions.xml b/app/res/menu/global_actions.xml
index 85f9d49c..287712a4 100644
--- a/app/res/menu/global_actions.xml
+++ b/app/res/menu/global_actions.xml
@@ -21,5 +21,5 @@
           android:icon="@drawable/action_settings"
           android:title="@string/title_settings"
           android:showAsAction="never"
-          android:orderInCategory="4"/>    
+          android:orderInCategory="4"/>
 </menu>
\ No newline at end of file
diff --git a/app/res/values-de/strings.xml b/app/res/values-de/strings.xml
index 02681fb9..a8553734 100644
--- a/app/res/values-de/strings.xml
+++ b/app/res/values-de/strings.xml
@@ -316,6 +316,21 @@
 	</string>
 	<string name="label_dismiss">Schlieen</string>
     <string name="toast_transanction_amount_required">Geben Sie einen Betrag ein um die Buchung speichern zu knnen</string>
+    <string name="menu_import_accounts">Import GnuCash Accounts</string>
+    <string name="btn_import_accounts">Import Accounts</string>
+    <string name="toast_error_importing_accounts">An error occurred while importing the GnuCash accounts</string>
+    <string name="toast_success_importing_accounts">GnuCash Accounts successfully imported</string>
+    <string name="summary_import_accounts">Import account structure exported from GnuCash desktop</string>
+    <string name="title_import_accounts">Import GnuCash accounts</string>
+    <string name="summary_delete_all_accounts">Delete all accounts in the database. All transactions will be deleted as
+        well.
+    </string>
+    <string name="title_delete_all_accounts">Delete all accounts</string>
+    <string name="header_account_settings">Accounts</string>
+    <string name="toast_all_accounts_deleted">All accounts have been successfully deleted</string>
+    <string name="confirm_delete_all_accounts">Are you sure you want to delete all accounts and transactions? \nThis
+        operation cannot be undone!
+    </string>
     <plurals name="label_sub_accounts">
         <item quantity="one">%d Unterkonto</item>
         <item quantity="other">%d Unterkonten</item>
diff --git a/app/res/values-el/strings.xml b/app/res/values-el/strings.xml
index deaf40e1..f9f96801 100644
--- a/app/res/values-el/strings.xml
+++ b/app/res/values-el/strings.xml
@@ -322,6 +322,21 @@
 	</string>
 	<string name="label_dismiss"></string>
     <string name="toast_transanction_amount_required">Enter an amount to save the transaction</string>
+    <string name="menu_import_accounts">Import GnuCash Accounts</string>
+    <string name="btn_import_accounts">Import Accounts</string>
+    <string name="toast_error_importing_accounts">An error occurred while importing the GnuCash accounts</string>
+    <string name="toast_success_importing_accounts">GnuCash accounts successfully imported</string>
+    <string name="summary_import_accounts">Import account structure exported from GnuCash desktop</string>
+    <string name="title_import_accounts">Import GnuCash accounts</string>
+    <string name="summary_delete_all_accounts">Delete all accounts in the database. All transactions will be deleted as
+        well.
+    </string>
+    <string name="title_delete_all_accounts">Delete all accounts</string>
+    <string name="header_account_settings">Accounts</string>
+    <string name="toast_all_accounts_deleted">All accounts have been successfully deleted</string>
+    <string name="confirm_delete_all_accounts">Are you sure you want to delete all accounts and transactions? \nThis
+        operation cannot be undone!
+    </string>
     <plurals name="label_sub_accounts">
         <item quantity="one">%d sub-account</item>
         <item quantity="other">%d sub-accounts</item>
diff --git a/app/res/values-es-rMX/strings.xml b/app/res/values-es-rMX/strings.xml
index ab94bf09..aa0614fb 100644
--- a/app/res/values-es-rMX/strings.xml
+++ b/app/res/values-es-rMX/strings.xml
@@ -315,6 +315,21 @@
 	</string>
 	<string name="label_dismiss">Dismiss</string>
     <string name="toast_transanction_amount_required">Enter an amount to save the transaction</string>
+    <string name="menu_import_accounts">Import GnuCash Accounts</string>
+    <string name="btn_import_accounts">Import Accounts</string>
+    <string name="toast_error_importing_accounts">An error occurred while importing the GnuCash accounts</string>
+    <string name="toast_success_importing_accounts">GnuCash accounts successfully imported</string>
+    <string name="summary_import_accounts">Import account structure exported from GnuCash desktop</string>
+    <string name="title_import_accounts">Import GnuCash accounts</string>
+    <string name="summary_delete_all_accounts">Delete all accounts in the database. All transactions will be deleted as
+        well.
+    </string>
+    <string name="title_delete_all_accounts">Delete all accounts</string>
+    <string name="header_account_settings">Accounts</string>
+    <string name="toast_all_accounts_deleted">All accounts have been successfully deleted</string>
+    <string name="confirm_delete_all_accounts">Are you sure you want to delete all accounts and transactions? \nThis
+        operation cannot be undone!
+    </string>
     <plurals name="label_sub_accounts">
         <item quantity="one">%d sub-account</item>
         <item quantity="other">%d sub-accounts</item>
diff --git a/app/res/values-es/strings.xml b/app/res/values-es/strings.xml
index bc2c76c3..fd288ecc 100644
--- a/app/res/values-es/strings.xml
+++ b/app/res/values-es/strings.xml
@@ -316,6 +316,21 @@
 	</string>
 	<string name="label_dismiss">Cerrar</string>
     <string name="toast_transanction_amount_required">Enter an amount to save the transaction</string>
+    <string name="menu_import_accounts">Import GnuCash Accounts</string>
+    <string name="btn_import_accounts">Import Accounts</string>
+    <string name="toast_error_importing_accounts">An error occurred while importing the GnuCash accounts</string>
+    <string name="toast_success_importing_accounts">GnuCash accounts successfully imported</string>
+    <string name="summary_import_accounts">Import account structure exported from GnuCash desktop</string>
+    <string name="title_import_accounts">Import GnuCash accounts</string>
+    <string name="summary_delete_all_accounts">Delete all accounts in the database. All transactions will be deleted as
+        well.
+    </string>
+    <string name="title_delete_all_accounts">Delete all accounts</string>
+    <string name="header_account_settings">Accounts</string>
+    <string name="toast_all_accounts_deleted">All accounts have been successfully deleted</string>
+    <string name="confirm_delete_all_accounts">Are you sure you want to delete all accounts and transactions? \nThis
+        operation cannot be undone!
+    </string>
     <plurals name="label_sub_accounts">
         <item quantity="one">%d sub-account</item>
         <item quantity="other">%d sub-accounts</item>
diff --git a/app/res/values-fr/strings.xml b/app/res/values-fr/strings.xml
index de0632a3..5c1841f0 100644
--- a/app/res/values-fr/strings.xml
+++ b/app/res/values-fr/strings.xml
@@ -316,6 +316,21 @@
 	</string>
 	<string name="label_dismiss">Passer</string>
     <string name="toast_transanction_amount_required">Enter an amount to save the transaction</string>
+    <string name="menu_import_accounts">Import GnuCash Accounts</string>
+    <string name="btn_import_accounts">Import Accounts</string>
+    <string name="toast_error_importing_accounts">An error occurred while importing the GnuCash accounts</string>
+    <string name="toast_success_importing_accounts">GnuCash accounts successfully imported</string>
+    <string name="summary_import_accounts">Import account structure exported from GnuCash desktop</string>
+    <string name="title_import_accounts">Import GnuCash accounts</string>
+    <string name="summary_delete_all_accounts">Delete all accounts in the database. All transactions will be deleted as
+        well.
+    </string>
+    <string name="title_delete_all_accounts">Delete all accounts</string>
+    <string name="header_account_settings">Accounts</string>
+    <string name="toast_all_accounts_deleted">All accounts have been successfully deleted</string>
+    <string name="confirm_delete_all_accounts">Are you sure you want to delete all accounts and transactions? \nThis
+        operation cannot be undone!
+    </string>
     <plurals name="label_sub_accounts">
         <item quantity="one">%d sub-account</item>
         <item quantity="other">%d sub-accounts</item>
diff --git a/app/res/values-hu/strings.xml b/app/res/values-hu/strings.xml
index 053a5d41..a66685b7 100644
--- a/app/res/values-hu/strings.xml
+++ b/app/res/values-hu/strings.xml
@@ -315,6 +315,21 @@
 	</string>
 	<string name="label_dismiss">Dismiss</string>
     <string name="toast_transanction_amount_required">Enter an amount to save the transaction</string>
+    <string name="menu_import_accounts">Import GnuCash Accounts</string>
+    <string name="btn_import_accounts">Import Accounts</string>
+    <string name="toast_error_importing_accounts">An error occurred while importing the GnuCash accounts</string>
+    <string name="toast_success_importing_accounts">GnuCash accounts successfully imported</string>
+    <string name="summary_import_accounts">Import account structure exported from GnuCash desktop</string>
+    <string name="title_import_accounts">Import GnuCash accounts</string>
+    <string name="summary_delete_all_accounts">Delete all accounts in the database. All transactions will be deleted as
+        well.
+    </string>
+    <string name="title_delete_all_accounts">Delete all accounts</string>
+    <string name="header_account_settings">Accounts</string>
+    <string name="toast_all_accounts_deleted">All accounts have been successfully deleted</string>
+    <string name="confirm_delete_all_accounts">Are you sure you want to delete all accounts and transactions? \nThis
+        operation cannot be undone!
+    </string>
     <plurals name="label_sub_accounts">
         <item quantity="one">%d sub-account</item>
         <item quantity="other">%d sub-accounts</item>
diff --git a/app/res/values-it/strings.xml b/app/res/values-it/strings.xml
index dd4a3e3f..e1ac770d 100644
--- a/app/res/values-it/strings.xml
+++ b/app/res/values-it/strings.xml
@@ -316,6 +316,21 @@
 	</string>
 	<string name="label_dismiss">Chiudi</string>
     <string name="toast_transanction_amount_required">Enter an amount to save the transaction</string>
+    <string name="menu_import_accounts">Import GnuCash Accounts</string>
+    <string name="btn_import_accounts">Import Accounts</string>
+    <string name="toast_error_importing_accounts">An error occurred while importing the GnuCash accounts</string>
+    <string name="toast_success_importing_accounts">GnuCash accounts successfully imported</string>
+    <string name="summary_import_accounts">Import account structure exported from GnuCash desktop</string>
+    <string name="title_import_accounts">Import GnuCash accounts</string>
+    <string name="summary_delete_all_accounts">Delete all accounts in the database. All transactions will be deleted as
+        well.
+    </string>
+    <string name="title_delete_all_accounts">Delete all accounts</string>
+    <string name="header_account_settings">Accounts</string>
+    <string name="toast_all_accounts_deleted">All accounts have been successfully deleted</string>
+    <string name="confirm_delete_all_accounts">Are you sure you want to delete all accounts and transactions? \nThis
+        operation cannot be undone!
+    </string>
     <plurals name="label_sub_accounts">
         <item quantity="one">%d sub-account</item>
         <item quantity="other">%d sub-accounts</item>
diff --git a/app/res/values-nb/strings.xml b/app/res/values-nb/strings.xml
index 71e844c5..21c1c8da 100644
--- a/app/res/values-nb/strings.xml
+++ b/app/res/values-nb/strings.xml
@@ -319,6 +319,21 @@ format og importeres i regnskapsprogrammet GnuCash for PC.</string>
 	</string>
 	<string name="label_dismiss">Ferdig</string>
     <string name="toast_transanction_amount_required">Enter an amount to save the transaction</string>
+    <string name="menu_import_accounts">Import GnuCash Accounts</string>
+    <string name="btn_import_accounts">Import Accounts</string>
+    <string name="toast_error_importing_accounts">An error occurred while importing the GnuCash accounts</string>
+    <string name="toast_success_importing_accounts">GnuCash accounts successfully imported</string>
+    <string name="summary_import_accounts">Import account structure exported from GnuCash desktop</string>
+    <string name="title_import_accounts">Import GnuCash accounts</string>
+    <string name="summary_delete_all_accounts">Delete all accounts in the database. All transactions will be deleted as
+        well.
+    </string>
+    <string name="title_delete_all_accounts">Delete all accounts</string>
+    <string name="header_account_settings">Accounts</string>
+    <string name="toast_all_accounts_deleted">All accounts have been successfully deleted</string>
+    <string name="confirm_delete_all_accounts">Are you sure you want to delete all accounts and transactions? \nThis
+        operation cannot be undone!
+    </string>
     <plurals name="label_sub_accounts">
         <item quantity="one">%d sub-account</item>
         <item quantity="other">%d sub-accounts</item>
diff --git a/app/res/values-nl/strings.xml b/app/res/values-nl/strings.xml
index 973ae9e9..34fbeab0 100644
--- a/app/res/values-nl/strings.xml
+++ b/app/res/values-nl/strings.xml
@@ -316,6 +316,21 @@
 	</string>
 	<string name="label_dismiss">Wijs af</string>
     <string name="toast_transanction_amount_required">Vul een bedrag in om de transactie op te slaan.</string>
+    <string name="menu_import_accounts">Import GnuCash Accounts</string>
+    <string name="btn_import_accounts">Import Accounts</string>
+    <string name="toast_error_importing_accounts">An error occurred while importing the GnuCash accounts</string>
+    <string name="toast_success_importing_accounts">GnuCash accounts successfully imported</string>
+    <string name="summary_import_accounts">Import account structure exported from GnuCash desktop</string>
+    <string name="title_import_accounts">Import GnuCash accounts</string>
+    <string name="summary_delete_all_accounts">Delete all accounts in the database. All transactions will be deleted as
+        well.
+    </string>
+    <string name="title_delete_all_accounts">Delete all accounts</string>
+    <string name="header_account_settings">Accounts</string>
+    <string name="toast_all_accounts_deleted">All accounts have been successfully deleted</string>
+    <string name="confirm_delete_all_accounts">Are you sure you want to delete all accounts and transactions? \nThis
+        operation cannot be undone!
+    </string>
     <plurals name="label_sub_accounts">
         <item quantity="one">%d sub-account</item>
         <item quantity="other">%d sub-accounts</item>
diff --git a/app/res/values-pt-rBR/strings.xml b/app/res/values-pt-rBR/strings.xml
index 334bf4e4..ed585228 100644
--- a/app/res/values-pt-rBR/strings.xml
+++ b/app/res/values-pt-rBR/strings.xml
@@ -315,6 +315,21 @@
 	  </string>
 	  <string name="label_dismiss">Descartar</string>
     <string name="toast_transanction_amount_required">Enter an amount to save the transaction</string>
+    <string name="menu_import_accounts">Import GnuCash Accounts</string>
+    <string name="btn_import_accounts">Import Accounts</string>
+    <string name="toast_error_importing_accounts">An error occurred while importing the GnuCash accounts</string>
+    <string name="toast_success_importing_accounts">GnuCash accounts successfully imported</string>
+    <string name="summary_import_accounts">Import account structure exported from GnuCash desktop</string>
+    <string name="title_import_accounts">Import GnuCash accounts</string>
+    <string name="summary_delete_all_accounts">Delete all accounts in the database. All transactions will be deleted as
+        well.
+    </string>
+    <string name="title_delete_all_accounts">Delete all accounts</string>
+    <string name="header_account_settings">Accounts</string>
+    <string name="toast_all_accounts_deleted">All accounts have been successfully deleted</string>
+    <string name="confirm_delete_all_accounts">Are you sure you want to delete all accounts and transactions? \nThis
+        operation cannot be undone!
+    </string>
     <plurals name="label_sub_accounts">
         <item quantity="one">%d sub-account</item>
         <item quantity="other">%d sub-accounts</item>
diff --git a/app/res/values-ru/strings.xml b/app/res/values-ru/strings.xml
index 83fbb9cc..23419a0e 100644
--- a/app/res/values-ru/strings.xml
+++ b/app/res/values-ru/strings.xml
@@ -316,6 +316,21 @@
 	</string>
 	<string name="label_dismiss">Dismiss</string>
     <string name="toast_transanction_amount_required">Enter an amount to save the transaction</string>
+    <string name="menu_import_accounts">Import GnuCash Accounts</string>
+    <string name="btn_import_accounts">Import Accounts</string>
+    <string name="toast_error_importing_accounts">An error occurred while importing the GnuCash accounts</string>
+    <string name="toast_success_importing_accounts">GnuCash accounts successfully imported</string>
+    <string name="summary_import_accounts">Import account structure exported from GnuCash desktop</string>
+    <string name="title_import_accounts">Import GnuCash accounts</string>
+    <string name="summary_delete_all_accounts">Delete all accounts in the database. All transactions will be deleted as
+        well.
+    </string>
+    <string name="title_delete_all_accounts">Delete all accounts</string>
+    <string name="header_account_settings">Accounts</string>
+    <string name="toast_all_accounts_deleted">All accounts have been successfully deleted</string>
+    <string name="confirm_delete_all_accounts">Are you sure you want to delete all accounts and transactions? \nThis
+        operation cannot be undone!
+    </string>
     <plurals name="label_sub_accounts">
         <item quantity="one">%d sub-account</item>
         <item quantity="other">%d sub-accounts</item>
diff --git a/app/res/values/strings.xml b/app/res/values/strings.xml
index f97c9f81..c439cd2d 100644
--- a/app/res/values/strings.xml
+++ b/app/res/values/strings.xml
@@ -509,6 +509,23 @@
 	</string>
 	<string name="label_dismiss">Dismiss</string>
     <string name="toast_transanction_amount_required">Enter an amount to save the transaction</string>
+    <string name="menu_import_accounts">Import GnuCash Accounts</string>
+    <string name="btn_import_accounts">Import Accounts</string>
+    <string name="toast_error_importing_accounts">An error occurred while importing the GnuCash accounts</string>
+    <string name="toast_success_importing_accounts">GnuCash Accounts successfully imported</string>
+    <string name="key_import_accounts">import_gnucash_accounts</string>
+    <string name="summary_import_accounts">Import account structure exported from GnuCash desktop</string>
+    <string name="title_import_accounts">Import GnuCash accounts</string>
+    <string name="key_delete_all_accounts">delete_all_accounts</string>
+    <string name="summary_delete_all_accounts">Delete all accounts in the database. All transactions will be deleted as
+        well.
+    </string>
+    <string name="title_delete_all_accounts">Delete all accounts</string>
+    <string name="header_account_settings">Accounts</string>
+    <string name="toast_all_accounts_deleted">All accounts have been successfully deleted</string>
+    <string name="confirm_delete_all_accounts">Are you sure you want to delete all accounts and transactions? \nThis
+        operation cannot be undone!
+    </string>
     <plurals name="label_sub_accounts">
         <item quantity="one">%d sub-account</item>
         <item quantity="other">%d sub-accounts</item>
diff --git a/app/res/xml/fragment_about_preferences.xml b/app/res/xml/fragment_about_preferences.xml
index fb1da8c3..de4a3b91 100644
--- a/app/res/xml/fragment_about_preferences.xml
+++ b/app/res/xml/fragment_about_preferences.xml
@@ -16,13 +16,15 @@
 -->
 
 <PreferenceScreen xmlns:android="http://schemas.android.com/apk/res/android" >
-    <Preference android:key="@string/key_about" android:summary="@string/summary_about_gnucash" android:title="@string/title_about"/><Preference android:key="@string/key_build_version" android:title="@string/title_build_version"/>
+    <Preference android:key="@string/key_about" android:summary="@string/summary_about_gnucash"
+                android:title="@string/title_about"/>
+    <Preference android:key="@string/key_build_version" android:title="@string/title_build_version"/>
     <Preference android:summary="@string/summary_licence_details" 
         android:title="@string/title_license" 
         android:key="@string/key_license">
         <intent android:action="android.intent.action.VIEW"
         	android:data="http://www.apache.org/licenses/LICENSE-2.0.html" />
-	</Preference>
+	</Preference>
         
 
 </PreferenceScreen>
\ No newline at end of file
diff --git a/app/res/xml/fragment_account_preferences.xml b/app/res/xml/fragment_account_preferences.xml
new file mode 100644
index 00000000..90171fb1
--- /dev/null
+++ b/app/res/xml/fragment_account_preferences.xml
@@ -0,0 +1,10 @@
+<?xml version="1.0" encoding="utf-8"?>
+
+<PreferenceScreen xmlns:android="http://schemas.android.com/apk/res/android">
+    <Preference android:key="@string/key_import_accounts"
+                android:summary="@string/summary_import_accounts"
+                android:title="@string/title_import_accounts" />
+    <Preference android:key="@string/key_delete_all_accounts"
+                android:summary="@string/summary_delete_all_accounts"
+                android:title="@string/title_delete_all_accounts" />
+</PreferenceScreen>
\ No newline at end of file
diff --git a/app/res/xml/preference_headers.xml b/app/res/xml/preference_headers.xml
index fc86f506..60292ac7 100644
--- a/app/res/xml/preference_headers.xml
+++ b/app/res/xml/preference_headers.xml
@@ -16,7 +16,9 @@
 -->
 <preference-headers xmlns:android="http://schemas.android.com/apk/res/android">
     <header android:fragment="org.gnucash.android.ui.settings.GeneralPreferenceFragment"        
-        android:title="@string/header_general_settings" />    
+        android:title="@string/header_general_settings" />
+    <header android:fragment="org.gnucash.android.ui.settings.AccountPreferencesFragment"
+            android:title="@string/header_account_settings" />
     <header android:fragment="org.gnucash.android.ui.settings.TransactionsPreferenceFragment" 
         android:title="@string/header_transaction_settings" />
     <header android:fragment="org.gnucash.android.ui.settings.AboutPreferenceFragment"
diff --git a/app/src/org/gnucash/android/data/Account.java b/app/src/org/gnucash/android/data/Account.java
index c3ad8361..cb742040 100644
--- a/app/src/org/gnucash/android/data/Account.java
+++ b/app/src/org/gnucash/android/data/Account.java
@@ -52,8 +52,11 @@
 	 * they are currently not used except for exporting
 	 */
 	public enum AccountType {CASH, BANK, CREDIT_CARD, ASSET, LIABILITY, INCOME, EXPENSE, 
-							PAYABLE, RECEIVABLE, EQUITY, CURRENCY, STOCK, MUTUAL_FUND};
-	
+							PAYABLE, RECEIVABLE, EQUITY, CURRENCY, STOCK, MUTUAL_FUND, ROOT};
+
+    /**
+     * Accounts types which are used by the OFX standard
+     */
 	public enum OfxAccountType {CHECKING, SAVINGS, MONEYMRKT, CREDITLINE };
 		
 	/**
diff --git a/app/src/org/gnucash/android/db/AccountsDbAdapter.java b/app/src/org/gnucash/android/db/AccountsDbAdapter.java
index 3d22fd15..d9128fe9 100644
--- a/app/src/org/gnucash/android/db/AccountsDbAdapter.java
+++ b/app/src/org/gnucash/android/db/AccountsDbAdapter.java
@@ -316,8 +316,9 @@ public String getName(long accountID) {
     @Override
 	public Cursor fetchAllRecords(){
 		Log.v(TAG, "Fetching all accounts from db");
+        String selection =  DatabaseHelper.KEY_TYPE + " != " + "'ROOT'";
 		Cursor cursor = mDb.query(DatabaseHelper.ACCOUNTS_TABLE_NAME,
-                null, null, null, null, null,
+                null, selection, null, null, null,
                 DatabaseHelper.KEY_NAME + " ASC");
 		return cursor;
 	}
@@ -366,7 +367,12 @@ public Money getAccountBalance(long accountId){
         Money balance = Money.createInstance(getCurrencyCode(accountId));
         for (long id : subAccounts){
             //recurse because arbitrary nesting depth is allowed
-            balance = balance.add(getAccountBalance(id));
+            Money subBalance = getAccountBalance(id);
+            if (subBalance.getCurrency().equals(balance.getCurrency())){
+                //only add the balances if they are of the same currency
+                //ignore sub accounts of different currency just like GnuCash desktop does
+                balance = balance.add(getAccountBalance(id));
+            }
         }
         return balance.add(mTransactionsAdapter.getTransactionsSum(accountId));
     }
diff --git a/app/src/org/gnucash/android/ui/accounts/AccountsActivity.java b/app/src/org/gnucash/android/ui/accounts/AccountsActivity.java
index ff288188..b52f363d 100644
--- a/app/src/org/gnucash/android/ui/accounts/AccountsActivity.java
+++ b/app/src/org/gnucash/android/ui/accounts/AccountsActivity.java
@@ -16,19 +16,6 @@
 
 package org.gnucash.android.ui.accounts;
 
-import java.util.ArrayList;
-import java.util.Currency;
-import java.util.Locale;
-
-import org.gnucash.android.R;
-import org.gnucash.android.data.Account;
-import org.gnucash.android.data.Money;
-import org.gnucash.android.data.Account.AccountType;
-import org.gnucash.android.db.AccountsDbAdapter;
-import org.gnucash.android.ui.transactions.TransactionsActivity;
-import org.gnucash.android.ui.transactions.TransactionsListFragment;
-import org.gnucash.android.util.OnAccountClickedListener;
-
 import android.app.AlertDialog;
 import android.content.DialogInterface;
 import android.content.Intent;
@@ -43,11 +30,25 @@
 import android.support.v4.app.FragmentTransaction;
 import android.util.Log;
 import android.view.View;
-
+import android.widget.Toast;
 import com.actionbarsherlock.app.SherlockFragmentActivity;
 import com.actionbarsherlock.view.Menu;
 import com.actionbarsherlock.view.MenuInflater;
 import com.actionbarsherlock.view.MenuItem;
+import org.gnucash.android.R;
+import org.gnucash.android.data.Account;
+import org.gnucash.android.data.Account.AccountType;
+import org.gnucash.android.data.Money;
+import org.gnucash.android.db.AccountsDbAdapter;
+import org.gnucash.android.ui.transactions.TransactionsActivity;
+import org.gnucash.android.ui.transactions.TransactionsListFragment;
+import org.gnucash.android.util.GnucashAccountXmlHandler;
+import org.gnucash.android.util.OnAccountClickedListener;
+
+import java.io.FileNotFoundException;
+import java.util.ArrayList;
+import java.util.Currency;
+import java.util.Locale;
 
 /**
  * Manages actions related to accounts, displaying, exporting and creating new accounts
@@ -292,16 +293,54 @@ public void onClick(DialogInterface dialog, int which) {
 				removeFirstRunFlag();
 			}
 		});
+
+        builder.setNeutralButton(R.string.btn_import_accounts, new DialogInterface.OnClickListener() {
+            @Override
+            public void onClick(DialogInterface dialogInterface, int i) {
+                importAccounts();
+                removeFirstRunFlag();
+            }
+        });
+
 		mDefaultAccountsDialog = builder.create();
 		mDefaultAccountsDialog.show();		
 	}
-		
-	@Override
+
+    public void importAccounts() {
+        Intent pickIntent = new Intent(Intent.ACTION_GET_CONTENT);
+        pickIntent.setType("application/octet-stream");
+        Intent chooser = Intent.createChooser(pickIntent, "Select GnuCash account file");
+
+        startActivityForResult(chooser, AccountsListFragment.REQUEST_PICK_ACCOUNTS_FILE);
+
+    }
+
+    @Override
+    protected void onActivityResult(int requestCode, int resultCode, Intent data) {
+        super.onActivityResult(requestCode, resultCode, data);
+        if (resultCode == RESULT_CANCELED){
+            return;
+        }
+
+        switch (requestCode){
+            case AccountsListFragment.REQUEST_PICK_ACCOUNTS_FILE:
+                try {
+                    GnucashAccountXmlHandler.parse(this, getContentResolver().openInputStream(data.getData()));
+                    Toast.makeText(this, R.string.toast_success_importing_accounts, Toast.LENGTH_LONG).show();
+                } catch (FileNotFoundException e) {
+                    Toast.makeText(this, R.string.toast_error_importing_accounts, Toast.LENGTH_LONG).show();
+                    e.printStackTrace();
+                }
+                break;
+        }
+    }
+
+    @Override
 	public void accountSelected(long accountRowId) {
 		Intent intent = new Intent(this, TransactionsActivity.class);
 		intent.setAction(Intent.ACTION_VIEW);
 		intent.putExtra(TransactionsListFragment.SELECTED_ACCOUNT_ID, accountRowId);
-		
+
 		startActivity(intent);
 	}
 	
diff --git a/app/src/org/gnucash/android/ui/accounts/AccountsListFragment.java b/app/src/org/gnucash/android/ui/accounts/AccountsListFragment.java
index 9b8269c7..b4bc1d38 100644
--- a/app/src/org/gnucash/android/ui/accounts/AccountsListFragment.java
+++ b/app/src/org/gnucash/android/ui/accounts/AccountsListFragment.java
@@ -16,29 +16,15 @@
 
 package org.gnucash.android.ui.accounts;
 
-import java.util.Locale;
-
-import org.gnucash.android.R;
-import org.gnucash.android.data.Account;
-import org.gnucash.android.data.Money;
-import org.gnucash.android.db.AccountsDbAdapter;
-import org.gnucash.android.db.DatabaseAdapter;
-import org.gnucash.android.db.DatabaseCursorLoader;
-import org.gnucash.android.db.DatabaseHelper;
-import org.gnucash.android.db.TransactionsDbAdapter;
-import org.gnucash.android.ui.settings.SettingsActivity;
-import org.gnucash.android.ui.transactions.TransactionsActivity;
-import org.gnucash.android.ui.transactions.TransactionsListFragment;
-import org.gnucash.android.ui.widget.WidgetConfigurationActivity;
-import org.gnucash.android.util.OnAccountClickedListener;
-
 import android.app.Activity;
 import android.app.AlertDialog;
 import android.app.Dialog;
+import android.content.ContentResolver;
 import android.content.Context;
 import android.content.DialogInterface;
 import android.content.Intent;
 import android.database.Cursor;
+import android.os.Build;
 import android.os.Bundle;
 import android.support.v4.app.DialogFragment;
 import android.support.v4.app.Fragment;
@@ -51,14 +37,8 @@
 import android.view.LayoutInflater;
 import android.view.View;
 import android.view.ViewGroup;
-import android.widget.AdapterView;
+import android.widget.*;
 import android.widget.AdapterView.OnItemLongClickListener;
-import android.widget.ImageView;
-import android.widget.ListAdapter;
-import android.widget.ListView;
-import android.widget.TextView;
-import android.widget.Toast;
-
 import com.actionbarsherlock.app.ActionBar;
 import com.actionbarsherlock.app.SherlockDialogFragment;
 import com.actionbarsherlock.app.SherlockListFragment;
@@ -67,111 +47,418 @@
 import com.actionbarsherlock.view.Menu;
 import com.actionbarsherlock.view.MenuInflater;
 import com.actionbarsherlock.view.MenuItem;
+import org.gnucash.android.R;
+import org.gnucash.android.data.Account;
+import org.gnucash.android.data.Money;
+import org.gnucash.android.db.*;
+import org.gnucash.android.ui.settings.SettingsActivity;
+import org.gnucash.android.ui.transactions.TransactionsActivity;
+import org.gnucash.android.ui.transactions.TransactionsListFragment;
+import org.gnucash.android.ui.widget.WidgetConfigurationActivity;
+import org.gnucash.android.util.GnucashAccountXmlHandler;
+import org.gnucash.android.util.OnAccountClickedListener;
+
+import java.io.File;
+import java.io.FileNotFoundException;
+import java.util.Locale;
 
 /**
  * Fragment for displaying the list of accounts in the database
- * @author Ngewi Fet <ngewif@gmail.com>
  *
+ * @author Ngewi Fet <ngewif@gmail.com>
  */
 public class AccountsListFragment extends SherlockListFragment implements
-		LoaderCallbacks<Cursor>, OnItemLongClickListener {
-	
-	/**
-	 * Logging tag
-	 */
-	protected static final String TAG = "AccountsListFragment";
-	
-	/**
-	 * {@link ListAdapter} for the accounts which will be bound to the list
-	 */
-	AccountsCursorAdapter mAccountsCursorAdapter;
-	
-	/**
-	 * Database adapter for loading Account records from the database
-	 */
-	private AccountsDbAdapter mAccountsDbAdapter;	
-	
-	/**
-	 * Listener to be notified when an account is clicked
-	 */
-	private OnAccountClickedListener mAccountSelectedListener;
-	
-	/**
-	 * Flag to indicate if the fragment is in edit mode
-	 * Edit mode means an account has been selected (through long press) and the 
-	 * context action bar (CAB) is activated
-	 */
-	private boolean mInEditMode = false;
-	
-	/**
-	 * Android action mode 
-	 * Is not null only when an accoun is selected and the Context ActionBar (CAB) is activated
-	 */
-	private ActionMode mActionMode = null;
-	
-	/**
-	 * Position which has been selected in the ListView
-	 */
-	private int mSelectedViewPosition = -1;
-	
-	/**
-	 * Stores the database ID of the currently selected account when in action mode.
-	 * This is necessary because getSelectedItemId() does not work properly (by design) 
-	 * in touch mode (which is the majority of devices today)
-	 */
-	private long mSelectedItemId = -1;
-	
-	/**
-	 * Callbacks for the CAB menu
-	 */
-	private ActionMode.Callback mActionModeCallbacks = new Callback() {
-		
-		@Override
-		public boolean onCreateActionMode(ActionMode mode, Menu menu) {
-			MenuInflater inflater = mode.getMenuInflater();
-	        inflater.inflate(R.menu.account_context_menu, menu);
-	        mode.setTitle(getString(R.string.title_selected, 1));
-	        return true;
-		}
+        LoaderCallbacks<Cursor>, OnItemLongClickListener {
 
-		@Override
-		public boolean onPrepareActionMode(ActionMode mode, Menu menu) {
-			// nothing to see here, move along
-			return false;
-		}
+    /**
+     * Logging tag
+     */
+    protected static final String TAG = "AccountsListFragment";
+    public static final int REQUEST_PICK_ACCOUNTS_FILE = 0x1;
 
-		@Override
-		public boolean onActionItemClicked(ActionMode mode, MenuItem item) {
-			switch (item.getItemId()) {
-			case R.id.context_menu_edit_accounts:				
-				showAddAccountFragment(mSelectedItemId);
-				mode.finish();
-				return true;
-
-			case R.id.context_menu_delete:
-				tryDeleteAccount(mSelectedItemId);
-				mode.finish();
-				return true;
-				
-			default:
-				return false;
-			}
-		}
 
-		@Override
-		public void onDestroyActionMode(ActionMode mode) {
-			finishEditMode();
+    /**
+     * Menu item ID for import accounts action
+     */
+    public static final int MENU_IMPORT_ACCOUNTS = 0x11;
+
+    /**
+     * {@link ListAdapter} for the accounts which will be bound to the list
+     */
+    AccountsCursorAdapter mAccountsCursorAdapter;
+    /**
+     * Database adapter for loading Account records from the database
+     */
+    private AccountsDbAdapter mAccountsDbAdapter;
+    /**
+     * Listener to be notified when an account is clicked
+     */
+    private OnAccountClickedListener mAccountSelectedListener;
+    /**
+     * Flag to indicate if the fragment is in edit mode
+     * Edit mode means an account has been selected (through long press) and the
+     * context action bar (CAB) is activated
+     */
+    private boolean mInEditMode = false;
+    /**
+     * Android action mode
+     * Is not null only when an accoun is selected and the Context ActionBar (CAB) is activated
+     */
+    private ActionMode mActionMode = null;
+    /**
+     * Position which has been selected in the ListView
+     */
+    private int mSelectedViewPosition = -1;
+    /**
+     * Stores the database ID of the currently selected account when in action mode.
+     * This is necessary because getSelectedItemId() does not work properly (by design)
+     * in touch mode (which is the majority of devices today)
+     */
+    private long mSelectedItemId = -1;
+    /**
+     * Callbacks for the CAB menu
+     */
+    private ActionMode.Callback mActionModeCallbacks = new Callback() {
+
+        @Override
+        public boolean onCreateActionMode(ActionMode mode, Menu menu) {
+            MenuInflater inflater = mode.getMenuInflater();
+            inflater.inflate(R.menu.account_context_menu, menu);
+            mode.setTitle(getString(R.string.title_selected, 1));
+            return true;
+        }
+
+        @Override
+        public boolean onPrepareActionMode(ActionMode mode, Menu menu) {
+            // nothing to see here, move along
+            return false;
+        }
+
+        @Override
+        public boolean onActionItemClicked(ActionMode mode, MenuItem item) {
+            switch (item.getItemId()) {
+                case R.id.context_menu_edit_accounts:
+                    showAddAccountFragment(mSelectedItemId);
+                    mode.finish();
+                    return true;
+
+                case R.id.context_menu_delete:
+                    tryDeleteAccount(mSelectedItemId);
+                    mode.finish();
+                    return true;
+
+                default:
+                    return false;
+            }
+        }
+
+        @Override
+        public void onDestroyActionMode(ActionMode mode) {
+            finishEditMode();
+        }
+    };
+
+    @Override
+    public View onCreateView(LayoutInflater inflater, ViewGroup container,
+                             Bundle savedInstanceState) {
+        View v = inflater.inflate(R.layout.fragment_accounts_list, container,
+                false);
+        TextView sumlabelTextView = (TextView) v.findViewById(R.id.label_sum);
+        sumlabelTextView.setText(R.string.account_balance);
+        return v;
+    }
+
+    @Override
+    public void onCreate(Bundle savedInstanceState) {
+        super.onCreate(savedInstanceState);
+        mAccountsDbAdapter = new AccountsDbAdapter(getActivity());
+        mAccountsCursorAdapter = new AccountsCursorAdapter(
+                getActivity().getApplicationContext(),
+                R.layout.list_item_account, null,
+                new String[]{DatabaseHelper.KEY_NAME},
+                new int[]{R.id.primary_text});
+
+        setListAdapter(mAccountsCursorAdapter);
+    }
+
+    @Override
+    public void onActivityCreated(Bundle savedInstanceState) {
+        super.onActivityCreated(savedInstanceState);
+
+        ActionBar actionbar = getSherlockActivity().getSupportActionBar();
+        actionbar.setTitle(R.string.title_accounts);
+        actionbar.setDisplayHomeAsUpEnabled(false);
+
+        setHasOptionsMenu(true);
+
+        ListView lv = getListView();
+        lv.setOnItemLongClickListener(this);
+        getLoaderManager().initLoader(0, null, this);
+    }
+
+    @Override
+    public void onResume() {
+        super.onResume();
+        refreshList();
+    }
+
+    @Override
+    public void onAttach(Activity activity) {
+        super.onAttach(activity);
+        try {
+            mAccountSelectedListener = (OnAccountClickedListener) activity;
+        } catch (ClassCastException e) {
+            throw new ClassCastException(activity.toString() + " must implement OnAccountSelectedListener");
+        }
+    }
+
+    @Override
+    public void onListItemClick(ListView l, View v, int position, long id) {
+        super.onListItemClick(l, v, position, id);
+        if (mInEditMode) {
+            mSelectedItemId = id;
+            selectItem(position);
+            return;
+        }
+        mAccountSelectedListener.accountSelected(id);
+    }
+
+    @Override
+    public boolean onItemLongClick(AdapterView<?> parent, View view, int position,
+                                   long id) {
+        if (mActionMode != null) {
+            return false;
+        }
+        mInEditMode = true;
+        mSelectedItemId = id;
+        // Start the CAB using the ActionMode.Callback defined above
+        mActionMode = getSherlockActivity().startActionMode(
+                mActionModeCallbacks);
+
+        selectItem(position);
+        return true;
+    }
+
+    /**
+     * Delete the account with record ID <code>rowId</code>
+     * It shows the delete confirmation dialog if the account has transactions,
+     * else deletes the account immediately
+     *
+     * @param rowId The record ID of the account
+     */
+    public void tryDeleteAccount(long rowId) {
+        Account acc = mAccountsDbAdapter.getAccount(rowId);
+        if (acc.getTransactionCount() > 0) {
+            showConfirmationDialog(rowId);
+        } else {
+            deleteAccount(rowId);
+        }
+    }
+
+    /**
+     * Deletes an account and show a {@link Toast} notification on success
+     *
+     * @param rowId Record ID of the account to be deleted
+     */
+    protected void deleteAccount(long rowId) {
+        boolean deleted = mAccountsDbAdapter.destructiveDeleteAccount(rowId);
+        if (deleted) {
+            Toast.makeText(getActivity(), R.string.toast_account_deleted, Toast.LENGTH_SHORT).show();
+            WidgetConfigurationActivity.updateAllWidgets(getActivity().getApplicationContext());
+        }
+        refreshList();
+    }
+
+    /**
+     * Shows the delete confirmation dialog
+     *
+     * @param id Record ID of account to be deleted after confirmation
+     */
+    public void showConfirmationDialog(long id) {
+        DeleteConfirmationDialogFragment alertFragment = DeleteConfirmationDialogFragment.newInstance(R.string.title_confirm_delete, id);
+        alertFragment.setTargetFragment(this, 0);
+        alertFragment.show(getSherlockActivity().getSupportFragmentManager(), "dialog");
+    }
+
+    /**
+     * Finish the edit mode and dismisses the Contextual ActionBar
+     * Any selected (highlighted) accounts are deselected
+     */
+    public void finishEditMode() {
+        mInEditMode = false;
+        deselectPreviousSelectedItem();
+        mActionMode = null;
+        mSelectedItemId = -1;
+    }
+
+    /**
+     * Highlights the item at <code>position</code> in the ListView.
+     * Android has facilities for managing list selection but the highlighting
+     * is not reliable when using the ActionBar on pre-Honeycomb devices-
+     *
+     * @param position Position of item to be highlighted
+     */
+    private void selectItem(int position) {
+        deselectPreviousSelectedItem();
+        ListView lv = getListView();
+        lv.setItemChecked(position, true);
+        View v = lv.getChildAt(position - lv.getFirstVisiblePosition());
+        v.setSelected(true);
+        v.setBackgroundColor(getResources().getColor(R.color.abs__holo_blue_light));
+        mSelectedViewPosition = position;
+    }
+
+    /**
+     * De-selects the previously selected item in a ListView.
+     * Only one account entry can be highlighted at a time, so the previously selected
+     * one is deselected.
+     */
+    private void deselectPreviousSelectedItem() {
+        if (mSelectedViewPosition >= 0) {
+            ListView lv = getListView();
+            lv.setItemChecked(mSelectedViewPosition, false);
+            View v = getListView().getChildAt(mSelectedViewPosition - lv.getFirstVisiblePosition());
+            if (v == null) {
+                //if we just deleted a row, then the previous position is invalid
+                return;
+            }
+            v.setBackgroundColor(getResources().getColor(android.R.color.transparent));
+            v.setSelected(false);
+        }
+    }
+
+    @Override
+    public void onCreateOptionsMenu(Menu menu, MenuInflater inflater) {
+        inflater.inflate(R.menu.account_actions, menu);
+        if (Build.VERSION.SDK_INT < Build.VERSION_CODES.HONEYCOMB){
+            MenuItem item = menu.add(0, MENU_IMPORT_ACCOUNTS, 0, R.string.menu_import_accounts);
+            item.setShowAsActionFlags(MenuItem.SHOW_AS_ACTION_NEVER);
+        }
+    }
+
+    @Override
+    public boolean onOptionsItemSelected(MenuItem item) {
+        switch (item.getItemId()) {
+
+            case R.id.menu_add_account:
+                showAddAccountFragment(0);
+                return true;
+
+            case MENU_IMPORT_ACCOUNTS:
+                ((AccountsActivity)getActivity()).importAccounts();
+                return true;
+
+            case R.id.menu_export:
+                showExportDialog();
+                return true;
+
+            case R.id.menu_settings:
+                startActivity(new Intent(getActivity(), SettingsActivity.class));
+                return true;
+
+            default:
+                return false;
+        }
+    }
+
+    /**
+     * Refreshes the list by restarting the {@link DatabaseCursorLoader} associated
+     * with the ListView
+     */
+    public void refreshList() {
+        getLoaderManager().restartLoader(0, null, this);
+
+/*
+        //TODO: Figure out a way to display account balances per currency
+		boolean doubleEntryActive = PreferenceManager.getDefaultSharedPreferences(getActivity())
+				.getBoolean(getString(R.string.key_use_double_entry), false);
+
+		TextView tv = (TextView) getView().findViewById(R.id.transactions_sum);
+		Money balance = null;
+		if (doubleEntryActive){
+			balance = mAccountsDbAdapter.getDoubleEntryAccountsBalance();
+		} else {
+			balance = mAccountsDbAdapter.getAllAccountsBalance();
 		}
-	};
+		tv.setText(balance.formattedString(Locale.getDefault()));
+		if (balance.isNegative())
+			tv.setTextColor(getResources().getColor(R.color.debit_red));
+		else
+			tv.setTextColor(getResources().getColor(R.color.credit_green));
+*/
+    }
+
+    /**
+     * Closes any open database adapters used by the list
+     */
+    @Override
+    public void onDestroy() {
+        super.onDestroy();
+        mAccountsDbAdapter.close();
+        mAccountsCursorAdapter.close();
+    }
+
+    public void showAddAccountFragment(long accountId) {
+        FragmentManager fragmentManager = getSherlockActivity().getSupportFragmentManager();
+        FragmentTransaction fragmentTransaction = fragmentManager
+                .beginTransaction();
+
+        Bundle args = new Bundle();
+        args.putLong(TransactionsListFragment.SELECTED_ACCOUNT_ID, accountId);
+        AddAccountFragment newAccountFragment = AddAccountFragment.newInstance(mAccountsDbAdapter);
+        newAccountFragment.setArguments(args);
+
+        fragmentTransaction.replace(R.id.fragment_container,
+                newAccountFragment, AccountsActivity.FRAGMENT_NEW_ACCOUNT);
 
-	/**
-	 * Delete confirmation dialog
-	 * Is displayed when deleting an account which has transactions. 
-	 * If an account has no transactions, it is deleted immediately with no confirmation required
-	 * @author Ngewi Fet <ngewif@gmail.com>
-	 *
-	 */
-	public static class DeleteConfirmationDialogFragment extends SherlockDialogFragment {
+        fragmentTransaction.addToBackStack(null);
+        fragmentTransaction.commit();
+    }
+
+    /**
+     * Displays the dialog for exporting transactions in OFX
+     */
+    public void showExportDialog() {
+        FragmentManager manager = getSherlockActivity().getSupportFragmentManager();
+        FragmentTransaction ft = manager.beginTransaction();
+        Fragment prev = manager.findFragmentByTag(AccountsActivity.FRAGMENT_EXPORT_OFX);
+        if (prev != null) {
+            ft.remove(prev);
+        }
+        ft.addToBackStack(null);
+
+        // Create and show the dialog.
+        DialogFragment exportFragment = new ExportDialogFragment();
+        exportFragment.show(ft, AccountsActivity.FRAGMENT_EXPORT_OFX);
+    }
+
+    @Override
+    public Loader<Cursor> onCreateLoader(int id, Bundle args) {
+        Log.d(TAG, "Creating the accounts loader");
+        return new AccountsCursorLoader(this.getActivity().getApplicationContext());
+    }
+
+    @Override
+    public void onLoadFinished(Loader<Cursor> loaderCursor, Cursor cursor) {
+        Log.d(TAG, "Accounts loader finished. Swapping in cursor");
+        mAccountsCursorAdapter.swapCursor(cursor);
+        mAccountsCursorAdapter.notifyDataSetChanged();
+    }
+
+    @Override
+    public void onLoaderReset(Loader<Cursor> arg0) {
+        Log.d(TAG, "Resetting the accounts loader");
+        mAccountsCursorAdapter.swapCursor(null);
+    }
+
+    /**
+     * Delete confirmation dialog
+     * Is displayed when deleting an account which has transactions.
+     * If an account has no transactions, it is deleted immediately with no confirmation required
+     *
+     * @author Ngewi Fet <ngewif@gmail.com>
+     */
+    public static class DeleteConfirmationDialogFragment extends SherlockDialogFragment {
 
         public static DeleteConfirmationDialogFragment newInstance(int title, long id) {
             DeleteConfirmationDialogFragment frag = new DeleteConfirmationDialogFragment();
@@ -186,385 +473,113 @@ public static DeleteConfirmationDialogFragment newInstance(int title, long id) {
         public Dialog onCreateDialog(Bundle savedInstanceState) {
             int title = getArguments().getInt("title");
             final long rowId = getArguments().getLong(TransactionsListFragment.SELECTED_ACCOUNT_ID);
-            
+
             return new AlertDialog.Builder(getActivity())
                     .setIcon(android.R.drawable.ic_delete)
                     .setTitle(title).setMessage(R.string.delete_account_confirmation_message)
                     .setPositiveButton(R.string.alert_dialog_ok_delete,
-                        new DialogInterface.OnClickListener() {
-                            public void onClick(DialogInterface dialog, int whichButton) {
-                                ((AccountsListFragment) getTargetFragment()).deleteAccount(rowId);
+                            new DialogInterface.OnClickListener() {
+                                public void onClick(DialogInterface dialog, int whichButton) {
+                                    Context context = getDialog().getContext();
+                                    if (rowId < 0) {
+                                        AccountsDbAdapter accountsDbAdapter = new AccountsDbAdapter(context);
+                                        accountsDbAdapter.deleteAllRecords();
+                                        accountsDbAdapter.close();
+                                        Toast.makeText(context, R.string.toast_all_accounts_deleted, Toast.LENGTH_SHORT).show();
+                                    } else
+                                        ((AccountsListFragment) getTargetFragment()).deleteAccount(rowId);
+                                }
                             }
-                        }
                     )
                     .setNegativeButton(R.string.alert_dialog_cancel,
-                        new DialogInterface.OnClickListener() {
-                            public void onClick(DialogInterface dialog, int whichButton) {
-                            	dismiss();
+                            new DialogInterface.OnClickListener() {
+                                public void onClick(DialogInterface dialog, int whichButton) {
+                                    dismiss();
+                                }
                             }
-                        }
                     )
                     .create();
         }
     }
-	
-	@Override
-	public View onCreateView(LayoutInflater inflater, ViewGroup container,
-			Bundle savedInstanceState) {
-		View v = inflater.inflate(R.layout.fragment_accounts_list, container,
-				false);
-		TextView sumlabelTextView = (TextView) v.findViewById(R.id.label_sum);		
-		sumlabelTextView.setText(R.string.account_balance);
-		return v;
-	}
-	
-	@Override
-	public void onCreate(Bundle savedInstanceState) {
-		super.onCreate(savedInstanceState);
-		mAccountsDbAdapter = new AccountsDbAdapter(getActivity());
-		mAccountsCursorAdapter = new AccountsCursorAdapter(
-				getActivity().getApplicationContext(), 
-				R.layout.list_item_account, null,
-				new String[] { DatabaseHelper.KEY_NAME },
-				new int[] { R.id.primary_text });
-						
-		setListAdapter(mAccountsCursorAdapter);
-	}
-	
-	@Override
-	public void onActivityCreated(Bundle savedInstanceState) {
-		super.onActivityCreated(savedInstanceState);
-		
-		ActionBar actionbar = getSherlockActivity().getSupportActionBar();
-		actionbar.setTitle(R.string.title_accounts);
-		actionbar.setDisplayHomeAsUpEnabled(false);
-		
-		setHasOptionsMenu(true);
-				
-		ListView lv = getListView();
-		lv.setOnItemLongClickListener(this);	
-		getLoaderManager().initLoader(0, null, this);		
-	}
-	
-	@Override
-	public void onResume() {	
-		super.onResume();
-		refreshList();
-	}
-	
-	@Override
-	public void onAttach(Activity activity) {
-		super.onAttach(activity);
-		try {
-			mAccountSelectedListener = (OnAccountClickedListener) activity;
-		} catch (ClassCastException e) {
-			throw new ClassCastException(activity.toString() + " must implement OnAccountSelectedListener");
-		}	
-	}
-	
-	@Override
-	public void onListItemClick(ListView l, View v, int position, long id) {
-		super.onListItemClick(l, v, position, id);
-		if (mInEditMode){
-			mSelectedItemId = id;
-			selectItem(position);
-			return;
-		}
-		mAccountSelectedListener.accountSelected(id);
-	}	
-	
-	@Override
-	public boolean onItemLongClick(AdapterView<?> parent, View view, int position,
-			long id) {
-		if (mActionMode != null) {
-			return false;
-		}
-		mInEditMode = true;
-		mSelectedItemId = id;
-		// Start the CAB using the ActionMode.Callback defined above
-		mActionMode = getSherlockActivity().startActionMode(
-				mActionModeCallbacks);
-
-		selectItem(position);
-		return true;
-	}
-
-	/**
-	 * Delete the account with record ID <code>rowId</code>
-	 * It shows the delete confirmation dialog if the account has transactions,
-	 * else deletes the account immediately
-	 * @param rowId The record ID of the account
-	 */
-	public void tryDeleteAccount(long rowId){
-		Account acc = mAccountsDbAdapter.getAccount(rowId);
-		if (acc.getTransactionCount() > 0){
-			showConfirmationDialog(rowId);
-		} else {
-			deleteAccount(rowId);
-		}
-	}
-	
-	/**
-	 * Deletes an account and show a {@link Toast} notification on success
-	 * @param rowId Record ID of the account to be deleted
-	 */
-	protected void deleteAccount(long rowId){		
-		boolean deleted = mAccountsDbAdapter.destructiveDeleteAccount(rowId);
-		if (deleted){
-			Toast.makeText(getActivity(), R.string.toast_account_deleted, Toast.LENGTH_SHORT).show();
-			WidgetConfigurationActivity.updateAllWidgets(getActivity().getApplicationContext());
-		}
-		refreshList();	
-	}
-
-	/**
-	 * Shows the delete confirmation dialog
-	 * @param id Record ID of account to be deleted after confirmation
-	 */
-	public void showConfirmationDialog(long id){
-		DeleteConfirmationDialogFragment alertFragment = DeleteConfirmationDialogFragment.newInstance(R.string.title_confirm_delete, id);
-		alertFragment.setTargetFragment(this, 0);
-		alertFragment.show(getSherlockActivity().getSupportFragmentManager(), "dialog");
-	}
-	
-	/**
-	 * Finish the edit mode and dismisses the Contextual ActionBar
-	 * Any selected (highlighted) accounts are deselected
-	 */
-	public void finishEditMode(){
-		mInEditMode = false;
-		deselectPreviousSelectedItem();
-		mActionMode = null;
-		mSelectedItemId = -1;
-	}
-	
-	/**
-	 * Highlights the item at <code>position</code> in the ListView.
-	 * Android has facilities for managing list selection but the highlighting 
-	 * is not reliable when using the ActionBar on pre-Honeycomb devices-
-	 * @param position Position of item to be highlighted
-	 */
-	private void selectItem(int position){
-		deselectPreviousSelectedItem();		
-		ListView lv = getListView();	
-		lv.setItemChecked(position, true);
-		View v = lv.getChildAt(position - lv.getFirstVisiblePosition());
-		v.setSelected(true);
-        v.setBackgroundColor(getResources().getColor(R.color.abs__holo_blue_light));
-        mSelectedViewPosition = position;
-	}
-	
-	/**
-	 * De-selects the previously selected item in a ListView.
-	 * Only one account entry can be highlighted at a time, so the previously selected
-	 * one is deselected. 
-	 */
-	private void deselectPreviousSelectedItem(){
-		if (mSelectedViewPosition >= 0){
-			ListView lv = getListView();
-			lv.setItemChecked(mSelectedViewPosition, false);
-			View v = getListView().getChildAt(mSelectedViewPosition - lv.getFirstVisiblePosition());
-			if (v == null){
-				//if we just deleted a row, then the previous position is invalid
-				return;
-			}
-			v.setBackgroundColor(getResources().getColor(android.R.color.transparent));
-			v.setSelected(false);
-		}
-	}
-	
-	@Override
-	public void onCreateOptionsMenu(Menu menu, MenuInflater inflater) {
-		inflater.inflate(R.menu.account_actions, menu);
-	}
-
-	@Override
-	public boolean onOptionsItemSelected(MenuItem item) {
-		switch (item.getItemId()) {
-
-		case R.id.menu_add_account:
-			showAddAccountFragment(0);
-			return true;
-
-		case R.id.menu_export:
-			showExportDialog();
-			return true;
-			
-		case R.id.menu_settings:
-			startActivity(new Intent(getActivity(), SettingsActivity.class));
-			return true;
-			
-		default:
-			return false;
-		}
-	}
-	
-	/**
-	 * Refreshes the list by restarting the {@link DatabaseCursorLoader} associated
-	 * with the ListView
-	 */
-	public void refreshList(){
-		getLoaderManager().restartLoader(0, null, this);
-				
-/*
-		//TODO: Figure out a way to display account balances
-		boolean doubleEntryActive = PreferenceManager.getDefaultSharedPreferences(getActivity())
-				.getBoolean(getString(R.string.key_use_double_entry), false);
-		
-		TextView tv = (TextView) getView().findViewById(R.id.transactions_sum);	
-		Money balance = null; 
-		if (doubleEntryActive){
-			balance = mAccountsDbAdapter.getDoubleEntryAccountsBalance();
-		} else {
-			balance = mAccountsDbAdapter.getAllAccountsBalance();
-		}
-		tv.setText(balance.formattedString(Locale.getDefault()));
-		if (balance.isNegative())
-			tv.setTextColor(getResources().getColor(R.color.debit_red));
-		else
-			tv.setTextColor(getResources().getColor(R.color.credit_green));
-*/
-	}
-	
-	/**
-	 * Closes any open database adapters used by the list
-	 */
-	@Override
-	public void onDestroy() {
-		super.onDestroy();
-		mAccountsDbAdapter.close();
-		mAccountsCursorAdapter.close();
-	}	
-
-	public void showAddAccountFragment(long accountId) {
-		FragmentManager fragmentManager = getSherlockActivity().getSupportFragmentManager();
-		FragmentTransaction fragmentTransaction = fragmentManager
-				.beginTransaction();
-						
-		Bundle args = new Bundle();
-		args.putLong(TransactionsListFragment.SELECTED_ACCOUNT_ID, accountId);
-		AddAccountFragment newAccountFragment = AddAccountFragment.newInstance(mAccountsDbAdapter);	
-		newAccountFragment.setArguments(args);
-		
-		fragmentTransaction.replace(R.id.fragment_container,
-				newAccountFragment, AccountsActivity.FRAGMENT_NEW_ACCOUNT);
-		
-		fragmentTransaction.addToBackStack(null);
-		fragmentTransaction.commit();
-	}
-	
-	/**
-	 * Displays the dialog for exporting transactions in OFX
-	 */
-	public void showExportDialog(){
-		FragmentManager manager = getSherlockActivity().getSupportFragmentManager();
-		FragmentTransaction ft = manager.beginTransaction();
-	    Fragment prev = manager.findFragmentByTag(AccountsActivity.FRAGMENT_EXPORT_OFX);
-	    if (prev != null) {
-	        ft.remove(prev);
-	    }
-	    ft.addToBackStack(null);
-
-	    // Create and show the dialog.
-	    DialogFragment exportFragment = new ExportDialogFragment();
-	    exportFragment.show(ft, AccountsActivity.FRAGMENT_EXPORT_OFX);
-	}
-	
-	/**
-	 * Overrides the {@link SimpleCursorAdapter} to provide custom binding of the 
-	 * information from the database to the views
-	 * @author Ngewi Fet <ngewif@gmail.com>
-	 */
-	private class AccountsCursorAdapter extends SimpleCursorAdapter {
-		TransactionsDbAdapter transactionsDBAdapter;
-		
-		public AccountsCursorAdapter(Context context, int layout, Cursor c,
-				String[] from, int[] to) {
-			super(context, layout, c, from, to, 0);
-			transactionsDBAdapter = new TransactionsDbAdapter(context);
-		}
 
-		public void close(){
-			transactionsDBAdapter.close();
-		}
-		
-		@Override
-		public void bindView(View v, Context context, Cursor cursor) {
-			// perform the default binding
-			super.bindView(v, context, cursor);
+    /**
+     * Extends {@link DatabaseCursorLoader} for loading of {@link Account} from the
+     * database asynchronously
+     *
+     * @author Ngewi Fet <ngewif@gmail.com>
+     */
+    private static final class AccountsCursorLoader extends DatabaseCursorLoader {
 
-			// add a summary of transactions to the account view
-			TextView summary = (TextView) v
-					.findViewById(R.id.transactions_summary);
-			final long accountId = cursor.getLong(DatabaseAdapter.COLUMN_ROW_ID);
+        public AccountsCursorLoader(Context context) {
+            super(context);
+        }
+
+        @Override
+        public Cursor loadInBackground() {
+            mDatabaseAdapter = new AccountsDbAdapter(getContext());
+            Cursor cursor = mDatabaseAdapter.fetchAllRecords();
+            if (cursor != null)
+                registerContentObserver(cursor);
+            return cursor;
+        }
+    }
+
+    /**
+     * Overrides the {@link SimpleCursorAdapter} to provide custom binding of the
+     * information from the database to the views
+     *
+     * @author Ngewi Fet <ngewif@gmail.com>
+     */
+    private class AccountsCursorAdapter extends SimpleCursorAdapter {
+        TransactionsDbAdapter transactionsDBAdapter;
+
+        public AccountsCursorAdapter(Context context, int layout, Cursor c,
+                                     String[] from, int[] to) {
+            super(context, layout, c, from, to, 0);
+            transactionsDBAdapter = new TransactionsDbAdapter(context);
+        }
+
+        public void close() {
+            transactionsDBAdapter.close();
+        }
+
+        @Override
+        public void bindView(View v, Context context, Cursor cursor) {
+            // perform the default binding
+            super.bindView(v, context, cursor);
+
+            // add a summary of transactions to the account view
+            TextView summary = (TextView) v
+                    .findViewById(R.id.transactions_summary);
+            final long accountId = cursor.getLong(DatabaseAdapter.COLUMN_ROW_ID);
 
             TextView subAccountTextView = (TextView) v.findViewById(R.id.secondary_text);
             int subAccountCount = mAccountsDbAdapter.getSubAccountCount(accountId);
-            if (subAccountCount > 0){
+            if (subAccountCount > 0) {
                 subAccountTextView.setVisibility(View.VISIBLE);
                 String text = getResources().getQuantityString(R.plurals.label_sub_accounts, subAccountCount, subAccountCount);
                 subAccountTextView.setText(text);
             } else
                 subAccountTextView.setVisibility(View.GONE);
 
-			Money balance = mAccountsDbAdapter.getAccountBalance(accountId);//transactionsDBAdapter.getTransactionsSum(accountId);
-			summary.setText(balance.formattedString(Locale.getDefault()));
-			int fontColor = balance.isNegative() ? getResources().getColor(R.color.debit_red) : 
-				getResources().getColor(R.color.credit_green);
-			summary.setTextColor(fontColor);
-			
-			ImageView newTrans = (ImageView) v.findViewById(R.id.btn_new_transaction);
-			newTrans.setOnClickListener(new View.OnClickListener() {
-				
-				@Override
-				public void onClick(View v) {
-					Intent intent = new Intent(getActivity(), TransactionsActivity.class);
-					intent.setAction(Intent.ACTION_INSERT_OR_EDIT);
-					intent.putExtra(TransactionsListFragment.SELECTED_ACCOUNT_ID, accountId);
-					getActivity().startActivity(intent);
-				}
-			});
-		}
-	}
-
-	/**
-	 * Extends {@link DatabaseCursorLoader} for loading of {@link Account} from the 
-	 * database asynchronously
-	 * @author Ngewi Fet <ngewif@gmail.com>
-	 */
-	private static final class AccountsCursorLoader extends DatabaseCursorLoader {
-		
-		public AccountsCursorLoader(Context context) {
-			super(context);		
-		}
+            Money balance = mAccountsDbAdapter.getAccountBalance(accountId);
+            summary.setText(balance.formattedString(Locale.getDefault()));
+            int fontColor = balance.isNegative() ? getResources().getColor(R.color.debit_red) :
+                    getResources().getColor(R.color.credit_green);
+            summary.setTextColor(fontColor);
 
-		@Override
-		public Cursor loadInBackground() {			
-			mDatabaseAdapter = new AccountsDbAdapter(getContext());	
-			Cursor cursor = mDatabaseAdapter.fetchAllRecords();
-			if (cursor != null)
-				registerContentObserver(cursor);
-			return cursor;
-		}
-	}
-
-	@Override
-	public Loader<Cursor> onCreateLoader(int id, Bundle args) {
-		Log.d(TAG, "Creating the accounts loader");
-		return new AccountsCursorLoader(this.getActivity().getApplicationContext());		
-	}
-
-	@Override
-	public void onLoadFinished(Loader<Cursor> loaderCursor, Cursor cursor) {
-		Log.d(TAG, "Accounts loader finished. Swapping in cursor");
-		mAccountsCursorAdapter.swapCursor(cursor);
-		mAccountsCursorAdapter.notifyDataSetChanged();
-	}
-
-	@Override
-	public void onLoaderReset(Loader<Cursor> arg0) {
-		Log.d(TAG, "Resetting the accounts loader");
-		mAccountsCursorAdapter.swapCursor(null);
-	}	
+            ImageView newTrans = (ImageView) v.findViewById(R.id.btn_new_transaction);
+            newTrans.setOnClickListener(new View.OnClickListener() {
+
+                @Override
+                public void onClick(View v) {
+                    Intent intent = new Intent(getActivity(), TransactionsActivity.class);
+                    intent.setAction(Intent.ACTION_INSERT_OR_EDIT);
+                    intent.putExtra(TransactionsListFragment.SELECTED_ACCOUNT_ID, accountId);
+                    getActivity().startActivity(intent);
+                }
+            });
+        }
+    }
 
 }
diff --git a/app/src/org/gnucash/android/ui/settings/AccountPreferencesFragment.java b/app/src/org/gnucash/android/ui/settings/AccountPreferencesFragment.java
new file mode 100644
index 00000000..8492df0f
--- /dev/null
+++ b/app/src/org/gnucash/android/ui/settings/AccountPreferencesFragment.java
@@ -0,0 +1,102 @@
+/*
+ * Copyright (c) 2013 Ngewi Fet <ngewif@gmail.com>
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *     http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+package org.gnucash.android.ui.settings;
+
+import android.app.Activity;
+import android.content.Intent;
+import android.os.Bundle;
+import android.preference.Preference;
+import android.preference.PreferenceFragment;
+import android.widget.Toast;
+import com.actionbarsherlock.app.ActionBar;
+import com.actionbarsherlock.app.SherlockPreferenceActivity;
+import org.gnucash.android.R;
+import org.gnucash.android.ui.accounts.AccountsListFragment;
+import org.gnucash.android.util.GnucashAccountXmlHandler;
+
+import java.io.FileNotFoundException;
+
+/**
+ * Account settings fragment inside the Settings activity
+ *
+ * @author Ngewi Fet <ngewi.fet@gmail.com>
+ */
+public class AccountPreferencesFragment extends PreferenceFragment {
+    @Override
+    public void onCreate(Bundle savedInstanceState) {
+        super.onCreate(savedInstanceState);
+
+        addPreferencesFromResource(R.xml.fragment_account_preferences);
+        ActionBar actionBar = ((SherlockPreferenceActivity) getActivity()).getSupportActionBar();
+        actionBar.setHomeButtonEnabled(true);
+        actionBar.setDisplayHomeAsUpEnabled(true);
+        actionBar.setTitle(R.string.title_account_preferences);
+    }
+
+    @Override
+    public void onResume() {
+        super.onResume();
+
+        Preference preference = findPreference(getString(R.string.key_import_accounts));
+        preference.setOnPreferenceClickListener(new Preference.OnPreferenceClickListener() {
+            @Override
+            public boolean onPreferenceClick(Preference preference) {
+                importAccounts();
+                return true;
+            }
+        });
+
+        preference = findPreference(getString(R.string.key_delete_all_accounts));
+        preference.setOnPreferenceClickListener(new Preference.OnPreferenceClickListener() {
+            @Override
+            public boolean onPreferenceClick(Preference preference) {
+                DeleteAccountsConfirmationDialog deleteConfirmationDialog = DeleteAccountsConfirmationDialog.newInstance();
+                deleteConfirmationDialog.show(getFragmentManager(), "account_settings");
+                return true;
+            }
+        });
+    }
+
+    private void importAccounts() {
+        Intent pickIntent = new Intent(Intent.ACTION_GET_CONTENT);
+        pickIntent.setType("application/octet-stream");
+        Intent chooser = Intent.createChooser(pickIntent, "Select GnuCash account file");
+
+        startActivityForResult(chooser, AccountsListFragment.REQUEST_PICK_ACCOUNTS_FILE);
+
+    }
+
+    @Override
+    public void onActivityResult(int requestCode, int resultCode, Intent data) {
+        if (resultCode == Activity.RESULT_CANCELED){
+            return;
+        }
+
+        switch (requestCode){
+            case AccountsListFragment.REQUEST_PICK_ACCOUNTS_FILE:
+                try {
+                    GnucashAccountXmlHandler.parse(getActivity(), getActivity().getContentResolver().openInputStream(data.getData()));
+
+                    Toast.makeText(getActivity(), R.string.toast_success_importing_accounts, Toast.LENGTH_LONG).show();
+                } catch (FileNotFoundException e) {
+                    Toast.makeText(getActivity(), R.string.toast_error_importing_accounts, Toast.LENGTH_LONG).show();
+                    e.printStackTrace();
+                }
+                break;
+        }
+    }
+}
diff --git a/app/src/org/gnucash/android/ui/settings/DeleteAccountsConfirmationDialog.java b/app/src/org/gnucash/android/ui/settings/DeleteAccountsConfirmationDialog.java
new file mode 100644
index 00000000..8278f30f
--- /dev/null
+++ b/app/src/org/gnucash/android/ui/settings/DeleteAccountsConfirmationDialog.java
@@ -0,0 +1,67 @@
+/*
+ * Copyright (c) 2013 Ngewi Fet <ngewif@gmail.com>
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *     http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+package org.gnucash.android.ui.settings;
+
+import android.app.AlertDialog;
+import android.app.Dialog;
+import android.app.DialogFragment;
+import android.content.Context;
+import android.content.DialogInterface;
+import android.os.Bundle;
+import android.widget.Toast;
+import org.gnucash.android.R;
+import org.gnucash.android.db.AccountsDbAdapter;
+
+/**
+ * Confirmation dialog for deleting all accounts from the system
+ *
+ * @author Ngewi Fet <ngewif@gmail.com>
+ */
+public class DeleteAccountsConfirmationDialog extends DialogFragment {
+
+    public static DeleteAccountsConfirmationDialog newInstance() {
+        DeleteAccountsConfirmationDialog frag = new DeleteAccountsConfirmationDialog();
+        return frag;
+    }
+
+    @Override
+    public Dialog onCreateDialog(Bundle savedInstanceState) {
+        return new AlertDialog.Builder(getActivity())
+                .setIcon(android.R.drawable.ic_delete)
+                .setTitle(R.string.title_confirm_delete).setMessage(R.string.confirm_delete_all_accounts)
+                .setPositiveButton(R.string.alert_dialog_ok_delete,
+                        new DialogInterface.OnClickListener() {
+                            public void onClick(DialogInterface dialog, int whichButton) {
+                                Context context = getDialog().getContext();
+                                AccountsDbAdapter accountsDbAdapter = new AccountsDbAdapter(context);
+                                accountsDbAdapter.deleteAllRecords();
+                                accountsDbAdapter.close();
+                                Toast.makeText(context, R.string.toast_all_accounts_deleted, Toast.LENGTH_SHORT).show();
+
+                            }
+                        }
+                )
+                .setNegativeButton(R.string.alert_dialog_cancel,
+                        new DialogInterface.OnClickListener() {
+                            public void onClick(DialogInterface dialog, int whichButton) {
+                                dismiss();
+                            }
+                        }
+                )
+                .create();
+    }
+}
diff --git a/app/src/org/gnucash/android/ui/settings/SettingsActivity.java b/app/src/org/gnucash/android/ui/settings/SettingsActivity.java
index b5a78cae..0a3ce315 100644
--- a/app/src/org/gnucash/android/ui/settings/SettingsActivity.java
+++ b/app/src/org/gnucash/android/ui/settings/SettingsActivity.java
@@ -18,6 +18,7 @@
 
 import java.util.List;
 
+import android.content.Intent;
 import org.gnucash.android.R;
 import org.gnucash.android.data.Money;
 
@@ -34,6 +35,7 @@
 import com.actionbarsherlock.app.ActionBar;
 import com.actionbarsherlock.app.SherlockPreferenceActivity;
 import com.actionbarsherlock.view.MenuItem;
+import org.gnucash.android.ui.accounts.AccountsListFragment;
 
 /**
  * Activity for displaying settings and information about the application
@@ -76,6 +78,7 @@ protected void onCreate(Bundle savedInstanceState) {
 		
 		if (Build.VERSION.SDK_INT < Build.VERSION_CODES.HONEYCOMB){
 			addPreferencesFromResource(R.xml.fragment_general_preferences);
+//            addPreferencesFromResource(R.xml.fragment_account_preferences);
 			addPreferencesFromResource(R.xml.fragment_transaction_preferences);
 			addPreferencesFromResource(R.xml.fragment_about_preferences);
 			setDefaultCurrencyListener();
@@ -83,7 +86,8 @@ protected void onCreate(Bundle savedInstanceState) {
 			String versionName = manager.getString(getString(R.string.key_build_version), "");
 			Preference pref = findPreference(getString(R.string.key_build_version));
 			pref.setSummary(versionName);
-		}		
+
+		}
 	}
 		
 	@Override
diff --git a/app/src/org/gnucash/android/util/GnucashAccountXmlHandler.java b/app/src/org/gnucash/android/util/GnucashAccountXmlHandler.java
new file mode 100644
index 00000000..5fa3145c
--- /dev/null
+++ b/app/src/org/gnucash/android/util/GnucashAccountXmlHandler.java
@@ -0,0 +1,143 @@
+/*
+ * Copyright (c) 2013 Ngewi Fet <ngewif@gmail.com>
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *     http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+package org.gnucash.android.util;
+
+import android.content.Context;
+import android.widget.Toast;
+import org.gnucash.android.R;
+import org.gnucash.android.data.Account;
+import org.gnucash.android.db.AccountsDbAdapter;
+import org.xml.sax.Attributes;
+import org.xml.sax.InputSource;
+import org.xml.sax.SAXException;
+import org.xml.sax.XMLReader;
+import org.xml.sax.helpers.DefaultHandler;
+
+import javax.xml.parsers.ParserConfigurationException;
+import javax.xml.parsers.SAXParser;
+import javax.xml.parsers.SAXParserFactory;
+import java.io.*;
+import java.util.Currency;
+
+/**
+ * Handler for parsing the GnuCash accounts structure file.
+ * The discovered accounts are automatically added to the database
+ *
+ * @author Ngewi Fet <ngewif@gmail.com>
+ */
+public class GnucashAccountXmlHandler extends DefaultHandler {
+
+    /*
+     * GnuCash account XML file qualified tag names. Used for matching tags
+     */
+    public static final String TAG_NAME         = "act:name";
+    public static final String TAG_UID          = "act:id";
+    public static final String TAG_TYPE         = "act:type";
+    public static final String TAG_CURRENCY     = "cmdty:id";
+    public static final String TAG_PARENT_UID   = "act:parent";
+    public static final String TAG_ACCOUNT      = "gnc:account";
+
+    private static final String ERROR_TAG   = "GnuCashAccountImporter";
+
+    AccountsDbAdapter mDatabaseAdapter;
+    StringBuilder mContent;
+    Account mAccount;
+
+    boolean mISO4217Currency = false;
+
+    public GnucashAccountXmlHandler(Context context) {
+        mDatabaseAdapter = new AccountsDbAdapter(context);
+        mContent = new StringBuilder();
+    }
+
+    @Override
+    public void startElement(String uri, String localName,
+                             String qualifiedName, Attributes attributes) throws SAXException {
+        if (qualifiedName.equalsIgnoreCase(TAG_ACCOUNT)) {
+            mAccount = new Account("new"); //dummy name, will be replaced when we find name tag
+        }
+    }
+
+    @Override
+    public void endElement(String uri, String localName, String qualifiedName) throws SAXException {
+        String characterString = mContent.toString().trim();
+
+        if (qualifiedName.equalsIgnoreCase(TAG_NAME)) {
+            mAccount.setName(characterString);
+        }
+
+        if (qualifiedName.equalsIgnoreCase(TAG_UID)){
+            mAccount.setUID(characterString);
+        }
+
+        if (qualifiedName.equalsIgnoreCase(TAG_TYPE)){
+            mAccount.setAccountType(Account.AccountType.valueOf(characterString));
+        }
+
+        if (qualifiedName.equalsIgnoreCase(TAG_CURRENCY)){
+            if (mAccount != null)
+                mAccount.setCurrency(Currency.getInstance(characterString));
+        }
+
+        if (qualifiedName.equalsIgnoreCase(TAG_PARENT_UID)){
+            mAccount.setParentUID(characterString);
+        }
+
+        if (qualifiedName.equalsIgnoreCase("cmdty:space")){
+            if (characterString.equalsIgnoreCase("ISO4217")){
+                mISO4217Currency = true;
+            }
+        }
+
+        if (qualifiedName.equalsIgnoreCase(TAG_ACCOUNT)){
+            //we only save accounts with ISO 4217 currencies. Ignore all else
+            if (mISO4217Currency)
+                mDatabaseAdapter.addAccount(mAccount);
+
+            //reset for next account
+            mISO4217Currency = false;
+        }
+
+        //reset the accumulated characters
+        mContent.setLength(0);
+    }
+
+    @Override
+    public void characters(char[] chars, int start, int length) throws SAXException {
+        mContent.append(chars, start, length);
+    }
+
+    public static void parse(Context context, InputStream accountsInputStream){
+        try {
+            SAXParserFactory spf = SAXParserFactory.newInstance();
+            SAXParser sp = spf.newSAXParser();
+            XMLReader xr = sp.getXMLReader();
+
+            BufferedInputStream bos = new BufferedInputStream(accountsInputStream);
+
+            /** Create handler to handle XML Tags ( extends DefaultHandler ) */
+
+            GnucashAccountXmlHandler handler = new GnucashAccountXmlHandler(context);
+            xr.setContentHandler(handler);
+            xr.parse(new InputSource(bos));
+
+        } catch (Exception e) {
+            Toast.makeText(context, R.string.toast_error_importing_accounts, Toast.LENGTH_LONG).show();
+            e.printStackTrace();
+        }
+    }
+}

From c52ccded7799666524850c0835d911245e84c77f Mon Sep 17 00:00:00 2001
From: Ngewi Fet <ngewif@gmail.com>
Date: Sat, 6 Apr 2013 12:30:42 +0200
Subject: [PATCH 06/10] Implemented displaying nested accounts in a hierarchy
 (closes #66) Fixed: Consider sub-accounts when displaying account balance in
 transactions view

---
 app/AndroidManifest.xml                            |   4 +-
 app/res/layout/activity_transactions.xml           |  46 ++++-
 app/res/values/dimens.xml                          |   3 +-
 .../org/gnucash/android/db/AccountsDbAdapter.java  |  49 ++++++
 .../android/ui/accounts/AccountsActivity.java      |  88 ++++++++--
 .../android/ui/accounts/AccountsListFragment.java  |  90 +++++++---
 .../android/ui/accounts/AddAccountFragment.java    | 111 +++++++-----
 .../ui/transactions/NewTransactionFragment.java    |   6 +-
 .../ui/transactions/TransactionsActivity.java      | 187 +++++++++++++--------
 .../ui/transactions/TransactionsListFragment.java  |  11 +-
 10 files changed, 429 insertions(+), 166 deletions(-)

diff --git a/app/AndroidManifest.xml b/app/AndroidManifest.xml
index 45f1473e..026aa8e0 100644
--- a/app/AndroidManifest.xml
+++ b/app/AndroidManifest.xml
@@ -58,8 +58,8 @@
         </activity>
         <activity android:name=".ui.settings.SettingsActivity"></activity>
         <activity android:name=".ui.transactions.TransactionsActivity" 
-            android:configChanges="orientation|screenSize"
-            android:launchMode="singleTop"></activity>
+            android:configChanges="orientation|screenSize">
+        </activity>
         <activity android:name=".ui.widget.WidgetConfigurationActivity"
             android:label="@string/label_widget_configuration"
             android:theme="@style/Theme.Sherlock.Light.Dialog"
diff --git a/app/res/layout/activity_transactions.xml b/app/res/layout/activity_transactions.xml
index b45ed25b..2056b145 100644
--- a/app/res/layout/activity_transactions.xml
+++ b/app/res/layout/activity_transactions.xml
@@ -15,9 +15,43 @@
  limitations under the License.
 -->
 
-<FrameLayout xmlns:android="http://schemas.android.com/apk/res/android"
-    android:id="@+id/fragment_container"
-    android:layout_width="match_parent"
-    android:layout_height="match_parent" >
-    
-</FrameLayout>
\ No newline at end of file
+<LinearLayout xmlns:android="http://schemas.android.com/apk/res/android"
+              android:id="@+id/fragment_container"
+              android:orientation="vertical"
+              android:layout_width="match_parent"
+              android:layout_height="match_parent">
+
+    <TextView
+            android:id="@+id/section_header_sub_accounts"
+            android:layout_width="match_parent"
+            android:layout_height="@dimen/section_header_height"
+            android:paddingLeft="10dp"
+            android:background="@android:color/darker_gray"
+            android:textColor="@android:color/white"
+            android:visibility="gone"
+            android:text="Sub-Accounts"
+            />
+
+    <FrameLayout android:id="@+id/sub_accounts_container"
+                 android:layout_width="match_parent"
+                 android:layout_height="0dp"
+                 android:layout_weight="1"
+                 android:visibility="gone"/>
+
+    <TextView
+            android:id="@+id/section_header_transactions"
+            android:layout_width="match_parent"
+            android:layout_height="@dimen/section_header_height"
+            android:paddingLeft="10dp"
+            android:background="@android:color/darker_gray"
+            android:textColor="@android:color/white"
+            android:text="Transactions"
+            />
+
+    <FrameLayout android:id="@+id/transactions_container"
+                 android:layout_width="match_parent"
+                 android:layout_height="0dp"
+                 android:layout_weight="3"
+                 />
+
+</LinearLayout>
\ No newline at end of file
diff --git a/app/res/values/dimens.xml b/app/res/values/dimens.xml
index 0274ada5..d54c0e94 100644
--- a/app/res/values/dimens.xml
+++ b/app/res/values/dimens.xml
@@ -23,5 +23,6 @@
     <dimen name="text_size_medium">18sp</dimen>
     <dimen name="text_size_large">18sp</dimen>
     <dimen name="edge_padding">12dp</dimen>
-    <dimen name="widget_margin">8dp</dimen>    
+    <dimen name="widget_margin">8dp</dimen>
+    <dimen name="section_header_height">20dp</dimen>
 </resources>
\ No newline at end of file
diff --git a/app/src/org/gnucash/android/db/AccountsDbAdapter.java b/app/src/org/gnucash/android/db/AccountsDbAdapter.java
index d9128fe9..5e77bfcc 100644
--- a/app/src/org/gnucash/android/db/AccountsDbAdapter.java
+++ b/app/src/org/gnucash/android/db/AccountsDbAdapter.java
@@ -399,6 +399,55 @@ public Money getAccountBalance(long accountId){
     }
 
     /**
+     * Returns a cursor to the dataset containing sub-accounts of the account with record ID <code>accoundId</code>
+     * @param accountId Record ID of the parent account
+     * @return {@link Cursor} to the sub accounts data set
+     */
+    public Cursor fetchSubAccounts(long accountId){
+        return mDb.query(DatabaseHelper.ACCOUNTS_TABLE_NAME,
+                null,
+                DatabaseHelper.KEY_PARENT_ACCOUNT_UID + " = ?",
+                new String[]{getAccountUID(accountId)},
+                null, null, null);
+    }
+
+    /**
+     * Returns the top level accounts i.e. accounts with no parent or with the GnuCash ROOT account as parent
+     * @return Cursor to the top level accounts
+     */
+    public Cursor fetchTopLevelAccounts(){
+        StringBuilder condition = new StringBuilder("(");
+        condition.append(DatabaseHelper.KEY_PARENT_ACCOUNT_UID + " IS NULL");
+        condition.append(" OR ");
+        condition.append(DatabaseHelper.KEY_PARENT_ACCOUNT_UID + " = ");
+        condition.append("'" + getGnuCashRootAccountUID() + "'");
+        condition.append(")");
+        condition.append(" AND ");
+        condition.append(DatabaseHelper.KEY_TYPE + " != " + "'" + AccountType.ROOT.name() + "'");
+        return fetchAccounts(condition.toString());
+    }
+
+    /**
+     * Returns the GnuCash ROOT account UID.
+     * <p>In GnuCash desktop account structure, there is a root account (which is not visible in the UI) from which
+     * other top level accounts derive. GnuCash Android does not have this ROOT account by default unless the account
+     * structure was imported from GnuCash for desktop. Hence this method also returns <code>null</code> as an
+     * acceptable result.</p>
+     * <p><b>Note:</b> NULL is an acceptable response, be sure to check for it</p>
+     * @return Unique ID of the GnuCash root account.
+     */
+    public String getGnuCashRootAccountUID(){
+        String condition = DatabaseHelper.KEY_TYPE + "= '" + AccountType.ROOT.name() + "'";
+        Cursor cursor =  fetchAccounts(condition);
+        String rootUID = null;
+        if (cursor != null && cursor.moveToFirst()){
+            rootUID = cursor.getString(DatabaseAdapter.COLUMN_UID);
+            cursor.close();
+        }
+        return rootUID;
+    }
+
+    /**
      * Returns the number of accounts for which the account with ID <code>accoundId</code> is a first level parent
      * @param accountId Database ID of parent account
      * @return Number of sub accounts
diff --git a/app/src/org/gnucash/android/ui/accounts/AccountsActivity.java b/app/src/org/gnucash/android/ui/accounts/AccountsActivity.java
index b52f363d..ab178a4e 100644
--- a/app/src/org/gnucash/android/ui/accounts/AccountsActivity.java
+++ b/app/src/org/gnucash/android/ui/accounts/AccountsActivity.java
@@ -116,23 +116,37 @@ public void onCreate(Bundle savedInstanceState) {
 		if (firstRun){
 			createDefaultAccounts();
 		}
-		
-		FragmentManager fragmentManager = getSupportFragmentManager();
 
-		AccountsListFragment accountsListFragment = (AccountsListFragment) fragmentManager
-				.findFragmentByTag(FRAGMENT_ACCOUNTS_LIST);
+        final Intent intent = getIntent();
+        String action = intent.getAction();
+        if (action != null && action.equals(Intent.ACTION_INSERT_OR_EDIT)) {
+            //enter account creation/edit mode if that was specified
+            long accountId = intent.getLongExtra(TransactionsListFragment.SELECTED_ACCOUNT_ID, 0L);
+            if (accountId > 0)
+                showEditAccountFragment(accountId);
+            else {
+                long parentAccountId = intent.getLongExtra(AccountsListFragment.ARG_PARENT_ACCOUNT_ID, 0L);
+                showAddAccountFragment(parentAccountId);
+            }
+        } else {
+            //show the simple accounts list
 
-		if (accountsListFragment == null) {
-			FragmentTransaction fragmentTransaction = fragmentManager
-					.beginTransaction();
-			fragmentTransaction.add(R.id.fragment_container,
-					new AccountsListFragment(), FRAGMENT_ACCOUNTS_LIST);
+            FragmentManager fragmentManager = getSupportFragmentManager();
+            AccountsListFragment accountsListFragment = (AccountsListFragment) fragmentManager
+                    .findFragmentByTag(FRAGMENT_ACCOUNTS_LIST);
 
-			fragmentTransaction.commit();
-		}
-		
-		
-		if (hasNewFeatures()){
+            if (accountsListFragment == null) {
+                FragmentTransaction fragmentTransaction = fragmentManager
+                        .beginTransaction();
+                fragmentTransaction.add(R.id.fragment_container,
+                        new AccountsListFragment(), FRAGMENT_ACCOUNTS_LIST);
+
+                fragmentTransaction.commit();
+            } else
+                accountsListFragment.refreshList();
+        }
+
+        if (hasNewFeatures()){
 			showWhatsNewDialog();
 		}
 	}
@@ -202,6 +216,46 @@ public boolean onOptionsItemSelected(MenuItem item) {
 		}
 	}
 
+    /**
+     * Shows form fragment for creating a new account
+     * @param parentAccountId Record ID of the parent account present. Can be 0 for top-level account
+     */
+    private void showAddAccountFragment(long parentAccountId){
+        Bundle args = new Bundle();
+        args.putLong(AccountsListFragment.ARG_PARENT_ACCOUNT_ID, parentAccountId);
+        showAccountFormFragment(args);
+    }
+
+    /**
+     * Shows the form fragment for editing the account with record ID <code>accountId</code>
+     * @param accountId Record ID of the account to be edited
+     */
+    private void showEditAccountFragment(long accountId) {
+        Bundle args = new Bundle();
+        args.putLong(TransactionsListFragment.SELECTED_ACCOUNT_ID, accountId);
+        showAccountFormFragment(args);
+    }
+
+    /**
+     * Shows the form for creating/editing accounts
+     * @param args Arguments to use for initializing the form.
+     *             This could be an account to edit or a preset for the parent account
+     */
+    private void showAccountFormFragment(Bundle args){
+        FragmentManager fragmentManager = getSupportFragmentManager();
+        FragmentTransaction fragmentTransaction = fragmentManager
+                .beginTransaction();
+
+        AddAccountFragment newAccountFragment = AddAccountFragment.newInstance(null);
+        newAccountFragment.setArguments(args);
+
+        fragmentTransaction.replace(R.id.fragment_container,
+                newAccountFragment, AccountsActivity.FRAGMENT_NEW_ACCOUNT);
+
+        fragmentTransaction.addToBackStack(null);
+        fragmentTransaction.commit();
+    }
+
 	/**
 	 * Opens a dialog fragment to create a new account
 	 * @param v View which triggered this callback
@@ -211,6 +265,8 @@ public void onNewAccountClick(View v) {
 				.findFragmentByTag(FRAGMENT_ACCOUNTS_LIST);
 		if (accountFragment != null)
 			accountFragment.showAddAccountFragment(0);
+        else
+            showAddAccountFragment(0);
 	}
 
 	/**
@@ -306,6 +362,10 @@ public void onClick(DialogInterface dialogInterface, int i) {
 		mDefaultAccountsDialog.show();		
 	}
 
+    /**
+     * Starts Intent chooser for selecting a GnuCash accounts file to import.
+     * The accounts are actually imported in onActivityResult
+     */
     public void importAccounts() {
         Intent pickIntent = new Intent(Intent.ACTION_GET_CONTENT);
         pickIntent.setType("application/octet-stream");
diff --git a/app/src/org/gnucash/android/ui/accounts/AccountsListFragment.java b/app/src/org/gnucash/android/ui/accounts/AccountsListFragment.java
index b4bc1d38..f275a4f6 100644
--- a/app/src/org/gnucash/android/ui/accounts/AccountsListFragment.java
+++ b/app/src/org/gnucash/android/ui/accounts/AccountsListFragment.java
@@ -19,7 +19,6 @@
 import android.app.Activity;
 import android.app.AlertDialog;
 import android.app.Dialog;
-import android.content.ContentResolver;
 import android.content.Context;
 import android.content.DialogInterface;
 import android.content.Intent;
@@ -55,11 +54,8 @@
 import org.gnucash.android.ui.transactions.TransactionsActivity;
 import org.gnucash.android.ui.transactions.TransactionsListFragment;
 import org.gnucash.android.ui.widget.WidgetConfigurationActivity;
-import org.gnucash.android.util.GnucashAccountXmlHandler;
 import org.gnucash.android.util.OnAccountClickedListener;
 
-import java.io.File;
-import java.io.FileNotFoundException;
 import java.util.Locale;
 
 /**
@@ -70,17 +66,20 @@
 public class AccountsListFragment extends SherlockListFragment implements
         LoaderCallbacks<Cursor>, OnItemLongClickListener {
 
-    /**
-     * Logging tag
-     */
-    protected static final String TAG = "AccountsListFragment";
     public static final int REQUEST_PICK_ACCOUNTS_FILE = 0x1;
-
-
     /**
      * Menu item ID for import accounts action
      */
     public static final int MENU_IMPORT_ACCOUNTS = 0x11;
+    /**
+     * Key for passing argument for the parent account ID.
+     * When this argument is set, only sub-accounts of the account will be loaded.
+     */
+    public static final String ARG_PARENT_ACCOUNT_ID = "parent_account_id";
+    /**
+     * Logging tag
+     */
+    protected static final String TAG = "AccountsListFragment";
 
     /**
      * {@link ListAdapter} for the accounts which will be bound to the list
@@ -189,7 +188,8 @@ public void onActivityCreated(Bundle savedInstanceState) {
         actionbar.setTitle(R.string.title_accounts);
         actionbar.setDisplayHomeAsUpEnabled(false);
 
-        setHasOptionsMenu(true);
+        if (!inSubAcccount())
+            setHasOptionsMenu(true);
 
         ListView lv = getListView();
         lv.setOnItemLongClickListener(this);
@@ -240,6 +240,15 @@ public boolean onItemLongClick(AdapterView<?> parent, View view, int position,
     }
 
     /**
+     * Returns true if this fragment is currently rendering sub-accounts. false otherwise
+     * @return true if this fragment is currently rendering sub-accounts. false otherwise
+     */
+    public boolean inSubAcccount(){
+        Bundle args = getArguments();
+        return (args != null) && (args.getLong(ARG_PARENT_ACCOUNT_ID) > 0);
+    }
+
+    /**
      * Delete the account with record ID <code>rowId</code>
      * It shows the delete confirmation dialog if the account has transactions,
      * else deletes the account immediately
@@ -330,7 +339,7 @@ private void deselectPreviousSelectedItem() {
     @Override
     public void onCreateOptionsMenu(Menu menu, MenuInflater inflater) {
         inflater.inflate(R.menu.account_actions, menu);
-        if (Build.VERSION.SDK_INT < Build.VERSION_CODES.HONEYCOMB){
+        if (Build.VERSION.SDK_INT < Build.VERSION_CODES.HONEYCOMB) {
             MenuItem item = menu.add(0, MENU_IMPORT_ACCOUNTS, 0, R.string.menu_import_accounts);
             item.setShowAsActionFlags(MenuItem.SHOW_AS_ACTION_NEVER);
         }
@@ -345,7 +354,7 @@ public boolean onOptionsItemSelected(MenuItem item) {
                 return true;
 
             case MENU_IMPORT_ACCOUNTS:
-                ((AccountsActivity)getActivity()).importAccounts();
+                ((AccountsActivity) getActivity()).importAccounts();
                 return true;
 
             case R.id.menu_export:
@@ -361,6 +370,11 @@ public boolean onOptionsItemSelected(MenuItem item) {
         }
     }
 
+    public void refreshList(long parentAccountId) {
+        getArguments().putLong(ARG_PARENT_ACCOUNT_ID, parentAccountId);
+        refreshList();
+    }
+
     /**
      * Refreshes the list by restarting the {@link DatabaseCursorLoader} associated
      * with the ListView
@@ -368,6 +382,9 @@ public boolean onOptionsItemSelected(MenuItem item) {
     public void refreshList() {
         getLoaderManager().restartLoader(0, null, this);
 
+        if (getActivity() instanceof TransactionsActivity){
+            ((TransactionsActivity)getActivity()).updateSubAccountsView();
+        }
 /*
         //TODO: Figure out a way to display account balances per currency
 		boolean doubleEntryActive = PreferenceManager.getDefaultSharedPreferences(getActivity())
@@ -435,7 +452,12 @@ public void showExportDialog() {
     @Override
     public Loader<Cursor> onCreateLoader(int id, Bundle args) {
         Log.d(TAG, "Creating the accounts loader");
-        return new AccountsCursorLoader(this.getActivity().getApplicationContext());
+        Bundle fragmentArguments = getArguments();
+        long accountId = fragmentArguments == null ? -1 : fragmentArguments.getLong(ARG_PARENT_ACCOUNT_ID);
+
+        return id < 0 ?
+                new AccountsCursorLoader(this.getActivity().getApplicationContext()) :
+                new AccountsCursorLoader(this.getActivity(), accountId);
     }
 
     @Override
@@ -509,15 +531,26 @@ public void onClick(DialogInterface dialog, int whichButton) {
      * @author Ngewi Fet <ngewif@gmail.com>
      */
     private static final class AccountsCursorLoader extends DatabaseCursorLoader {
+        private long mParentAccountId = -1;
 
         public AccountsCursorLoader(Context context) {
             super(context);
         }
 
+        public AccountsCursorLoader(Context context, long parentAccountId) {
+            super(context);
+            mParentAccountId = parentAccountId;
+        }
+
         @Override
         public Cursor loadInBackground() {
             mDatabaseAdapter = new AccountsDbAdapter(getContext());
-            Cursor cursor = mDatabaseAdapter.fetchAllRecords();
+            Cursor cursor;
+            if (mParentAccountId > 0)
+                cursor = ((AccountsDbAdapter) mDatabaseAdapter).fetchSubAccounts(mParentAccountId);
+            else
+                cursor = ((AccountsDbAdapter) mDatabaseAdapter).fetchTopLevelAccounts();
+
             if (cursor != null)
                 registerContentObserver(cursor);
             return cursor;
@@ -568,17 +601,22 @@ public void bindView(View v, Context context, Cursor cursor) {
                     getResources().getColor(R.color.credit_green);
             summary.setTextColor(fontColor);
 
-            ImageView newTrans = (ImageView) v.findViewById(R.id.btn_new_transaction);
-            newTrans.setOnClickListener(new View.OnClickListener() {
-
-                @Override
-                public void onClick(View v) {
-                    Intent intent = new Intent(getActivity(), TransactionsActivity.class);
-                    intent.setAction(Intent.ACTION_INSERT_OR_EDIT);
-                    intent.putExtra(TransactionsListFragment.SELECTED_ACCOUNT_ID, accountId);
-                    getActivity().startActivity(intent);
-                }
-            });
+            ImageView newTransactionButton = (ImageView) v.findViewById(R.id.btn_new_transaction);
+            if (inSubAcccount()){
+                newTransactionButton.setVisibility(View.GONE);
+                v.findViewById(R.id.vertical_line).setVisibility(View.GONE);
+            } else {
+                newTransactionButton.setOnClickListener(new View.OnClickListener() {
+
+                    @Override
+                    public void onClick(View v) {
+                        Intent intent = new Intent(getActivity(), TransactionsActivity.class);
+                        intent.setAction(Intent.ACTION_INSERT_OR_EDIT);
+                        intent.putExtra(TransactionsListFragment.SELECTED_ACCOUNT_ID, accountId);
+                        getActivity().startActivity(intent);
+                    }
+                });
+            }
         }
     }
 
diff --git a/app/src/org/gnucash/android/ui/accounts/AddAccountFragment.java b/app/src/org/gnucash/android/ui/accounts/AddAccountFragment.java
index 5687a09c..4f10b964 100644
--- a/app/src/org/gnucash/android/ui/accounts/AddAccountFragment.java
+++ b/app/src/org/gnucash/android/ui/accounts/AddAccountFragment.java
@@ -146,24 +146,10 @@ public void onCheckedChanged(CompoundButton buttonView, boolean isChecked) {
 			}
 		});
 
-		mSelectedAccountId = getArguments().getLong(TransactionsListFragment.SELECTED_ACCOUNT_ID);
-		if (mSelectedAccountId > 0) {
-        	mAccount = mAccountsDbAdapter.getAccount(mSelectedAccountId);
-        	getSherlockActivity().getSupportActionBar().setTitle(R.string.title_edit_account);
-		}
 		return view;
 	}
 	
-	private void setParentAccountSelection(String parentUID){
-		long parentId = mAccountsDbAdapter.getAccountID(parentUID);
-		for (int pos = 0; pos < mCursorAdapter.getCount(); pos++) {
-			if (mCursorAdapter.getItemId(pos) == parentId){
-				mParentAccountSpinner.setSelection(pos);				
-				break;
-			}
-		}
-	}
-	
+
 	/**
 	 * Initializes the values of the views in the dialog
 	 */
@@ -177,33 +163,80 @@ public void onActivityCreated(Bundle savedInstanceState) {
 				getResources().getStringArray(R.array.currency_names));		
 		arrayAdapter.setDropDownViewResource(android.R.layout.simple_spinner_dropdown_item);
 		mCurrencySpinner.setAdapter(arrayAdapter);
-		
-		String currencyCode = Money.DEFAULT_CURRENCY_CODE;
-		
-		if (mSelectedAccountId != 0){
-			//if we are editing an account instead of creating one
-			currencyCode = mAccount.getCurrency().getCurrencyCode();
-		}
-		mCurrencyCodes = Arrays.asList(getResources().getStringArray(R.array.currency_codes));
-		
-		if (mCurrencyCodes.contains(currencyCode)){
-			mCurrencySpinner.setSelection(mCurrencyCodes.indexOf(currencyCode));
-		}	
-		
-		loadParentAccountList();		
 
-		if (mSelectedAccountId > 0) {
-        	mNameEditText.setText(mAccount.getName());
-        	String parentUID = mAccount.getParentUID();
-        	if (parentUID != null){
-        		mParentCheckBox.setChecked(true);
-        		mParentAccountSpinner.setEnabled(true);
-        		setParentAccountSelection(parentUID);
-        	}        	
+        loadParentAccountList();
+
+        mSelectedAccountId = getArguments().getLong(TransactionsListFragment.SELECTED_ACCOUNT_ID);
+        if (mSelectedAccountId > 0) {
+            mAccount = mAccountsDbAdapter.getAccount(mSelectedAccountId);
+            getSherlockActivity().getSupportActionBar().setTitle(R.string.title_edit_account);
+        }
+
+        if (mAccount != null){
+            initializeViewsWithAccount(mAccount);
+        } else {
+            initializeViews();
         }
-		
 	}
-	
+
+    /**
+     * Initialize view with the properties of <code>account</code>.
+     * This is applicable when editing an account
+     * @param account Account whose fields are used to populate the form
+     */
+    private void initializeViewsWithAccount(Account account){
+        if (account == null)
+            throw new IllegalArgumentException("Account cannot be null");
+
+        String currencyCode = account.getCurrency().getCurrencyCode();
+        setSelectedCurrency(currencyCode);
+
+        mNameEditText.setText(account.getName());
+        long parentAccountId = mAccountsDbAdapter.getAccountID(account.getParentUID());
+        setParentAccountSelection(parentAccountId);
+    }
+
+    /**
+     * Initialize views with defaults for new account
+     */
+    private void initializeViews(){
+        setSelectedCurrency(Money.DEFAULT_CURRENCY_CODE);
+
+        long parentAccountId = getArguments().getLong(AccountsListFragment.ARG_PARENT_ACCOUNT_ID);
+        setParentAccountSelection(parentAccountId);
+
+    }
+
+    /**
+     * Selects the currency with code <code>currencyCode</code> in the spinner
+     * @param currencyCode ISO 4217 currency code to be selected
+     */
+    private void setSelectedCurrency(String currencyCode){
+        mCurrencyCodes = Arrays.asList(getResources().getStringArray(R.array.currency_codes));
+        if (mCurrencyCodes.contains(currencyCode)){
+            mCurrencySpinner.setSelection(mCurrencyCodes.indexOf(currencyCode));
+        }
+    }
+
+    /**
+     * Selects the account with ID <code>parentAccountId</code> in the parent accounts spinner
+     * @param parentAccountId Record ID of parent account to be selected
+     */
+    private void setParentAccountSelection(long parentAccountId){
+        if (parentAccountId > 0){
+            mParentCheckBox.setChecked(true);
+            mParentAccountSpinner.setEnabled(true);
+        } else
+            return;
+
+        for (int pos = 0; pos < mCursorAdapter.getCount(); pos++) {
+            if (mCursorAdapter.getItemId(pos) == parentAccountId){
+                mParentAccountSpinner.setSelection(pos);
+                break;
+            }
+        }
+    }
+
 	@Override
 	public void onCreateOptionsMenu(Menu menu, MenuInflater inflater) {		
 		super.onCreateOptionsMenu(menu, inflater);
diff --git a/app/src/org/gnucash/android/ui/transactions/NewTransactionFragment.java b/app/src/org/gnucash/android/ui/transactions/NewTransactionFragment.java
index c0c57456..5809294c 100644
--- a/app/src/org/gnucash/android/ui/transactions/NewTransactionFragment.java
+++ b/app/src/org/gnucash/android/ui/transactions/NewTransactionFragment.java
@@ -290,12 +290,10 @@ private void initalizeViews() {
      */
 	private void updateTransferAccountsList(){
 		long accountId = ((TransactionsActivity)getActivity()).getCurrentAccountID();
-		
-		//TODO: we'll leave out the currency condition for now, maybe look at this in the future
+
 		String conditions = "(" + DatabaseHelper.KEY_ROW_ID + " != " + accountId + ") AND " + "(" +
 							DatabaseHelper.KEY_CURRENCY_CODE + " = '" + mAccountsDbAdapter.getCurrencyCode(accountId) + "')";
-		
-//		String conditions = "(" + DatabaseHelper.KEY_ROW_ID + " != " + accountId + ")";
+
 		mCursor = mAccountsDbAdapter.fetchAccounts(conditions);
 		
 		String[] from = new String[] {DatabaseHelper.KEY_NAME};
diff --git a/app/src/org/gnucash/android/ui/transactions/TransactionsActivity.java b/app/src/org/gnucash/android/ui/transactions/TransactionsActivity.java
index 6a66a359..2aeac829 100644
--- a/app/src/org/gnucash/android/ui/transactions/TransactionsActivity.java
+++ b/app/src/org/gnucash/android/ui/transactions/TransactionsActivity.java
@@ -16,12 +16,15 @@
 
 package org.gnucash.android.ui.transactions;
 
+import android.widget.TextView;
 import org.gnucash.android.R;
 import org.gnucash.android.data.Account;
 import org.gnucash.android.db.AccountsDbAdapter;
 import org.gnucash.android.db.DatabaseAdapter;
 import org.gnucash.android.db.DatabaseHelper;
 import org.gnucash.android.ui.accounts.AccountsActivity;
+import org.gnucash.android.ui.accounts.AccountsListFragment;
+import org.gnucash.android.util.OnAccountClickedListener;
 import org.gnucash.android.util.OnTransactionClickedListener;
 
 import android.content.Context;
@@ -46,8 +49,8 @@
  * Activity for displaying, creating and editing transactions
  * @author Ngewi Fet <ngewif@gmail.com>
  */
-public class TransactionsActivity extends SherlockFragmentActivity implements 
-	OnTransactionClickedListener{
+public class TransactionsActivity extends SherlockFragmentActivity implements
+        OnAccountClickedListener, OnTransactionClickedListener{
 
 	/**
 	 * Logging tag
@@ -75,33 +78,53 @@
 	 * Basically if onCreate has already been called or not. It is used
 	 * to determine if to call addToBackStack() for fragments. When adding 
 	 * the very first fragment, it should not be added to the backstack.
-	 * @see #showTransactionEditFragment(Bundle)
+	 * @see #showTransactionFormFragment(Bundle)
 	 */
 	private boolean mActivityRunning = false;
-	
+
+    TextView mSectionHeaderSubAccounts;
+    TextView mSectionHeaderTransactions;
+    View mSubAccountsContainer;
+
 	private OnNavigationListener mTransactionListNavigationListener = new OnNavigationListener() {
 
 		  @Override
-		  public boolean onNavigationItemSelected(int position, long itemId) {		    
+		  public boolean onNavigationItemSelected(int position, long itemId) {
 			mAccountId = itemId;
-		    FragmentManager fragmentManager = getSupportFragmentManager();
-		    
+            updateSubAccountsView();
+
+            FragmentManager fragmentManager = getSupportFragmentManager();
+
 		    //inform new accounts fragment that account was changed
 		    NewTransactionFragment newTransactionsFragment = (NewTransactionFragment) fragmentManager
-					.findFragmentByTag(FRAGMENT_NEW_TRANSACTION);	
+					.findFragmentByTag(FRAGMENT_NEW_TRANSACTION);
 		    if (newTransactionsFragment != null){
 		    	newTransactionsFragment.onAccountChanged(itemId);
 		    	//if we do not return, the transactions list fragment could also be found (although it's not visible)
-		    	return true; 
+		    	return true;
 		    }
-		    
+
 			TransactionsListFragment transactionsListFragment = (TransactionsListFragment) fragmentManager
-					.findFragmentByTag(FRAGMENT_TRANSACTIONS_LIST);						
+					.findFragmentByTag(FRAGMENT_TRANSACTIONS_LIST);
 			if (transactionsListFragment != null) {
 				transactionsListFragment.refreshList(itemId);
-			}
-				
-		    return true;
+            }
+
+              AccountsListFragment subAccountsListFragment = (AccountsListFragment) fragmentManager
+                      .findFragmentByTag(AccountsActivity.FRAGMENT_ACCOUNTS_LIST);
+              if (subAccountsListFragment != null) {
+                  subAccountsListFragment.refreshList(itemId);
+              } else {
+                  subAccountsListFragment = new AccountsListFragment();
+                  Bundle args = new Bundle();
+                  args.putLong(AccountsListFragment.ARG_PARENT_ACCOUNT_ID, mAccountId);
+                  subAccountsListFragment.setArguments(args);
+                  FragmentTransaction fragmentTransaction = fragmentManager.beginTransaction();
+                  fragmentTransaction.replace(R.id.sub_accounts_container, subAccountsListFragment, AccountsActivity.FRAGMENT_ACCOUNTS_LIST);
+                  fragmentTransaction.commit();
+              }
+
+              return true;
 		  }
 	};
 
@@ -114,6 +137,10 @@ protected void onCreate(Bundle savedInstanceState) {
 		super.onCreate(savedInstanceState);
 		setContentView(R.layout.activity_transactions);
 
+        mSectionHeaderSubAccounts = (TextView) findViewById(R.id.section_header_sub_accounts);
+        mSectionHeaderTransactions = (TextView) findViewById(R.id.section_header_transactions);
+        mSubAccountsContainer = findViewById(R.id.sub_accounts_container);
+
 		final Intent intent = getIntent();
 		mAccountId = intent.getLongExtra(
 				TransactionsListFragment.SELECTED_ACCOUNT_ID, -1);
@@ -123,36 +150,24 @@ protected void onCreate(Bundle savedInstanceState) {
 		if (intent.getAction().equals(Intent.ACTION_INSERT_OR_EDIT)) {
 			long transactionId = intent.getLongExtra(
 					NewTransactionFragment.SELECTED_TRANSACTION_ID, -1);
-			if (transactionId <= 0) {
-				createNewTransaction(mAccountId);
-			} else {
-				editTransaction(transactionId);
-			}
-		} else {	//load the transactions list					
-			FragmentManager fragmentManager = getSupportFragmentManager();
-			TransactionsListFragment transactionsListFragment = (TransactionsListFragment) fragmentManager
-					.findFragmentByTag(FRAGMENT_TRANSACTIONS_LIST);
-			
-			FragmentTransaction fragmentTransaction = fragmentManager
-					.beginTransaction();
-			transactionsListFragment = new TransactionsListFragment();
-			Bundle args = new Bundle();
-			args.putLong(TransactionsListFragment.SELECTED_ACCOUNT_ID,
-					mAccountId);
-			transactionsListFragment.setArguments(args);
-			Log.i(TAG, "Opening transactions for account id " +  mAccountId);
-
-			fragmentTransaction.replace(R.id.fragment_container,
-					transactionsListFragment, FRAGMENT_TRANSACTIONS_LIST);
-						
-			fragmentTransaction.commit();
+            Bundle args = new Bundle();
+            if (transactionId > 0) {
+                mSectionHeaderTransactions.setText(R.string.title_edit_transaction);
+                args.putLong(NewTransactionFragment.SELECTED_TRANSACTION_ID, transactionId);
+            } else {
+                mSectionHeaderTransactions.setText(R.string.title_add_transaction);
+                args.putLong(TransactionsListFragment.SELECTED_ACCOUNT_ID, mAccountId);
+            }
+            showTransactionFormFragment(args);
+        } else {	//load the transactions list
+            showTransactionsList();
 		}
 
 		// done creating, activity now running
 		mActivityRunning = true;
 	}
 
-	/**
+    /**
 	 * Set up action bar navigation list and listener callbacks
 	 */
 	private void setupActionBarNavigation() {
@@ -193,8 +208,27 @@ public void updateNavigationSelection() {
 		} while (accountsCursor.moveToNext());
 
 	}
-	
-	@Override
+
+    /**
+     * Toggles visibility of the sub-accounts fragment depending on if there are sub-accounts to display or not.
+     */
+    public void updateSubAccountsView() {
+        final String action = getIntent().getAction();
+        if (action != null && action.equals(Intent.ACTION_INSERT_OR_EDIT))
+            return;
+
+        AccountsDbAdapter accountsDbAdapter = new AccountsDbAdapter(TransactionsActivity.this);
+        if (accountsDbAdapter.getSubAccountCount(mAccountId) > 0) {
+            mSectionHeaderSubAccounts.setVisibility(View.VISIBLE);
+            mSubAccountsContainer.setVisibility(View.VISIBLE);
+        } else {
+            mSectionHeaderSubAccounts.setVisibility(View.GONE);
+            mSubAccountsContainer.setVisibility(View.GONE);
+        }
+        accountsDbAdapter.close();
+    }
+
+    @Override
 	public boolean onOptionsItemSelected(MenuItem item) {
 		switch (item.getItemId()) {
 		case android.R.id.home:
@@ -244,41 +278,47 @@ public void onNewTransactionClick(View v){
 	 * Show list of transactions. Loads {@link TransactionsListFragment} 
 	 */
 	protected void showTransactionsList(){
-		FragmentManager fragmentManager = getSupportFragmentManager();
+        FragmentManager fragmentManager = getSupportFragmentManager();
 
-		TransactionsListFragment transactionsListFragment = (TransactionsListFragment) fragmentManager
-				.findFragmentByTag(FRAGMENT_TRANSACTIONS_LIST);
-
-		if (transactionsListFragment == null) {
-			FragmentTransaction fragmentTransaction = fragmentManager
-					.beginTransaction();
-			transactionsListFragment = new TransactionsListFragment();
-			Bundle args = new Bundle();
-			args.putLong(TransactionsListFragment.SELECTED_ACCOUNT_ID,
-					mAccountId);
-			transactionsListFragment.setArguments(args);
-			Log.i(TAG, "Opening transactions for account id " +  mAccountId);
-
-			fragmentTransaction.add(R.id.fragment_container,
-					transactionsListFragment, FRAGMENT_TRANSACTIONS_LIST);
-						
-			fragmentTransaction.commit();
-		}
+        FragmentTransaction fragmentTransaction = fragmentManager
+                .beginTransaction();
+
+        if (mAccountsDbAdapter.getSubAccountCount(mAccountId) > 0){
+            mSubAccountsContainer.setVisibility(View.VISIBLE);
+            mSectionHeaderSubAccounts.setVisibility(View.VISIBLE);
+            AccountsListFragment subAccountsListFragment = new AccountsListFragment();
+            Bundle args = new Bundle();
+            args.putLong(AccountsListFragment.ARG_PARENT_ACCOUNT_ID, mAccountId);
+            subAccountsListFragment.setArguments(args);
+            fragmentTransaction.replace(R.id.sub_accounts_container, subAccountsListFragment, AccountsActivity.FRAGMENT_ACCOUNTS_LIST);
+        }
+
+        TransactionsListFragment transactionsListFragment = new TransactionsListFragment();
+        Bundle args = new Bundle();
+        args.putLong(TransactionsListFragment.SELECTED_ACCOUNT_ID,
+                mAccountId);
+        transactionsListFragment.setArguments(args);
+        Log.i(TAG, "Opening transactions for account id " +  mAccountId);
+
+        fragmentTransaction.replace(R.id.transactions_container,
+                transactionsListFragment, FRAGMENT_TRANSACTIONS_LIST);
+
+        fragmentTransaction.commit();
 	}
 	
 	/**
 	 * Loads the transaction insert/edit fragment and passes the arguments
 	 * @param args Bundle arguments to be passed to the fragment
 	 */
-	private void showTransactionEditFragment(Bundle args){
+	private void showTransactionFormFragment(Bundle args){
 		FragmentManager fragmentManager = getSupportFragmentManager();
 		FragmentTransaction fragmentTransaction = fragmentManager
 				.beginTransaction();
 				
 		NewTransactionFragment newTransactionFragment = new NewTransactionFragment();	
 		newTransactionFragment.setArguments(args);
-		
-		fragmentTransaction.replace(R.id.fragment_container,
+
+		fragmentTransaction.add(R.id.fragment_container,
 				newTransactionFragment, TransactionsActivity.FRAGMENT_NEW_TRANSACTION);
 		
 		if (mActivityRunning)
@@ -288,15 +328,26 @@ private void showTransactionEditFragment(Bundle args){
 	
 	@Override
 	public void createNewTransaction(long accountRowId) {
-		Bundle args = new Bundle();
-		args.putLong(TransactionsListFragment.SELECTED_ACCOUNT_ID, accountRowId);		
-		showTransactionEditFragment(args);
+        Intent createTransactionIntent = new Intent(this.getApplicationContext(), TransactionsActivity.class);
+        createTransactionIntent.setAction(Intent.ACTION_INSERT_OR_EDIT);
+        createTransactionIntent.putExtra(TransactionsListFragment.SELECTED_ACCOUNT_ID, accountRowId);
+        startActivity(createTransactionIntent);
 	}
 
 	@Override
 	public void editTransaction(long transactionId){
-		Bundle args = new Bundle();
-		args.putLong(NewTransactionFragment.SELECTED_TRANSACTION_ID, transactionId);
-		showTransactionEditFragment(args);
+        Intent createTransactionIntent = new Intent(this.getApplicationContext(), TransactionsActivity.class);
+        createTransactionIntent.setAction(Intent.ACTION_INSERT_OR_EDIT);
+        createTransactionIntent.putExtra(TransactionsListFragment.SELECTED_ACCOUNT_ID, mAccountId);
+        createTransactionIntent.putExtra(NewTransactionFragment.SELECTED_TRANSACTION_ID, transactionId);
+        startActivity(createTransactionIntent);
 	}
+
+    @Override
+    public void accountSelected(long accountRowId) {
+        Intent restartIntent = new Intent(this.getApplicationContext(), TransactionsActivity.class);
+        restartIntent.setAction(Intent.ACTION_VIEW);
+        restartIntent.putExtra(TransactionsListFragment.SELECTED_ACCOUNT_ID, accountRowId);
+        startActivity(restartIntent);
+    }
 }
diff --git a/app/src/org/gnucash/android/ui/transactions/TransactionsListFragment.java b/app/src/org/gnucash/android/ui/transactions/TransactionsListFragment.java
index 13e78d60..70ddbe95 100644
--- a/app/src/org/gnucash/android/ui/transactions/TransactionsListFragment.java
+++ b/app/src/org/gnucash/android/ui/transactions/TransactionsListFragment.java
@@ -23,10 +23,7 @@
 
 import org.gnucash.android.R;
 import org.gnucash.android.data.Money;
-import org.gnucash.android.db.DatabaseAdapter;
-import org.gnucash.android.db.DatabaseCursorLoader;
-import org.gnucash.android.db.DatabaseHelper;
-import org.gnucash.android.db.TransactionsDbAdapter;
+import org.gnucash.android.db.*;
 import org.gnucash.android.ui.widget.WidgetConfigurationActivity;
 import org.gnucash.android.util.OnTransactionClickedListener;
 
@@ -215,8 +212,10 @@ public void refreshList(long accountId){
 	
 	public void refreshList(){
 		getLoaderManager().restartLoader(0, null, this);
-		
-		Money sum = mTransactionsDbAdapter.getTransactionsSum(mAccountID);		
+
+        AccountsDbAdapter accountsDbAdapter = new AccountsDbAdapter(getActivity());
+		Money sum = accountsDbAdapter.getAccountBalance(mAccountID);// mTransactionsDbAdapter.getTransactionsSum(mAccountID);
+        accountsDbAdapter.close();
 		mSumTextView = (TextView) getView().findViewById(R.id.transactions_sum);
 		mSumTextView.setText(sum.formattedString(Locale.getDefault()));
 		if (sum.isNegative())

From 7f6b165f0665e78e3c260ec303e037ba85325c87 Mon Sep 17 00:00:00 2001
From: Ngewi Fet <ngewif@gmail.com>
Date: Sun, 7 Apr 2013 23:32:53 +0200
Subject: [PATCH 07/10] Enabled setting the account type when editing accounts
 Make account edit option more visible (menu option instead of only context
 menu option) Deactivate setting the parent account if no accounts in the
 system. Show number of sub-accounts in transaction view Refactored Settings,
 Added Account Settings

---
 app/AndroidManifest.xml                            |  3 +-
 app/res/layout/fragment_new_account.xml            | 19 ++++-
 app/res/menu/transactions_list_actions.xml         |  4 +
 app/res/values-de/strings.xml                      | 16 ++++
 app/res/values-el/strings.xml                      | 16 ++++
 app/res/values-es-rMX/strings.xml                  | 16 ++++
 app/res/values-es/strings.xml                      | 16 ++++
 app/res/values-fr/strings.xml                      | 16 ++++
 app/res/values-hu/strings.xml                      | 16 ++++
 app/res/values-it/strings.xml                      | 16 ++++
 app/res/values-nb/strings.xml                      | 16 ++++
 app/res/values-nl/strings.xml                      | 16 ++++
 app/res/values-pt-rBR/strings.xml                  | 16 ++++
 app/res/values-ru/strings.xml                      | 16 ++++
 app/res/values/strings.xml                         | 31 ++++++++
 app/res/xml-v11/fragment_about_preferences.xml     | 30 +++++++
 app/res/xml-v11/fragment_account_preferences.xml   | 16 ++++
 app/res/xml/fragment_about_preferences.xml         |  1 +
 app/res/xml/fragment_account_preferences.xml       | 10 ++-
 app/res/xml/fragment_general_preferences.xml       |  6 --
 .../android/ui/accounts/AccountsListFragment.java  | 12 ---
 .../android/ui/accounts/AddAccountFragment.java    | 48 ++++++++++--
 .../ui/settings/AccountPreferencesFragment.java    | 52 +++----------
 .../ui/settings/GeneralPreferenceFragment.java     |  6 +-
 .../android/ui/settings/SettingsActivity.java      | 47 ++++++++++-
 .../ui/transactions/TransactionsActivity.java      | 91 ++++++++++++++--------
 26 files changed, 440 insertions(+), 112 deletions(-)
 create mode 100644 app/res/xml-v11/fragment_about_preferences.xml
 create mode 100644 app/res/xml-v11/fragment_account_preferences.xml

diff --git a/app/AndroidManifest.xml b/app/AndroidManifest.xml
index 026aa8e0..27295973 100644
--- a/app/AndroidManifest.xml
+++ b/app/AndroidManifest.xml
@@ -49,8 +49,7 @@
         android:theme="@style/Theme.Sherlock.Light.DarkActionBar">
         <activity
             android:name=".ui.accounts.AccountsActivity"
-            android:label="@string/app_name" 
-            android:launchMode="singleTop">
+            android:label="@string/app_name">
             <intent-filter>
                 <action android:name="android.intent.action.MAIN" />
                 <category android:name="android.intent.category.LAUNCHER" />
diff --git a/app/res/layout/fragment_new_account.xml b/app/res/layout/fragment_new_account.xml
index 8e1a611c..36568fe0 100644
--- a/app/res/layout/fragment_new_account.xml
+++ b/app/res/layout/fragment_new_account.xml
@@ -54,8 +54,23 @@
 		android:layout_marginBottom="20dp"
 		style="@style/ListItem"		/>
 
-    
     <TextView
+            android:text="@string/label_account_type"
+            android:layout_height="wrap_content"
+            android:layout_width="wrap_content"
+            android:layout_marginBottom="-8dip"
+            android:layout_marginLeft="10dp"
+            style="@style/TextAppearance.EditTransaction_LabelSmall" />
+
+    <Spinner android:id="@+id/input_account_type_spinner"
+             android:layout_width="match_parent"
+             android:layout_height="wrap_content"
+             android:layout_marginLeft="10dp"
+             android:layout_marginRight="10dp"
+             android:layout_marginBottom="20dp"
+             style="@style/ListItem"		/>
+    
+    <TextView android:id="@+id/label_parent_account"
 	    android:text="@string/label_parent_account"
 	    android:layout_height="wrap_content"
 	    android:layout_width="wrap_content"
@@ -63,7 +78,7 @@
 	    android:layout_marginBottom="-8dip"
 	    style="@style/TextAppearance.EditTransaction_LabelSmall" />
     
-    <LinearLayout 
+    <LinearLayout android:id="@+id/layout_parent_account"
         android:layout_width="match_parent"
 	    android:layout_height="wrap_content"
 	    style="@style/ListItem"
diff --git a/app/res/menu/transactions_list_actions.xml b/app/res/menu/transactions_list_actions.xml
index 8b09f51e..6158f1e9 100644
--- a/app/res/menu/transactions_list_actions.xml
+++ b/app/res/menu/transactions_list_actions.xml
@@ -20,4 +20,8 @@
           android:icon="@drawable/content_new_holo_dark"
           android:title="@string/title_add_transaction"
           android:showAsAction="always"/>
+    <item android:id="@+id/menu_edit_account"
+          android:icon="@drawable/content_edit_holo_dark"
+          android:title="@string/title_edit_account"
+          android:showAsAction="never|withText" />
 </menu>
\ No newline at end of file
diff --git a/app/res/values-de/strings.xml b/app/res/values-de/strings.xml
index a8553734..a7c8503f 100644
--- a/app/res/values-de/strings.xml
+++ b/app/res/values-de/strings.xml
@@ -331,8 +331,24 @@
     <string name="confirm_delete_all_accounts">Are you sure you want to delete all accounts and transactions? \nThis
         operation cannot be undone!
     </string>
+    <string name="label_account_type">Account Type</string>
     <plurals name="label_sub_accounts">
         <item quantity="one">%d Unterkonto</item>
         <item quantity="other">%d Unterkonten</item>
     </plurals>
+    <string-array name="account_type_entry_values">
+        <item>CASH</item>
+        <item>BANK</item>
+        <item>CREDIT CARD</item>
+        <item>ASSET</item>
+        <item>LIABILITY</item>
+        <item>INCOME</item>
+        <item>EXPENSE</item>
+        <item>PAYABLE</item>
+        <item>RECEIVABLE</item>
+        <item>EQUITY</item>
+        <item>CURRENCY</item>
+        <item>STOCK</item>
+        <item>MUTUAL FUND</item>
+    </string-array>
 </resources>
\ No newline at end of file
diff --git a/app/res/values-el/strings.xml b/app/res/values-el/strings.xml
index f9f96801..f713c79f 100644
--- a/app/res/values-el/strings.xml
+++ b/app/res/values-el/strings.xml
@@ -337,8 +337,24 @@
     <string name="confirm_delete_all_accounts">Are you sure you want to delete all accounts and transactions? \nThis
         operation cannot be undone!
     </string>
+    <string name="label_account_type">Account Type</string>
     <plurals name="label_sub_accounts">
         <item quantity="one">%d sub-account</item>
         <item quantity="other">%d sub-accounts</item>
     </plurals>
+    <string-array name="account_type_entry_values">
+        <item>CASH</item>
+        <item>BANK</item>
+        <item>CREDIT CARD</item>
+        <item>ASSET</item>
+        <item>LIABILITY</item>
+        <item>INCOME</item>
+        <item>EXPENSE</item>
+        <item>PAYABLE</item>
+        <item>RECEIVABLE</item>
+        <item>EQUITY</item>
+        <item>CURRENCY</item>
+        <item>STOCK</item>
+        <item>MUTUAL FUND</item>
+    </string-array>
 </resources>
diff --git a/app/res/values-es-rMX/strings.xml b/app/res/values-es-rMX/strings.xml
index aa0614fb..faf23002 100644
--- a/app/res/values-es-rMX/strings.xml
+++ b/app/res/values-es-rMX/strings.xml
@@ -330,8 +330,24 @@
     <string name="confirm_delete_all_accounts">Are you sure you want to delete all accounts and transactions? \nThis
         operation cannot be undone!
     </string>
+    <string name="label_account_type">Account Type</string>
     <plurals name="label_sub_accounts">
         <item quantity="one">%d sub-account</item>
         <item quantity="other">%d sub-accounts</item>
     </plurals>
+    <string-array name="account_type_entry_values">
+        <item>CASH</item>
+        <item>BANK</item>
+        <item>CREDIT CARD</item>
+        <item>ASSET</item>
+        <item>LIABILITY</item>
+        <item>INCOME</item>
+        <item>EXPENSE</item>
+        <item>PAYABLE</item>
+        <item>RECEIVABLE</item>
+        <item>EQUITY</item>
+        <item>CURRENCY</item>
+        <item>STOCK</item>
+        <item>MUTUAL FUND</item>
+    </string-array>
 </resources>
\ No newline at end of file
diff --git a/app/res/values-es/strings.xml b/app/res/values-es/strings.xml
index fd288ecc..731f7b6b 100644
--- a/app/res/values-es/strings.xml
+++ b/app/res/values-es/strings.xml
@@ -331,8 +331,24 @@
     <string name="confirm_delete_all_accounts">Are you sure you want to delete all accounts and transactions? \nThis
         operation cannot be undone!
     </string>
+    <string name="label_account_type">Account Type</string>
     <plurals name="label_sub_accounts">
         <item quantity="one">%d sub-account</item>
         <item quantity="other">%d sub-accounts</item>
     </plurals>
+    <string-array name="account_type_entry_values">
+        <item>CASH</item>
+        <item>BANK</item>
+        <item>CREDIT CARD</item>
+        <item>ASSET</item>
+        <item>LIABILITY</item>
+        <item>INCOME</item>
+        <item>EXPENSE</item>
+        <item>PAYABLE</item>
+        <item>RECEIVABLE</item>
+        <item>EQUITY</item>
+        <item>CURRENCY</item>
+        <item>STOCK</item>
+        <item>MUTUAL FUND</item>
+    </string-array>
 </resources>
diff --git a/app/res/values-fr/strings.xml b/app/res/values-fr/strings.xml
index 5c1841f0..39cd3184 100644
--- a/app/res/values-fr/strings.xml
+++ b/app/res/values-fr/strings.xml
@@ -331,8 +331,24 @@
     <string name="confirm_delete_all_accounts">Are you sure you want to delete all accounts and transactions? \nThis
         operation cannot be undone!
     </string>
+    <string name="label_account_type">Account Type</string>
     <plurals name="label_sub_accounts">
         <item quantity="one">%d sub-account</item>
         <item quantity="other">%d sub-accounts</item>
     </plurals>
+    <string-array name="account_type_entry_values">
+        <item>CASH</item>
+        <item>BANK</item>
+        <item>CREDIT CARD</item>
+        <item>ASSET</item>
+        <item>LIABILITY</item>
+        <item>INCOME</item>
+        <item>EXPENSE</item>
+        <item>PAYABLE</item>
+        <item>RECEIVABLE</item>
+        <item>EQUITY</item>
+        <item>CURRENCY</item>
+        <item>STOCK</item>
+        <item>MUTUAL FUND</item>
+    </string-array>
 </resources>
\ No newline at end of file
diff --git a/app/res/values-hu/strings.xml b/app/res/values-hu/strings.xml
index a66685b7..7b824074 100644
--- a/app/res/values-hu/strings.xml
+++ b/app/res/values-hu/strings.xml
@@ -330,8 +330,24 @@
     <string name="confirm_delete_all_accounts">Are you sure you want to delete all accounts and transactions? \nThis
         operation cannot be undone!
     </string>
+    <string name="label_account_type">Account Type</string>
     <plurals name="label_sub_accounts">
         <item quantity="one">%d sub-account</item>
         <item quantity="other">%d sub-accounts</item>
     </plurals>
+    <string-array name="account_type_entry_values">
+        <item>CASH</item>
+        <item>BANK</item>
+        <item>CREDIT CARD</item>
+        <item>ASSET</item>
+        <item>LIABILITY</item>
+        <item>INCOME</item>
+        <item>EXPENSE</item>
+        <item>PAYABLE</item>
+        <item>RECEIVABLE</item>
+        <item>EQUITY</item>
+        <item>CURRENCY</item>
+        <item>STOCK</item>
+        <item>MUTUAL FUND</item>
+    </string-array>
 </resources>
\ No newline at end of file
diff --git a/app/res/values-it/strings.xml b/app/res/values-it/strings.xml
index e1ac770d..e76e21d9 100644
--- a/app/res/values-it/strings.xml
+++ b/app/res/values-it/strings.xml
@@ -331,8 +331,24 @@
     <string name="confirm_delete_all_accounts">Are you sure you want to delete all accounts and transactions? \nThis
         operation cannot be undone!
     </string>
+    <string name="label_account_type">Account Type</string>
     <plurals name="label_sub_accounts">
         <item quantity="one">%d sub-account</item>
         <item quantity="other">%d sub-accounts</item>
     </plurals>
+    <string-array name="account_type_entry_values">
+        <item>CASH</item>
+        <item>BANK</item>
+        <item>CREDIT CARD</item>
+        <item>ASSET</item>
+        <item>LIABILITY</item>
+        <item>INCOME</item>
+        <item>EXPENSE</item>
+        <item>PAYABLE</item>
+        <item>RECEIVABLE</item>
+        <item>EQUITY</item>
+        <item>CURRENCY</item>
+        <item>STOCK</item>
+        <item>MUTUAL FUND</item>
+    </string-array>
 </resources>
diff --git a/app/res/values-nb/strings.xml b/app/res/values-nb/strings.xml
index 21c1c8da..3b51296c 100644
--- a/app/res/values-nb/strings.xml
+++ b/app/res/values-nb/strings.xml
@@ -334,8 +334,24 @@ format og importeres i regnskapsprogrammet GnuCash for PC.</string>
     <string name="confirm_delete_all_accounts">Are you sure you want to delete all accounts and transactions? \nThis
         operation cannot be undone!
     </string>
+    <string name="label_account_type">Account Type</string>
     <plurals name="label_sub_accounts">
         <item quantity="one">%d sub-account</item>
         <item quantity="other">%d sub-accounts</item>
     </plurals>
+    <string-array name="account_type_entry_values">
+        <item>CASH</item>
+        <item>BANK</item>
+        <item>CREDIT CARD</item>
+        <item>ASSET</item>
+        <item>LIABILITY</item>
+        <item>INCOME</item>
+        <item>EXPENSE</item>
+        <item>PAYABLE</item>
+        <item>RECEIVABLE</item>
+        <item>EQUITY</item>
+        <item>CURRENCY</item>
+        <item>STOCK</item>
+        <item>MUTUAL FUND</item>
+    </string-array>
 </resources>
diff --git a/app/res/values-nl/strings.xml b/app/res/values-nl/strings.xml
index 34fbeab0..42c4ed26 100644
--- a/app/res/values-nl/strings.xml
+++ b/app/res/values-nl/strings.xml
@@ -331,8 +331,24 @@
     <string name="confirm_delete_all_accounts">Are you sure you want to delete all accounts and transactions? \nThis
         operation cannot be undone!
     </string>
+    <string name="label_account_type">Account Type</string>
     <plurals name="label_sub_accounts">
         <item quantity="one">%d sub-account</item>
         <item quantity="other">%d sub-accounts</item>
     </plurals>
+    <string-array name="account_type_entry_values">
+        <item>CASH</item>
+        <item>BANK</item>
+        <item>CREDIT CARD</item>
+        <item>ASSET</item>
+        <item>LIABILITY</item>
+        <item>INCOME</item>
+        <item>EXPENSE</item>
+        <item>PAYABLE</item>
+        <item>RECEIVABLE</item>
+        <item>EQUITY</item>
+        <item>CURRENCY</item>
+        <item>STOCK</item>
+        <item>MUTUAL FUND</item>
+    </string-array>
 </resources>
diff --git a/app/res/values-pt-rBR/strings.xml b/app/res/values-pt-rBR/strings.xml
index ed585228..f34c7515 100644
--- a/app/res/values-pt-rBR/strings.xml
+++ b/app/res/values-pt-rBR/strings.xml
@@ -330,8 +330,24 @@
     <string name="confirm_delete_all_accounts">Are you sure you want to delete all accounts and transactions? \nThis
         operation cannot be undone!
     </string>
+    <string name="label_account_type">Account Type</string>
     <plurals name="label_sub_accounts">
         <item quantity="one">%d sub-account</item>
         <item quantity="other">%d sub-accounts</item>
     </plurals>
+    <string-array name="account_type_entry_values">
+        <item>CASH</item>
+        <item>BANK</item>
+        <item>CREDIT CARD</item>
+        <item>ASSET</item>
+        <item>LIABILITY</item>
+        <item>INCOME</item>
+        <item>EXPENSE</item>
+        <item>PAYABLE</item>
+        <item>RECEIVABLE</item>
+        <item>EQUITY</item>
+        <item>CURRENCY</item>
+        <item>STOCK</item>
+        <item>MUTUAL FUND</item>
+    </string-array>
 </resources>
diff --git a/app/res/values-ru/strings.xml b/app/res/values-ru/strings.xml
index 23419a0e..d3d78c8e 100644
--- a/app/res/values-ru/strings.xml
+++ b/app/res/values-ru/strings.xml
@@ -331,8 +331,24 @@
     <string name="confirm_delete_all_accounts">Are you sure you want to delete all accounts and transactions? \nThis
         operation cannot be undone!
     </string>
+    <string name="label_account_type">Account Type</string>
     <plurals name="label_sub_accounts">
         <item quantity="one">%d sub-account</item>
         <item quantity="other">%d sub-accounts</item>
     </plurals>
+    <string-array name="account_type_entry_values">
+        <item>CASH</item>
+        <item>BANK</item>
+        <item>CREDIT CARD</item>
+        <item>ASSET</item>
+        <item>LIABILITY</item>
+        <item>INCOME</item>
+        <item>EXPENSE</item>
+        <item>PAYABLE</item>
+        <item>RECEIVABLE</item>
+        <item>EQUITY</item>
+        <item>CURRENCY</item>
+        <item>STOCK</item>
+        <item>MUTUAL FUND</item>
+    </string-array>
 </resources>
diff --git a/app/res/values/strings.xml b/app/res/values/strings.xml
index c439cd2d..00dafc94 100644
--- a/app/res/values/strings.xml
+++ b/app/res/values/strings.xml
@@ -526,8 +526,39 @@
     <string name="confirm_delete_all_accounts">Are you sure you want to delete all accounts and transactions? \nThis
         operation cannot be undone!
     </string>
+    <string name="label_account_type">Account Type</string>
     <plurals name="label_sub_accounts">
         <item quantity="one">%d sub-account</item>
         <item quantity="other">%d sub-accounts</item>
     </plurals>
+    <string-array name="account_type_entry_values">
+        <item>CASH</item>
+        <item>BANK</item>
+        <item>CREDIT_CARD</item>
+        <item>ASSET</item>
+        <item>LIABILITY</item>
+        <item>INCOME</item>
+        <item>EXPENSE</item>
+        <item>PAYABLE</item>
+        <item>RECEIVABLE</item>
+        <item>EQUITY</item>
+        <item>CURRENCY</item>
+        <item>STOCK</item>
+        <item>MUTUAL_FUND</item>
+    </string-array>
+    <string-array name="account_type_entries">
+        <item>CASH</item>
+        <item>BANK</item>
+        <item>CREDIT CARD</item>
+        <item>ASSET</item>
+        <item>LIABILITY</item>
+        <item>INCOME</item>
+        <item>EXPENSE</item>
+        <item>PAYABLE</item>
+        <item>RECEIVABLE</item>
+        <item>EQUITY</item>
+        <item>CURRENCY</item>
+        <item>STOCK</item>
+        <item>MUTUAL FUND</item>
+    </string-array>
 </resources>
diff --git a/app/res/xml-v11/fragment_about_preferences.xml b/app/res/xml-v11/fragment_about_preferences.xml
new file mode 100644
index 00000000..de4a3b91
--- /dev/null
+++ b/app/res/xml-v11/fragment_about_preferences.xml
@@ -0,0 +1,30 @@
+<?xml version="1.0" encoding="utf-8"?>
+<!--
+ Copyright (c) 2012 Ngewi Fet <ngewif@gmail.com>
+ 
+ Licensed under the Apache License, Version 2.0 (the "License");
+ you may not use this file except in compliance with the License.
+ You may obtain a copy of the License at
+ 
+    http://www.apache.org/licenses/LICENSE-2.0
+ 
+ Unless required by applicable law or agreed to in writing, software
+ distributed under the License is distributed on an "AS IS" BASIS,
+ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ See the License for the specific language governing permissions and
+ limitations under the License.
+-->
+
+<PreferenceScreen xmlns:android="http://schemas.android.com/apk/res/android" >
+    <Preference android:key="@string/key_about" android:summary="@string/summary_about_gnucash"
+                android:title="@string/title_about"/>
+    <Preference android:key="@string/key_build_version" android:title="@string/title_build_version"/>
+    <Preference android:summary="@string/summary_licence_details" 
+        android:title="@string/title_license" 
+        android:key="@string/key_license">
+        <intent android:action="android.intent.action.VIEW"
+        	android:data="http://www.apache.org/licenses/LICENSE-2.0.html" />
+	</Preference>
+        
+
+</PreferenceScreen>
\ No newline at end of file
diff --git a/app/res/xml-v11/fragment_account_preferences.xml b/app/res/xml-v11/fragment_account_preferences.xml
new file mode 100644
index 00000000..bf9fea3f
--- /dev/null
+++ b/app/res/xml-v11/fragment_account_preferences.xml
@@ -0,0 +1,16 @@
+<?xml version="1.0" encoding="utf-8"?>
+
+<PreferenceScreen xmlns:android="http://schemas.android.com/apk/res/android">
+    <ListPreference android:summary="@string/summary_default_currency"
+                    android:key="@string/key_default_currency"
+                    android:dialogTitle="@string/title_choose_currency"
+                    android:title="@string/title_default_currency"
+                    android:entries="@array/currency_names"
+                    android:entryValues="@array/currency_codes"/>
+    <Preference android:key="@string/key_import_accounts"
+                android:summary="@string/summary_import_accounts"
+                android:title="@string/title_import_accounts" />
+    <Preference android:key="@string/key_delete_all_accounts"
+                android:summary="@string/summary_delete_all_accounts"
+                android:title="@string/title_delete_all_accounts" />
+</PreferenceScreen>
\ No newline at end of file
diff --git a/app/res/xml/fragment_about_preferences.xml b/app/res/xml/fragment_about_preferences.xml
index de4a3b91..e41a147b 100644
--- a/app/res/xml/fragment_about_preferences.xml
+++ b/app/res/xml/fragment_about_preferences.xml
@@ -16,6 +16,7 @@
 -->
 
 <PreferenceScreen xmlns:android="http://schemas.android.com/apk/res/android" >
+    <PreferenceCategory android:title="@string/title_about_gnucash"/>
     <Preference android:key="@string/key_about" android:summary="@string/summary_about_gnucash"
                 android:title="@string/title_about"/>
     <Preference android:key="@string/key_build_version" android:title="@string/title_build_version"/>
diff --git a/app/res/xml/fragment_account_preferences.xml b/app/res/xml/fragment_account_preferences.xml
index 90171fb1..db0a5403 100644
--- a/app/res/xml/fragment_account_preferences.xml
+++ b/app/res/xml/fragment_account_preferences.xml
@@ -1,10 +1,14 @@
 <?xml version="1.0" encoding="utf-8"?>
 
 <PreferenceScreen xmlns:android="http://schemas.android.com/apk/res/android">
+    <PreferenceCategory android:title="@string/title_account_preferences"/>
+    <ListPreference android:summary="@string/summary_default_currency"
+                    android:key="@string/key_default_currency"
+                    android:dialogTitle="@string/title_choose_currency"
+                    android:title="@string/title_default_currency"
+                    android:entries="@array/currency_names"
+                    android:entryValues="@array/currency_codes"/>
     <Preference android:key="@string/key_import_accounts"
                 android:summary="@string/summary_import_accounts"
                 android:title="@string/title_import_accounts" />
-    <Preference android:key="@string/key_delete_all_accounts"
-                android:summary="@string/summary_delete_all_accounts"
-                android:title="@string/title_delete_all_accounts" />
 </PreferenceScreen>
\ No newline at end of file
diff --git a/app/res/xml/fragment_general_preferences.xml b/app/res/xml/fragment_general_preferences.xml
index fcf8e459..8b684feb 100644
--- a/app/res/xml/fragment_general_preferences.xml
+++ b/app/res/xml/fragment_general_preferences.xml
@@ -16,12 +16,6 @@
 -->
 
 <PreferenceScreen xmlns:android="http://schemas.android.com/apk/res/android" >
-    <ListPreference android:summary="@string/summary_default_currency" 
-        android:key="@string/key_default_currency" 
-        android:dialogTitle="@string/title_choose_currency" 
-        android:title="@string/title_default_currency" 
-        android:entries="@array/currency_names" 
-        android:entryValues="@array/currency_codes"/>
     <PreferenceCategory android:title="@string/title_export_preference_category">
         <EditTextPreference android:title="@string/title_default_export_email" 
             android:key="@string/key_default_export_email" 
diff --git a/app/src/org/gnucash/android/ui/accounts/AccountsListFragment.java b/app/src/org/gnucash/android/ui/accounts/AccountsListFragment.java
index f275a4f6..2f9be01c 100644
--- a/app/src/org/gnucash/android/ui/accounts/AccountsListFragment.java
+++ b/app/src/org/gnucash/android/ui/accounts/AccountsListFragment.java
@@ -68,10 +68,6 @@
 
     public static final int REQUEST_PICK_ACCOUNTS_FILE = 0x1;
     /**
-     * Menu item ID for import accounts action
-     */
-    public static final int MENU_IMPORT_ACCOUNTS = 0x11;
-    /**
      * Key for passing argument for the parent account ID.
      * When this argument is set, only sub-accounts of the account will be loaded.
      */
@@ -339,10 +335,6 @@ private void deselectPreviousSelectedItem() {
     @Override
     public void onCreateOptionsMenu(Menu menu, MenuInflater inflater) {
         inflater.inflate(R.menu.account_actions, menu);
-        if (Build.VERSION.SDK_INT < Build.VERSION_CODES.HONEYCOMB) {
-            MenuItem item = menu.add(0, MENU_IMPORT_ACCOUNTS, 0, R.string.menu_import_accounts);
-            item.setShowAsActionFlags(MenuItem.SHOW_AS_ACTION_NEVER);
-        }
     }
 
     @Override
@@ -353,10 +345,6 @@ public boolean onOptionsItemSelected(MenuItem item) {
                 showAddAccountFragment(0);
                 return true;
 
-            case MENU_IMPORT_ACCOUNTS:
-                ((AccountsActivity) getActivity()).importAccounts();
-                return true;
-
             case R.id.menu_export:
                 showExportDialog();
                 return true;
diff --git a/app/src/org/gnucash/android/ui/accounts/AddAccountFragment.java b/app/src/org/gnucash/android/ui/accounts/AddAccountFragment.java
index 4f10b964..1dfe6a46 100644
--- a/app/src/org/gnucash/android/ui/accounts/AddAccountFragment.java
+++ b/app/src/org/gnucash/android/ui/accounts/AddAccountFragment.java
@@ -20,6 +20,8 @@
 import java.util.Currency;
 import java.util.List;
 
+import android.app.Activity;
+import android.content.Intent;
 import org.gnucash.android.R;
 import org.gnucash.android.data.Account;
 import org.gnucash.android.data.Money;
@@ -93,7 +95,9 @@
 	private Spinner mParentAccountSpinner;
 
 	private CheckBox mParentCheckBox;
-	
+
+    private Spinner mAccountTypeSpinner;
+
 	/**
 	 * Default constructor
 	 * Required, else the app crashes on screen rotation
@@ -133,7 +137,9 @@ public View onCreateView(LayoutInflater inflater, ViewGroup container,
 		mCurrencySpinner = (Spinner) view.findViewById(R.id.input_currency_spinner);
 		mNameEditText = (EditText) view.findViewById(R.id.edit_text_account_name);
 		mNameEditText.requestFocus();
-        
+
+        mAccountTypeSpinner = (Spinner) view.findViewById(R.id.input_account_type_spinner);
+
 		mParentAccountSpinner = (Spinner) view.findViewById(R.id.input_parent_account);
 		mParentAccountSpinner.setEnabled(false);
 		
@@ -165,6 +171,7 @@ public void onActivityCreated(Bundle savedInstanceState) {
 		mCurrencySpinner.setAdapter(arrayAdapter);
 
         loadParentAccountList();
+        loadAccountTypesList();
 
         mSelectedAccountId = getArguments().getLong(TransactionsListFragment.SELECTED_ACCOUNT_ID);
         if (mSelectedAccountId > 0) {
@@ -194,6 +201,10 @@ private void initializeViewsWithAccount(Account account){
         mNameEditText.setText(account.getName());
         long parentAccountId = mAccountsDbAdapter.getAccountID(account.getParentUID());
         setParentAccountSelection(parentAccountId);
+
+        String[] accountTypeEntries = getResources().getStringArray(R.array.account_type_entries);
+        int accountTypeIndex = Arrays.asList(accountTypeEntries).indexOf(account.getAccountType().name());
+        mAccountTypeSpinner.setSelection(accountTypeIndex);
     }
 
     /**
@@ -261,7 +272,12 @@ public boolean onOptionsItemSelected(MenuItem item) {
 	private void loadParentAccountList(){
 		String condition = DatabaseHelper.KEY_ROW_ID + "!=" + mSelectedAccountId;
 		mCursor = mAccountsDbAdapter.fetchAccounts(condition);
-		
+		if (mCursor.getCount() <= 0){
+            final View view = getView();
+            view.findViewById(R.id.layout_parent_account).setVisibility(View.GONE);
+            view.findViewById(R.id.label_parent_account).setVisibility(View.GONE);
+        }
+
 		String[] from = new String[] {DatabaseHelper.KEY_NAME};
 		int[] to = new int[] {android.R.id.text1};
 		mCursorAdapter = new SimpleCursorAdapter(
@@ -271,7 +287,17 @@ private void loadParentAccountList(){
 		mCursorAdapter.setDropDownViewResource(android.R.layout.simple_spinner_dropdown_item);		
 		mParentAccountSpinner.setAdapter(mCursorAdapter);
 	}
-	
+
+    private void loadAccountTypesList(){
+        String[] accountTypes = getResources().getStringArray(R.array.account_type_entry_values);
+        ArrayAdapter<String> accountTypesAdapter = new ArrayAdapter<String>(
+                getActivity(), android.R.layout.simple_list_item_1, accountTypes);
+
+        accountTypesAdapter.setDropDownViewResource(android.R.layout.simple_spinner_dropdown_item);
+        mAccountTypeSpinner.setAdapter(accountTypesAdapter);
+
+    }
+
 	/**
 	 * Finishes the fragment appropriately.
 	 * Depends on how the fragment was loaded, it might have a backstack or not
@@ -280,8 +306,14 @@ private void finishFragment() {
 		InputMethodManager imm = (InputMethodManager) getSherlockActivity().getSystemService(
 			      Context.INPUT_METHOD_SERVICE);
 			imm.hideSoftInputFromWindow(mNameEditText.getWindowToken(), 0);
-			
-		getSherlockActivity().getSupportFragmentManager().popBackStack();			
+
+        final String action = getActivity().getIntent().getAction();
+        if (action != null && action.equals(Intent.ACTION_INSERT_OR_EDIT)){
+            getActivity().setResult(Activity.RESULT_OK);
+            getActivity().finish();
+        } else {
+		    getSherlockActivity().getSupportFragmentManager().popBackStack();
+        }
 	}
 	
 	@Override
@@ -311,6 +343,10 @@ private void saveAccount() {
 				.getSelectedItemPosition());
 		mAccount.setCurrency(Currency.getInstance(curCode));
 
+        int selectedAccountType = mAccountTypeSpinner.getSelectedItemPosition();
+        String[] accountTypeEntries = getResources().getStringArray(R.array.account_type_entries);
+        mAccount.setAccountType(Account.AccountType.valueOf(accountTypeEntries[selectedAccountType]));
+
 		if (mParentCheckBox.isChecked()){
 			long id = mParentAccountSpinner.getSelectedItemId();
 			mAccount.setParentUID(mAccountsDbAdapter.getAccountUID(id));
diff --git a/app/src/org/gnucash/android/ui/settings/AccountPreferencesFragment.java b/app/src/org/gnucash/android/ui/settings/AccountPreferencesFragment.java
index 8492df0f..c01b70e0 100644
--- a/app/src/org/gnucash/android/ui/settings/AccountPreferencesFragment.java
+++ b/app/src/org/gnucash/android/ui/settings/AccountPreferencesFragment.java
@@ -16,19 +16,15 @@
 
 package org.gnucash.android.ui.settings;
 
-import android.app.Activity;
-import android.content.Intent;
+import android.content.SharedPreferences;
 import android.os.Bundle;
 import android.preference.Preference;
 import android.preference.PreferenceFragment;
-import android.widget.Toast;
+import android.preference.PreferenceManager;
 import com.actionbarsherlock.app.ActionBar;
 import com.actionbarsherlock.app.SherlockPreferenceActivity;
 import org.gnucash.android.R;
-import org.gnucash.android.ui.accounts.AccountsListFragment;
-import org.gnucash.android.util.GnucashAccountXmlHandler;
-
-import java.io.FileNotFoundException;
+import org.gnucash.android.data.Money;
 
 /**
  * Account settings fragment inside the Settings activity
@@ -50,15 +46,14 @@ public void onCreate(Bundle savedInstanceState) {
     @Override
     public void onResume() {
         super.onResume();
+        SharedPreferences sharedPreferences = PreferenceManager.getDefaultSharedPreferences(getActivity());
+        String defaultCurrency = sharedPreferences.getString(getString(R.string.key_default_currency), Money.DEFAULT_CURRENCY_CODE);
+        Preference pref = findPreference(getString(R.string.key_default_currency));
+        pref.setSummary(defaultCurrency);
+        pref.setOnPreferenceChangeListener((SettingsActivity)getActivity());
 
         Preference preference = findPreference(getString(R.string.key_import_accounts));
-        preference.setOnPreferenceClickListener(new Preference.OnPreferenceClickListener() {
-            @Override
-            public boolean onPreferenceClick(Preference preference) {
-                importAccounts();
-                return true;
-            }
-        });
+        preference.setOnPreferenceClickListener((SettingsActivity)getActivity());
 
         preference = findPreference(getString(R.string.key_delete_all_accounts));
         preference.setOnPreferenceClickListener(new Preference.OnPreferenceClickListener() {
@@ -70,33 +65,4 @@ public boolean onPreferenceClick(Preference preference) {
             }
         });
     }
-
-    private void importAccounts() {
-        Intent pickIntent = new Intent(Intent.ACTION_GET_CONTENT);
-        pickIntent.setType("application/octet-stream");
-        Intent chooser = Intent.createChooser(pickIntent, "Select GnuCash account file");
-
-        startActivityForResult(chooser, AccountsListFragment.REQUEST_PICK_ACCOUNTS_FILE);
-
-    }
-
-    @Override
-    public void onActivityResult(int requestCode, int resultCode, Intent data) {
-        if (resultCode == Activity.RESULT_CANCELED){
-            return;
-        }
-
-        switch (requestCode){
-            case AccountsListFragment.REQUEST_PICK_ACCOUNTS_FILE:
-                try {
-                    GnucashAccountXmlHandler.parse(getActivity(), getActivity().getContentResolver().openInputStream(data.getData()));
-
-                    Toast.makeText(getActivity(), R.string.toast_success_importing_accounts, Toast.LENGTH_LONG).show();
-                } catch (FileNotFoundException e) {
-                    Toast.makeText(getActivity(), R.string.toast_error_importing_accounts, Toast.LENGTH_LONG).show();
-                    e.printStackTrace();
-                }
-                break;
-        }
-    }
 }
diff --git a/app/src/org/gnucash/android/ui/settings/GeneralPreferenceFragment.java b/app/src/org/gnucash/android/ui/settings/GeneralPreferenceFragment.java
index 271b76b8..238492d7 100644
--- a/app/src/org/gnucash/android/ui/settings/GeneralPreferenceFragment.java
+++ b/app/src/org/gnucash/android/ui/settings/GeneralPreferenceFragment.java
@@ -53,13 +53,9 @@ public void onCreate(Bundle savedInstanceState) {
 	public void onResume() {
 		super.onResume();
 		SharedPreferences manager = PreferenceManager.getDefaultSharedPreferences(getActivity());
-		String defaultCurrency = manager.getString(getString(R.string.key_default_currency), Money.DEFAULT_CURRENCY_CODE);
-		Preference pref = findPreference(getString(R.string.key_default_currency));
-		pref.setSummary(defaultCurrency);
-		pref.setOnPreferenceChangeListener(this);
 		
 		String keyDefaultEmail = getString(R.string.key_default_export_email);		
-		pref = findPreference(keyDefaultEmail);
+		Preference pref = findPreference(keyDefaultEmail);
 		String defaultEmail = manager.getString(keyDefaultEmail, null);
 		if (defaultEmail != null && !defaultEmail.trim().isEmpty()){
 			pref.setSummary(defaultEmail);			
diff --git a/app/src/org/gnucash/android/ui/settings/SettingsActivity.java b/app/src/org/gnucash/android/ui/settings/SettingsActivity.java
index 0a3ce315..dace4d9e 100644
--- a/app/src/org/gnucash/android/ui/settings/SettingsActivity.java
+++ b/app/src/org/gnucash/android/ui/settings/SettingsActivity.java
@@ -16,9 +16,12 @@
 
 package org.gnucash.android.ui.settings;
 
+import java.io.FileNotFoundException;
 import java.util.List;
 
+import android.app.Activity;
 import android.content.Intent;
+import android.widget.Toast;
 import org.gnucash.android.R;
 import org.gnucash.android.data.Money;
 
@@ -36,13 +39,14 @@
 import com.actionbarsherlock.app.SherlockPreferenceActivity;
 import com.actionbarsherlock.view.MenuItem;
 import org.gnucash.android.ui.accounts.AccountsListFragment;
+import org.gnucash.android.util.GnucashAccountXmlHandler;
 
 /**
  * Activity for displaying settings and information about the application
  * @author Ngewi Fet <ngewif@gmail.com>
  *
  */
-public class SettingsActivity extends SherlockPreferenceActivity implements OnPreferenceChangeListener{
+public class SettingsActivity extends SherlockPreferenceActivity implements OnPreferenceChangeListener, Preference.OnPreferenceClickListener{
 
 	/**
 	 * Constructs the headers to display in the header list when the Settings activity is first opened
@@ -78,7 +82,7 @@ protected void onCreate(Bundle savedInstanceState) {
 		
 		if (Build.VERSION.SDK_INT < Build.VERSION_CODES.HONEYCOMB){
 			addPreferencesFromResource(R.xml.fragment_general_preferences);
-//            addPreferencesFromResource(R.xml.fragment_account_preferences);
+            addPreferencesFromResource(R.xml.fragment_account_preferences);
 			addPreferencesFromResource(R.xml.fragment_transaction_preferences);
 			addPreferencesFromResource(R.xml.fragment_about_preferences);
 			setDefaultCurrencyListener();
@@ -87,6 +91,8 @@ protected void onCreate(Bundle savedInstanceState) {
 			Preference pref = findPreference(getString(R.string.key_build_version));
 			pref.setSummary(versionName);
 
+            pref = findPreference(getString(R.string.key_import_accounts));
+            pref.setOnPreferenceClickListener(this);
 		}
 	}
 		
@@ -129,4 +135,41 @@ private void setDefaultCurrencyListener() {
 		pref.setOnPreferenceChangeListener(this);
 	}
 
+    @Override
+    public boolean onPreferenceClick(Preference preference) {
+        if (preference.getKey().equals(getString(R.string.key_import_accounts))){
+            importAccounts();
+            return true;
+        }
+        return false;
+    }
+
+    public void importAccounts() {
+        Intent pickIntent = new Intent(Intent.ACTION_GET_CONTENT);
+        pickIntent.setType("application/octet-stream");
+        Intent chooser = Intent.createChooser(pickIntent, "Select GnuCash account file");
+
+        startActivityForResult(chooser, AccountsListFragment.REQUEST_PICK_ACCOUNTS_FILE);
+
+    }
+
+    @Override
+    public void onActivityResult(int requestCode, int resultCode, Intent data) {
+        if (resultCode == Activity.RESULT_CANCELED){
+            return;
+        }
+
+        switch (requestCode){
+            case AccountsListFragment.REQUEST_PICK_ACCOUNTS_FILE:
+                try {
+                    GnucashAccountXmlHandler.parse(this, getContentResolver().openInputStream(data.getData()));
+
+                    Toast.makeText(this, R.string.toast_success_importing_accounts, Toast.LENGTH_LONG).show();
+                } catch (FileNotFoundException e) {
+                    Toast.makeText(this, R.string.toast_error_importing_accounts, Toast.LENGTH_LONG).show();
+                    e.printStackTrace();
+                }
+                break;
+        }
+    }
 }
diff --git a/app/src/org/gnucash/android/ui/transactions/TransactionsActivity.java b/app/src/org/gnucash/android/ui/transactions/TransactionsActivity.java
index 2aeac829..3c027d2c 100644
--- a/app/src/org/gnucash/android/ui/transactions/TransactionsActivity.java
+++ b/app/src/org/gnucash/android/ui/transactions/TransactionsActivity.java
@@ -16,6 +16,7 @@
 
 package org.gnucash.android.ui.transactions;
 
+import android.support.v4.app.Fragment;
 import android.widget.TextView;
 import org.gnucash.android.R;
 import org.gnucash.android.data.Account;
@@ -66,9 +67,10 @@
 	/**
 	 * Tag for {@link NewTransactionFragment}
 	 */
-	public static final String FRAGMENT_NEW_TRANSACTION 	= "new_transaction";	
-	
-	/**
+	public static final String FRAGMENT_NEW_TRANSACTION 	= "new_transaction";
+    private static final int REQUEST_EDIT_ACCOUNT           = 0x21;
+
+    /**
 	 * Database ID of {@link Account} whose transactions are displayed 
 	 */
 	private long mAccountId 	= 0;
@@ -104,31 +106,36 @@ public boolean onNavigationItemSelected(int position, long itemId) {
 		    	return true;
 		    }
 
-			TransactionsListFragment transactionsListFragment = (TransactionsListFragment) fragmentManager
-					.findFragmentByTag(FRAGMENT_TRANSACTIONS_LIST);
-			if (transactionsListFragment != null) {
-				transactionsListFragment.refreshList(itemId);
-            }
-
-              AccountsListFragment subAccountsListFragment = (AccountsListFragment) fragmentManager
-                      .findFragmentByTag(AccountsActivity.FRAGMENT_ACCOUNTS_LIST);
-              if (subAccountsListFragment != null) {
-                  subAccountsListFragment.refreshList(itemId);
-              } else {
-                  subAccountsListFragment = new AccountsListFragment();
-                  Bundle args = new Bundle();
-                  args.putLong(AccountsListFragment.ARG_PARENT_ACCOUNT_ID, mAccountId);
-                  subAccountsListFragment.setArguments(args);
-                  FragmentTransaction fragmentTransaction = fragmentManager.beginTransaction();
-                  fragmentTransaction.replace(R.id.sub_accounts_container, subAccountsListFragment, AccountsActivity.FRAGMENT_ACCOUNTS_LIST);
-                  fragmentTransaction.commit();
-              }
+              refresh();
 
               return true;
 		  }
 	};
 
-	private AccountsDbAdapter mAccountsDbAdapter;
+    private void refresh() {
+        FragmentManager fragmentManager = getSupportFragmentManager();
+        TransactionsListFragment transactionsListFragment = (TransactionsListFragment) fragmentManager
+                .findFragmentByTag(FRAGMENT_TRANSACTIONS_LIST);
+        if (transactionsListFragment != null) {
+            transactionsListFragment.refreshList(mAccountId);
+        }
+
+        AccountsListFragment subAccountsListFragment = (AccountsListFragment) fragmentManager
+                .findFragmentByTag(AccountsActivity.FRAGMENT_ACCOUNTS_LIST);
+        if (subAccountsListFragment != null) {
+            subAccountsListFragment.refreshList(mAccountId);
+        } else {
+            subAccountsListFragment = new AccountsListFragment();
+            Bundle args = new Bundle();
+            args.putLong(AccountsListFragment.ARG_PARENT_ACCOUNT_ID, mAccountId);
+            subAccountsListFragment.setArguments(args);
+            FragmentTransaction fragmentTransaction = fragmentManager.beginTransaction();
+            fragmentTransaction.replace(R.id.sub_accounts_container, subAccountsListFragment, AccountsActivity.FRAGMENT_ACCOUNTS_LIST);
+            fragmentTransaction.commit();
+        }
+    }
+
+    private AccountsDbAdapter mAccountsDbAdapter;
 
 	private SpinnerAdapter mSpinnerAdapter;
 				
@@ -185,6 +192,7 @@ private void setupActionBarNavigation() {
 		actionBar.setNavigationMode(ActionBar.NAVIGATION_MODE_LIST);
 		actionBar.setListNavigationCallbacks(mSpinnerAdapter,
 				mTransactionListNavigationListener);
+        actionBar.setDisplayHomeAsUpEnabled(true);
 		
 		updateNavigationSelection();
 	}
@@ -217,15 +225,17 @@ public void updateSubAccountsView() {
         if (action != null && action.equals(Intent.ACTION_INSERT_OR_EDIT))
             return;
 
-        AccountsDbAdapter accountsDbAdapter = new AccountsDbAdapter(TransactionsActivity.this);
-        if (accountsDbAdapter.getSubAccountCount(mAccountId) > 0) {
-            mSectionHeaderSubAccounts.setVisibility(View.VISIBLE);
+        int subAccountCount = mAccountsDbAdapter.getSubAccountCount(mAccountId);
+        if (subAccountCount > 0) {
             mSubAccountsContainer.setVisibility(View.VISIBLE);
+            mSectionHeaderSubAccounts.setVisibility(View.VISIBLE);
+            String subAccountSectionText = getResources().getQuantityString(
+                    R.plurals.label_sub_accounts, subAccountCount, subAccountCount);
+            mSectionHeaderSubAccounts.setText(subAccountSectionText);
         } else {
             mSectionHeaderSubAccounts.setVisibility(View.GONE);
             mSubAccountsContainer.setVisibility(View.GONE);
         }
-        accountsDbAdapter.close();
     }
 
     @Override
@@ -246,12 +256,28 @@ public boolean onOptionsItemSelected(MenuItem item) {
 	        }
 	        return true;
 
-		default:
+            case R.id.menu_edit_account:
+                Intent editAccountIntent = new Intent(this, AccountsActivity.class);
+                editAccountIntent.setAction(Intent.ACTION_INSERT_OR_EDIT);
+                editAccountIntent.putExtra(TransactionsListFragment.SELECTED_ACCOUNT_ID, mAccountId);
+                startActivityForResult(editAccountIntent, REQUEST_EDIT_ACCOUNT);
+                return true;
+
+        default:
 			return false;
 		}
 	}
-		
-	@Override
+
+    @Override
+    protected void onActivityResult(int requestCode, int resultCode, Intent data) {
+        if (resultCode == RESULT_CANCELED)
+            return;
+
+        refresh();
+        setupActionBarNavigation();
+    }
+
+    @Override
 	protected void onDestroy() {
 		super.onDestroy();
 		mAccountsDbAdapter.close();
@@ -283,9 +309,12 @@ protected void showTransactionsList(){
         FragmentTransaction fragmentTransaction = fragmentManager
                 .beginTransaction();
 
-        if (mAccountsDbAdapter.getSubAccountCount(mAccountId) > 0){
+        int subAccountCount = mAccountsDbAdapter.getSubAccountCount(mAccountId);
+        if (subAccountCount > 0){
             mSubAccountsContainer.setVisibility(View.VISIBLE);
             mSectionHeaderSubAccounts.setVisibility(View.VISIBLE);
+            String subAccountSectionText = getResources().getQuantityString(R.plurals.label_sub_accounts, subAccountCount, subAccountCount);
+            mSectionHeaderSubAccounts.setText(subAccountSectionText);
             AccountsListFragment subAccountsListFragment = new AccountsListFragment();
             Bundle args = new Bundle();
             args.putLong(AccountsListFragment.ARG_PARENT_ACCOUNT_ID, mAccountId);

From 8fa10da9989fe9f09e749caf154c1470eba98379 Mon Sep 17 00:00:00 2001
From: Ngewi Fet <ngewif@gmail.com>
Date: Mon, 8 Apr 2013 00:07:00 +0200
Subject: [PATCH 08/10] Default string update

---
 app/res/values/strings.xml | 8 ++++----
 1 file changed, 4 insertions(+), 4 deletions(-)

diff --git a/app/res/values/strings.xml b/app/res/values/strings.xml
index 00dafc94..612fb1ee 100644
--- a/app/res/values/strings.xml
+++ b/app/res/values/strings.xml
@@ -534,7 +534,7 @@
     <string-array name="account_type_entry_values">
         <item>CASH</item>
         <item>BANK</item>
-        <item>CREDIT_CARD</item>
+        <item>CREDIT CARD</item>
         <item>ASSET</item>
         <item>LIABILITY</item>
         <item>INCOME</item>
@@ -544,12 +544,12 @@
         <item>EQUITY</item>
         <item>CURRENCY</item>
         <item>STOCK</item>
-        <item>MUTUAL_FUND</item>
+        <item>MUTUAL FUND</item>
     </string-array>
     <string-array name="account_type_entries">
         <item>CASH</item>
         <item>BANK</item>
-        <item>CREDIT CARD</item>
+        <item>CREDIT_CARD</item>
         <item>ASSET</item>
         <item>LIABILITY</item>
         <item>INCOME</item>
@@ -559,6 +559,6 @@
         <item>EQUITY</item>
         <item>CURRENCY</item>
         <item>STOCK</item>
-        <item>MUTUAL FUND</item>
+        <item>MUTUAL_FUND</item>
     </string-array>
 </resources>

From 513b875300a175bf9cd27c72510b9fc1f68d83ce Mon Sep 17 00:00:00 2001
From: Ngewi Fet <ngewif@gmail.com>
Date: Thu, 6 Jun 2013 00:23:21 +0200
Subject: [PATCH 09/10] Added setting to delete all transactions (HONEYCOMB and
 above) - fixes #77

---
 app/res/values-de/strings.xml                      |  3 ++
 app/res/values-el/strings.xml                      |  3 ++
 app/res/values-es-rMX/strings.xml                  |  3 ++
 app/res/values-es/strings.xml                      |  3 ++
 app/res/values-fr/strings.xml                      |  3 ++
 app/res/values-hu/strings.xml                      |  3 ++
 app/res/values-it/strings.xml                      |  3 ++
 app/res/values-nb/strings.xml                      |  3 ++
 app/res/values-nl/strings.xml                      |  3 ++
 app/res/values-pt-rBR/strings.xml                  |  3 ++
 app/res/values-ru/strings.xml                      |  3 ++
 app/res/values/strings.xml                         |  4 ++
 .../xml-v11/fragment_transaction_preferences.xml   | 30 +++++++++++++
 app/res/xml/fragment_transaction_preferences.xml   | 11 ++++-
 .../ui/settings/AccountPreferencesFragment.java    |  9 +++-
 ...va => DeleteAllAccountsConfirmationDialog.java} |  9 ++--
 .../DeleteAllTransacationsConfirmationDialog.java  | 52 ++++++++++++++++++++++
 .../android/ui/settings/SettingsActivity.java      | 24 ++++++----
 .../settings/TransactionsPreferenceFragment.java   | 27 ++++++++++-
 19 files changed, 181 insertions(+), 18 deletions(-)
 create mode 100644 app/res/xml-v11/fragment_transaction_preferences.xml
 rename app/src/org/gnucash/android/ui/settings/{DeleteAccountsConfirmationDialog.java => DeleteAllAccountsConfirmationDialog.java} (89%)
 create mode 100644 app/src/org/gnucash/android/ui/settings/DeleteAllTransacationsConfirmationDialog.java

diff --git a/app/res/values-de/strings.xml b/app/res/values-de/strings.xml
index a7c8503f..c0417470 100644
--- a/app/res/values-de/strings.xml
+++ b/app/res/values-de/strings.xml
@@ -332,6 +332,9 @@
         operation cannot be undone!
     </string>
     <string name="label_account_type">Account Type</string>
+    <string name="summary_delete_all_transactions">All transactions in all accounts will be deleted!</string>
+    <string name="title_delete_all_transactions">Delete all transactions</string>
+    <string name="toast_all_transactions_deleted">All transactions successfully deleted!</string>
     <plurals name="label_sub_accounts">
         <item quantity="one">%d Unterkonto</item>
         <item quantity="other">%d Unterkonten</item>
diff --git a/app/res/values-el/strings.xml b/app/res/values-el/strings.xml
index f713c79f..9d446555 100644
--- a/app/res/values-el/strings.xml
+++ b/app/res/values-el/strings.xml
@@ -338,6 +338,9 @@
         operation cannot be undone!
     </string>
     <string name="label_account_type">Account Type</string>
+    <string name="summary_delete_all_transactions">All transactions in all accounts will be deleted!</string>
+    <string name="title_delete_all_transactions">Delete all transactions</string>
+    <string name="toast_all_transactions_deleted">All transactions successfully deleted!</string>
     <plurals name="label_sub_accounts">
         <item quantity="one">%d sub-account</item>
         <item quantity="other">%d sub-accounts</item>
diff --git a/app/res/values-es-rMX/strings.xml b/app/res/values-es-rMX/strings.xml
index faf23002..3a75725d 100644
--- a/app/res/values-es-rMX/strings.xml
+++ b/app/res/values-es-rMX/strings.xml
@@ -331,6 +331,9 @@
         operation cannot be undone!
     </string>
     <string name="label_account_type">Account Type</string>
+    <string name="summary_delete_all_transactions">All transactions in all accounts will be deleted!</string>
+    <string name="title_delete_all_transactions">Delete all transactions</string>
+    <string name="toast_all_transactions_deleted">All transactions successfully deleted!</string>
     <plurals name="label_sub_accounts">
         <item quantity="one">%d sub-account</item>
         <item quantity="other">%d sub-accounts</item>
diff --git a/app/res/values-es/strings.xml b/app/res/values-es/strings.xml
index 731f7b6b..e5fa5777 100644
--- a/app/res/values-es/strings.xml
+++ b/app/res/values-es/strings.xml
@@ -332,6 +332,9 @@
         operation cannot be undone!
     </string>
     <string name="label_account_type">Account Type</string>
+    <string name="summary_delete_all_transactions">All transactions in all accounts will be deleted!</string>
+    <string name="title_delete_all_transactions">Delete all transactions</string>
+    <string name="toast_all_transactions_deleted">All transactions successfully deleted!</string>
     <plurals name="label_sub_accounts">
         <item quantity="one">%d sub-account</item>
         <item quantity="other">%d sub-accounts</item>
diff --git a/app/res/values-fr/strings.xml b/app/res/values-fr/strings.xml
index 39cd3184..2203560f 100644
--- a/app/res/values-fr/strings.xml
+++ b/app/res/values-fr/strings.xml
@@ -332,6 +332,9 @@
         operation cannot be undone!
     </string>
     <string name="label_account_type">Account Type</string>
+    <string name="summary_delete_all_transactions">All transactions in all accounts will be deleted!</string>
+    <string name="title_delete_all_transactions">Delete all transactions</string>
+    <string name="toast_all_transactions_deleted">All transactions successfully deleted!</string>
     <plurals name="label_sub_accounts">
         <item quantity="one">%d sub-account</item>
         <item quantity="other">%d sub-accounts</item>
diff --git a/app/res/values-hu/strings.xml b/app/res/values-hu/strings.xml
index 7b824074..37169b0e 100644
--- a/app/res/values-hu/strings.xml
+++ b/app/res/values-hu/strings.xml
@@ -331,6 +331,9 @@
         operation cannot be undone!
     </string>
     <string name="label_account_type">Account Type</string>
+    <string name="summary_delete_all_transactions">All transactions in all accounts will be deleted!</string>
+    <string name="title_delete_all_transactions">Delete all transactions</string>
+    <string name="toast_all_transactions_deleted">All transactions successfully deleted!</string>
     <plurals name="label_sub_accounts">
         <item quantity="one">%d sub-account</item>
         <item quantity="other">%d sub-accounts</item>
diff --git a/app/res/values-it/strings.xml b/app/res/values-it/strings.xml
index e76e21d9..072104e0 100644
--- a/app/res/values-it/strings.xml
+++ b/app/res/values-it/strings.xml
@@ -332,6 +332,9 @@
         operation cannot be undone!
     </string>
     <string name="label_account_type">Account Type</string>
+    <string name="summary_delete_all_transactions">All transactions in all accounts will be deleted!</string>
+    <string name="title_delete_all_transactions">Delete all transactions</string>
+    <string name="toast_all_transactions_deleted">All transactions successfully deleted!</string>
     <plurals name="label_sub_accounts">
         <item quantity="one">%d sub-account</item>
         <item quantity="other">%d sub-accounts</item>
diff --git a/app/res/values-nb/strings.xml b/app/res/values-nb/strings.xml
index 3b51296c..d0323f29 100644
--- a/app/res/values-nb/strings.xml
+++ b/app/res/values-nb/strings.xml
@@ -335,6 +335,9 @@ format og importeres i regnskapsprogrammet GnuCash for PC.</string>
         operation cannot be undone!
     </string>
     <string name="label_account_type">Account Type</string>
+    <string name="summary_delete_all_transactions">All transactions in all accounts will be deleted!</string>
+    <string name="title_delete_all_transactions">Delete all transactions</string>
+    <string name="toast_all_transactions_deleted">All transactions successfully deleted!</string>
     <plurals name="label_sub_accounts">
         <item quantity="one">%d sub-account</item>
         <item quantity="other">%d sub-accounts</item>
diff --git a/app/res/values-nl/strings.xml b/app/res/values-nl/strings.xml
index 42c4ed26..100ee7bb 100644
--- a/app/res/values-nl/strings.xml
+++ b/app/res/values-nl/strings.xml
@@ -332,6 +332,9 @@
         operation cannot be undone!
     </string>
     <string name="label_account_type">Account Type</string>
+    <string name="summary_delete_all_transactions">All transactions in all accounts will be deleted!</string>
+    <string name="title_delete_all_transactions">Delete all transactions</string>
+    <string name="toast_all_transactions_deleted">All transactions successfully deleted!</string>
     <plurals name="label_sub_accounts">
         <item quantity="one">%d sub-account</item>
         <item quantity="other">%d sub-accounts</item>
diff --git a/app/res/values-pt-rBR/strings.xml b/app/res/values-pt-rBR/strings.xml
index f34c7515..79d9fa69 100644
--- a/app/res/values-pt-rBR/strings.xml
+++ b/app/res/values-pt-rBR/strings.xml
@@ -331,6 +331,9 @@
         operation cannot be undone!
     </string>
     <string name="label_account_type">Account Type</string>
+    <string name="summary_delete_all_transactions">All transactions in all accounts will be deleted!</string>
+    <string name="title_delete_all_transactions">Delete all transactions</string>
+    <string name="toast_all_transactions_deleted">All transactions successfully deleted!</string>
     <plurals name="label_sub_accounts">
         <item quantity="one">%d sub-account</item>
         <item quantity="other">%d sub-accounts</item>
diff --git a/app/res/values-ru/strings.xml b/app/res/values-ru/strings.xml
index d3d78c8e..32fcc1a8 100644
--- a/app/res/values-ru/strings.xml
+++ b/app/res/values-ru/strings.xml
@@ -332,6 +332,9 @@
         operation cannot be undone!
     </string>
     <string name="label_account_type">Account Type</string>
+    <string name="summary_delete_all_transactions">All transactions in all accounts will be deleted!</string>
+    <string name="title_delete_all_transactions">Delete all transactions</string>
+    <string name="toast_all_transactions_deleted">All transactions successfully deleted!</string>
     <plurals name="label_sub_accounts">
         <item quantity="one">%d sub-account</item>
         <item quantity="other">%d sub-accounts</item>
diff --git a/app/res/values/strings.xml b/app/res/values/strings.xml
index 612fb1ee..9bcc6c87 100644
--- a/app/res/values/strings.xml
+++ b/app/res/values/strings.xml
@@ -527,6 +527,10 @@
         operation cannot be undone!
     </string>
     <string name="label_account_type">Account Type</string>
+    <string name="key_delete_all_transactions">delete_all_transactions</string>
+    <string name="summary_delete_all_transactions">All transactions in all accounts will be deleted!</string>
+    <string name="title_delete_all_transactions">Delete all transactions</string>
+    <string name="toast_all_transactions_deleted">All transactions successfully deleted!</string>
     <plurals name="label_sub_accounts">
         <item quantity="one">%d sub-account</item>
         <item quantity="other">%d sub-accounts</item>
diff --git a/app/res/xml-v11/fragment_transaction_preferences.xml b/app/res/xml-v11/fragment_transaction_preferences.xml
new file mode 100644
index 00000000..3f8fe10d
--- /dev/null
+++ b/app/res/xml-v11/fragment_transaction_preferences.xml
@@ -0,0 +1,30 @@
+<?xml version="1.0" encoding="utf-8"?>
+<!--
+ Copyright (c) 2012 Ngewi Fet <ngewif@gmail.com>
+ 
+ Licensed under the Apache License, Version 2.0 (the "License");
+ you may not use this file except in compliance with the License.
+ You may obtain a copy of the License at
+ 
+    http://www.apache.org/licenses/LICENSE-2.0
+ 
+ Unless required by applicable law or agreed to in writing, software
+ distributed under the License is distributed on an "AS IS" BASIS,
+ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ See the License for the specific language governing permissions and
+ limitations under the License.
+-->
+<PreferenceScreen xmlns:android="http://schemas.android.com/apk/res/android">
+    <ListPreference android:title="@string/title_default_transaction_type"
+                    android:entryValues="@array/key_transaction_type_values"
+                    android:entries="@array/transaction_types"
+                    android:key="@string/key_default_transaction_type"
+                    android:summary="@string/summary_default_transaction_type"/>
+
+    <CheckBoxPreference android:summary="@string/summary_use_double_entry"
+                        android:key="@string/key_use_double_entry"
+                        android:title="@string/title_use_double_entry"/>
+    <Preference android:key="@string/key_delete_all_transactions"
+                android:summary="@string/summary_delete_all_transactions"
+                android:title="@string/title_delete_all_transactions" />
+</PreferenceScreen>
diff --git a/app/res/xml/fragment_transaction_preferences.xml b/app/res/xml/fragment_transaction_preferences.xml
index 67d44711..de2e357e 100644
--- a/app/res/xml/fragment_transaction_preferences.xml
+++ b/app/res/xml/fragment_transaction_preferences.xml
@@ -15,6 +15,13 @@
  limitations under the License.
 -->
 <PreferenceScreen xmlns:android="http://schemas.android.com/apk/res/android">
-    <ListPreference android:title="@string/title_default_transaction_type" android:entryValues="@array/key_transaction_type_values" android:entries="@array/transaction_types" android:key="@string/key_default_transaction_type" android:summary="@string/summary_default_transaction_type"/>
-    <CheckBoxPreference android:summary="@string/summary_use_double_entry" android:key="@string/key_use_double_entry" android:title="@string/title_use_double_entry"/>
+    <PreferenceCategory android:title="@string/title_transaction_preferences"/> <!-- needed for pre-Honeycomb devices -->
+    <ListPreference android:title="@string/title_default_transaction_type"
+                    android:entryValues="@array/key_transaction_type_values"
+                    android:entries="@array/transaction_types"
+                    android:key="@string/key_default_transaction_type"
+                    android:summary="@string/summary_default_transaction_type"/>
+    <CheckBoxPreference android:summary="@string/summary_use_double_entry"
+                        android:key="@string/key_use_double_entry"
+                        android:title="@string/title_use_double_entry"/>
 </PreferenceScreen>
diff --git a/app/src/org/gnucash/android/ui/settings/AccountPreferencesFragment.java b/app/src/org/gnucash/android/ui/settings/AccountPreferencesFragment.java
index c01b70e0..c198ee3e 100644
--- a/app/src/org/gnucash/android/ui/settings/AccountPreferencesFragment.java
+++ b/app/src/org/gnucash/android/ui/settings/AccountPreferencesFragment.java
@@ -59,10 +59,15 @@ public void onResume() {
         preference.setOnPreferenceClickListener(new Preference.OnPreferenceClickListener() {
             @Override
             public boolean onPreferenceClick(Preference preference) {
-                DeleteAccountsConfirmationDialog deleteConfirmationDialog = DeleteAccountsConfirmationDialog.newInstance();
-                deleteConfirmationDialog.show(getFragmentManager(), "account_settings");
+                deleteAllAccounts();
                 return true;
             }
         });
     }
+
+    public void deleteAllAccounts(){
+        DeleteAllAccountsConfirmationDialog deleteConfirmationDialog = DeleteAllAccountsConfirmationDialog.newInstance();
+        deleteConfirmationDialog.show(getFragmentManager(), "account_settings");
+
+    }
 }
diff --git a/app/src/org/gnucash/android/ui/settings/DeleteAccountsConfirmationDialog.java b/app/src/org/gnucash/android/ui/settings/DeleteAllAccountsConfirmationDialog.java
similarity index 89%
rename from app/src/org/gnucash/android/ui/settings/DeleteAccountsConfirmationDialog.java
rename to app/src/org/gnucash/android/ui/settings/DeleteAllAccountsConfirmationDialog.java
index 8278f30f..6df857e4 100644
--- a/app/src/org/gnucash/android/ui/settings/DeleteAccountsConfirmationDialog.java
+++ b/app/src/org/gnucash/android/ui/settings/DeleteAllAccountsConfirmationDialog.java
@@ -27,14 +27,15 @@
 import org.gnucash.android.db.AccountsDbAdapter;
 
 /**
- * Confirmation dialog for deleting all accounts from the system
+ * Confirmation dialog for deleting all accounts from the system.
+ * This class currently only works with HONEYCOMB and above.
  *
  * @author Ngewi Fet <ngewif@gmail.com>
  */
-public class DeleteAccountsConfirmationDialog extends DialogFragment {
+public class DeleteAllAccountsConfirmationDialog extends DialogFragment {
 
-    public static DeleteAccountsConfirmationDialog newInstance() {
-        DeleteAccountsConfirmationDialog frag = new DeleteAccountsConfirmationDialog();
+    public static DeleteAllAccountsConfirmationDialog newInstance() {
+        DeleteAllAccountsConfirmationDialog frag = new DeleteAllAccountsConfirmationDialog();
         return frag;
     }
 
diff --git a/app/src/org/gnucash/android/ui/settings/DeleteAllTransacationsConfirmationDialog.java b/app/src/org/gnucash/android/ui/settings/DeleteAllTransacationsConfirmationDialog.java
new file mode 100644
index 00000000..4f148da2
--- /dev/null
+++ b/app/src/org/gnucash/android/ui/settings/DeleteAllTransacationsConfirmationDialog.java
@@ -0,0 +1,52 @@
+package org.gnucash.android.ui.settings;
+
+import android.app.AlertDialog;
+import android.app.Dialog;
+import android.app.DialogFragment;
+import android.content.Context;
+import android.content.DialogInterface;
+import android.os.Bundle;
+import android.widget.Toast;
+import org.gnucash.android.R;
+import org.gnucash.android.db.TransactionsDbAdapter;
+
+/**
+ * Copyright (c) 2013 - gnucash-android
+ *
+ * Confirmation dialog for deleting all transactions
+ * @author ngewif <ngewif@gmail.com>
+ */
+public class DeleteAllTransacationsConfirmationDialog extends DialogFragment {
+
+    public static DeleteAllTransacationsConfirmationDialog newInstance() {
+        DeleteAllTransacationsConfirmationDialog frag = new DeleteAllTransacationsConfirmationDialog();
+        return frag;
+    }
+
+    @Override
+    public Dialog onCreateDialog(Bundle savedInstanceState) {
+        return new AlertDialog.Builder(getActivity())
+                .setIcon(android.R.drawable.ic_delete)
+                .setTitle(R.string.title_confirm_delete).setMessage(R.string.delete_all_transactions_confirmation_message)
+                .setPositiveButton(R.string.alert_dialog_ok_delete,
+                        new DialogInterface.OnClickListener() {
+                            public void onClick(DialogInterface dialog, int whichButton) {
+                                Context context = getDialog().getContext();
+                                TransactionsDbAdapter transactionsDbAdapter = new TransactionsDbAdapter(context);
+                                transactionsDbAdapter.deleteAllRecords();
+                                transactionsDbAdapter.close();
+                                Toast.makeText(context, R.string.toast_all_transactions_deleted, Toast.LENGTH_SHORT).show();
+
+                            }
+                        }
+                )
+                .setNegativeButton(R.string.alert_dialog_cancel,
+                        new DialogInterface.OnClickListener() {
+                            public void onClick(DialogInterface dialog, int whichButton) {
+                                dismiss();
+                            }
+                        }
+                )
+                .create();
+    }
+}
diff --git a/app/src/org/gnucash/android/ui/settings/SettingsActivity.java b/app/src/org/gnucash/android/ui/settings/SettingsActivity.java
index dace4d9e..d35be2ff 100644
--- a/app/src/org/gnucash/android/ui/settings/SettingsActivity.java
+++ b/app/src/org/gnucash/android/ui/settings/SettingsActivity.java
@@ -16,15 +16,8 @@
 
 package org.gnucash.android.ui.settings;
 
-import java.io.FileNotFoundException;
-import java.util.List;
-
 import android.app.Activity;
 import android.content.Intent;
-import android.widget.Toast;
-import org.gnucash.android.R;
-import org.gnucash.android.data.Money;
-
 import android.content.SharedPreferences;
 import android.content.SharedPreferences.Editor;
 import android.content.pm.PackageManager.NameNotFoundException;
@@ -34,13 +27,18 @@
 import android.preference.Preference.OnPreferenceChangeListener;
 import android.preference.PreferenceManager;
 import android.util.Log;
-
+import android.widget.Toast;
 import com.actionbarsherlock.app.ActionBar;
 import com.actionbarsherlock.app.SherlockPreferenceActivity;
 import com.actionbarsherlock.view.MenuItem;
+import org.gnucash.android.R;
+import org.gnucash.android.data.Money;
 import org.gnucash.android.ui.accounts.AccountsListFragment;
 import org.gnucash.android.util.GnucashAccountXmlHandler;
 
+import java.io.FileNotFoundException;
+import java.util.List;
+
 /**
  * Activity for displaying settings and information about the application
  * @author Ngewi Fet <ngewif@gmail.com>
@@ -93,6 +91,12 @@ protected void onCreate(Bundle savedInstanceState) {
 
             pref = findPreference(getString(R.string.key_import_accounts));
             pref.setOnPreferenceClickListener(this);
+
+            pref = findPreference(getString(R.string.key_delete_all_transactions));
+            pref.setOnPreferenceClickListener(this);
+
+            pref = findPreference(getString(R.string.key_delete_all_accounts));
+            pref.setOnPreferenceClickListener(this);
 		}
 	}
 		
@@ -137,10 +141,12 @@ private void setDefaultCurrencyListener() {
 
     @Override
     public boolean onPreferenceClick(Preference preference) {
-        if (preference.getKey().equals(getString(R.string.key_import_accounts))){
+        String key = preference.getKey();
+        if (key.equals(getString(R.string.key_import_accounts))){
             importAccounts();
             return true;
         }
+
         return false;
     }
 
diff --git a/app/src/org/gnucash/android/ui/settings/TransactionsPreferenceFragment.java b/app/src/org/gnucash/android/ui/settings/TransactionsPreferenceFragment.java
index fa5b58e0..39087cf5 100644
--- a/app/src/org/gnucash/android/ui/settings/TransactionsPreferenceFragment.java
+++ b/app/src/org/gnucash/android/ui/settings/TransactionsPreferenceFragment.java
@@ -16,6 +16,7 @@
 
 package org.gnucash.android.ui.settings;
 
+import com.actionbarsherlock.app.SherlockFragmentActivity;
 import org.gnucash.android.R;
 
 import android.content.SharedPreferences;
@@ -27,6 +28,7 @@
 
 import com.actionbarsherlock.app.ActionBar;
 import com.actionbarsherlock.app.SherlockPreferenceActivity;
+import org.gnucash.android.ui.transactions.TransactionsDeleteConfirmationDialog;
 
 /**
  * Fragment for displaying transaction preferences
@@ -56,6 +58,15 @@ public void onResume() {
 		Preference pref = findPreference(getString(R.string.key_default_transaction_type));		
 		setLocalizedSummary(pref, defaultTransactionType);
 		pref.setOnPreferenceChangeListener(this);
+
+        Preference preference = findPreference(getString(R.string.key_delete_all_transactions));
+        preference.setOnPreferenceClickListener(new Preference.OnPreferenceClickListener() {
+            @Override
+            public boolean onPreferenceClick(Preference preference) {
+                deleteAllTransactions();
+                return true;
+            }
+        });
 	}
 
 
@@ -64,7 +75,21 @@ public boolean onPreferenceChange(Preference preference, Object newValue) {
 		setLocalizedSummary(preference, newValue.toString());
 		return true;
 	}
-	
+
+    /**
+     * Deletes all transactions in the system
+     */
+    public void deleteAllTransactions(){
+        DeleteAllTransacationsConfirmationDialog deleteTransactionsConfirmationDialog =
+                DeleteAllTransacationsConfirmationDialog.newInstance();
+        deleteTransactionsConfirmationDialog.show(getFragmentManager(), "transaction_settings");
+    }
+
+    /**
+     * Localizes the label for DEBIT/CREDIT in the settings summary
+     * @param preference Preference whose summary is to be localized
+     * @param value New value for the preference summary
+     */
 	private void setLocalizedSummary(Preference preference, String value){
 		String localizedLabel = value.equals("DEBIT") ? getString(R.string.label_debit) : getActivity().getString(R.string.label_credit);
 		Preference pref = findPreference(getString(R.string.key_default_transaction_type));

From 447f2066135875d036269ea943e51e119aaf03f6 Mon Sep 17 00:00:00 2001
From: Ngewi Fet <ngewif@gmail.com>
Date: Wed, 12 Jun 2013 21:48:07 +0200
Subject: [PATCH 10/10] Bumped version to 1.2.0 Updated changelog Fixed error
 displaying fragment for editing nested accounts

---
 CHANGELOG.md                                       |  9 ++++++++
 app/AndroidManifest.xml                            |  2 +-
 app/pom.xml                                        |  2 +-
 .../android/ui/accounts/AccountsListFragment.java  | 24 ++++++++++++++++++++--
 .../ui/transactions/TransactionsActivity.java      |  4 ++--
 integration-tests/AndroidManifest.xml              |  2 +-
 integration-tests/pom.xml                          |  2 +-
 pom.xml                                            |  2 +-
 8 files changed, 38 insertions(+), 9 deletions(-)

diff --git a/CHANGELOG.md b/CHANGELOG.md
index 0a1060ab..abd70228 100644
--- a/CHANGELOG.md
+++ b/CHANGELOG.md
@@ -1,5 +1,14 @@
 Change Log
 ===============================================================================
+Version 1.2.0 *(2013-06-20)*
+----------------------------
+* Feature: Import GnuCash desktop account structure
+* Feature: Nested display of account hierarchy
+* Feature: Options for deleting all accounts/transactions
+* Feature: Preliminary support for account types
+* Fixed:   Account balance now takes sub-accounts into consideration
+* Fixed:   Support for GnuCash ROOT account (will not be displayed)
+
 Version 1.1.2 *(2013-02-03)*
 ----------------------------
 * Fixed: Crash upon screen rotation when creating account
diff --git a/app/AndroidManifest.xml b/app/AndroidManifest.xml
index 27295973..6afd3226 100644
--- a/app/AndroidManifest.xml
+++ b/app/AndroidManifest.xml
@@ -18,7 +18,7 @@
 <manifest xmlns:android="http://schemas.android.com/apk/res/android"
     package="org.gnucash.android"
     android:versionCode="7"
-    android:versionName="1.1.2" >
+    android:versionName="1.2.0" >
 
     <uses-sdk android:minSdkVersion="8" android:targetSdkVersion="15"/>
     
diff --git a/app/pom.xml b/app/pom.xml
index a021c172..358b927d 100644
--- a/app/pom.xml
+++ b/app/pom.xml
@@ -22,7 +22,7 @@
     <description>Gnucash Android companion application</description>
 
     <parent>
-        <version>1.1.3-SNAPSHOT</version>
+        <version>1.2.0-SNAPSHOT</version>
         <groupId>org.gnucash.android</groupId>
         <artifactId>gnucash-android-parent</artifactId>
     </parent>
diff --git a/app/src/org/gnucash/android/ui/accounts/AccountsListFragment.java b/app/src/org/gnucash/android/ui/accounts/AccountsListFragment.java
index 2f9be01c..062a31c7 100644
--- a/app/src/org/gnucash/android/ui/accounts/AccountsListFragment.java
+++ b/app/src/org/gnucash/android/ui/accounts/AccountsListFragment.java
@@ -23,7 +23,6 @@
 import android.content.DialogInterface;
 import android.content.Intent;
 import android.database.Cursor;
-import android.os.Build;
 import android.os.Bundle;
 import android.support.v4.app.DialogFragment;
 import android.support.v4.app.Fragment;
@@ -76,6 +75,7 @@
      * Logging tag
      */
     protected static final String TAG = "AccountsListFragment";
+    private static final int REQUEST_EDIT_ACCOUNT = 0x10;
 
     /**
      * {@link ListAdapter} for the accounts which will be bound to the list
@@ -133,7 +133,7 @@ public boolean onPrepareActionMode(ActionMode mode, Menu menu) {
         public boolean onActionItemClicked(ActionMode mode, MenuItem item) {
             switch (item.getItemId()) {
                 case R.id.context_menu_edit_accounts:
-                    showAddAccountFragment(mSelectedItemId);
+                    openCreateOrEditActivity(mSelectedItemId);
                     mode.finish();
                     return true;
 
@@ -235,6 +235,14 @@ public boolean onItemLongClick(AdapterView<?> parent, View view, int position,
         return true;
     }
 
+    @Override
+    public void onActivityResult(int requestCode, int resultCode, Intent data) {
+        if (resultCode == Activity.RESULT_CANCELED)
+            return;
+
+        refreshList();
+    }
+
     /**
      * Returns true if this fragment is currently rendering sub-accounts. false otherwise
      * @return true if this fragment is currently rendering sub-accounts. false otherwise
@@ -421,6 +429,18 @@ public void showAddAccountFragment(long accountId) {
     }
 
     /**
+     * Opens a new activity for creating or editing an account.
+     * If the <code>accountId</code> &lt; 1, then create else edit the account.
+     * @param accountId Long record ID of account to be edited. Pass 0 to create a new account.
+     */
+    public void openCreateOrEditActivity(long accountId){
+        Intent editAccountIntent = new Intent(AccountsListFragment.this.getActivity(), AccountsActivity.class);
+        editAccountIntent.setAction(Intent.ACTION_INSERT_OR_EDIT);
+        editAccountIntent.putExtra(TransactionsListFragment.SELECTED_ACCOUNT_ID, accountId);
+        startActivityForResult(editAccountIntent, REQUEST_EDIT_ACCOUNT);
+    }
+
+    /**
      * Displays the dialog for exporting transactions in OFX
      */
     public void showExportDialog() {
diff --git a/app/src/org/gnucash/android/ui/transactions/TransactionsActivity.java b/app/src/org/gnucash/android/ui/transactions/TransactionsActivity.java
index 3c027d2c..b4e9d7a7 100644
--- a/app/src/org/gnucash/android/ui/transactions/TransactionsActivity.java
+++ b/app/src/org/gnucash/android/ui/transactions/TransactionsActivity.java
@@ -106,9 +106,9 @@ public boolean onNavigationItemSelected(int position, long itemId) {
 		    	return true;
 		    }
 
-              refresh();
+            refresh();
 
-              return true;
+            return true;
 		  }
 	};
 
diff --git a/integration-tests/AndroidManifest.xml b/integration-tests/AndroidManifest.xml
index b662f67d..0a3d1e68 100644
--- a/integration-tests/AndroidManifest.xml
+++ b/integration-tests/AndroidManifest.xml
@@ -2,7 +2,7 @@
 <manifest xmlns:android="http://schemas.android.com/apk/res/android"
     package="org.gnucash.android.test"
     android:versionCode="3"
-    android:versionName="1.1.2" >
+    android:versionName="1.2.0" >
 
     <uses-sdk android:minSdkVersion="8" android:targetSdkVersion="15" />
 
diff --git a/integration-tests/pom.xml b/integration-tests/pom.xml
index 6e7c96c0..3b6cb4c6 100644
--- a/integration-tests/pom.xml
+++ b/integration-tests/pom.xml
@@ -17,7 +17,7 @@
 <project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/maven-v4_0_0.xsd">
     <modelVersion>4.0.0</modelVersion>
     <parent>
-		<version>1.1.3-SNAPSHOT</version>
+		<version>1.2.0-SNAPSHOT</version>
 		<groupId>org.gnucash.android</groupId>
 		<artifactId>gnucash-android-parent</artifactId>
 	</parent>
diff --git a/pom.xml b/pom.xml
index 801e80cf..7bd70c8a 100644
--- a/pom.xml
+++ b/pom.xml
@@ -17,7 +17,7 @@
 
 <project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/maven-v4_0_0.xsd">
     <modelVersion>4.0.0</modelVersion>
-	<version>1.1.3-SNAPSHOT</version>
+	<version>1.2.0-SNAPSHOT</version>
     <groupId>org.gnucash.android</groupId>
     <artifactId>gnucash-android-parent</artifactId>
     <name>GnuCash Android parent</name>
